# 2026-01-13

## Envoy

### 요청의 생명주기

#### 요청 흐름

##### 개요

앞의 예시 구성을 사용하는 요청과 응답의 수명주기의 간략한 정리는 다음과 같다:

1. [워커 스레드][arch-introduction-threading-model]에서 실행중인 Envoy [리스너][arch-listeners-listeners]가 다운스트림으로부터 TCP 커넥션 하나를 수락한다.
2. [리스너 필터][arch-listeners-listener-filters] 체인이 생성되고 실행된다. SNI와 그 외 사전 TLS 정보를 제공할 수 있다. 완료되면 리스너는 네트워크 필터 체인에 일치시킨다. 각 리스너는 목적지 IP CIDR 범위, SNI, ALPN, 소스 포트 등의 조합과 일치하는 여러 필터 체인을 가질 수 있다. 전송 소켓은, 우리의 경우에 TLS 전송 소켓은 이 필터 체인과 연관된다.
3. 네트워크 읽기에서 [TLS][arch-security-tls] 전송 소켓이 TCP 커넥션에서 읽은 데이터를 복호화해 이후 처리를 위해 복호화된 데이터 스트림으로 보낸다.
4. [네트워크 필터][arch-listeners-listener-filters-network-filters] 체인이 생성되고 실행된다. HTTP에 가장 중요한 필터는 체인의 마지막 네트워크 필터인 HTTP 커넥션 관리자다.
5. [HTTP 커넥션 관리자][arch-http-http-connection-management]의 HTTP/2 코덱이 TLS 커넥션의 복호화된 데이터 스트림으로부터 몇 개의 독립된 스트림으로 프레임을 제거하고 멀티플렉스를 제거한다. 각 스트림은 하나의 요청과 응답을 처리한다.
6. 각 HTTP 스트림의 경우, [다운스트림 HTTP 필터][arch-http-http-filters] 체인이 생성되고 실행된다. 요청은 먼저 요청을 읽고 변형할 수 있는 CustomFilter를 통과한다. 가장 중요한 HTTP 필터는 HTTP 필터 체인의 끝에 있는 라우터 필터다. 라우터 필터에서 `decodeHeaders`가 호출되면 라우트와 클러스터가 선택된다. 스트림의 요청 헤더는 해당 클러스터의 업스트림 엔드포인트로 포워드된다. [라우터][arch-http-http-routing] 필터는 일치하는 클러스터에 이를 수행하기 위해 클러스터 관리자로부터 HTTP [커넥션 풀][arch-upstream-clusters-connection-pooling]을 얻는다.
7. 클러스터 특화 [로드 밸런싱][arch-upstream-clusters-load-balancing]이 수행돼 엔드포인트를 찾는다. 클러스터의 서킷 브레이커를 검사해 새 스트림이 허용되는지 결정한다. 엔드포인트의 커넥션 풀이 비어있거나 용량이 부족하면 엔드포인트로의 새 커넥션이 만들어진다.
8. 각 스트림에 [업스트림 HTTP 필터][arch-http-http-filters] 체인이 생성되고 실행된다. 기본적으로 적절한 코덱으로 데이터를 보내는 CodecFilter만 포함하지만 클러스터가 업스트림 HTTP 필터 체인으로 구성된 경우 각 스트림에 해당 필터 체인이 생성되고 실행되며 여기에는 재시도와 섀도우된 요청을 위한 별도의 필터를 생성하고 실행하는 것이 포함된다.
9. 업스트림 엔드포인트 커넥션의 HTTP/2 코덱이 하나의 TCP 커넥션을 통해 해당 업스트림으로 가는 다른 스트림들과 함께 요청의 스트림을 멀티플렉스하고 프레임을 생성한다.
10. 업스트림 엔드포인트 커넥션의 TLS 전송 소켓이 바이트를 암호화하고 이를 업스트림 커넥션을 위한 TCP 소켓에 쓴다.
11. 헤더와 선택적으로 본문 및 트레일러로 구성된 요청이 업스트림으로 프록시되고 응답이 다운스트림으로 프록시된다. 응답은 요청과는 [반대 순서][arch-http-http-filters-filter-ordering]로 필터를 통과한다. 다운스트림으로 보내지기 전에 코덱 필터에서 시작해 업스트림 HTTP 필터를 지나 라우터 필터와 CustomFilter를 통과한다.
12. 독립된 반-닫힘(half-close)이 활성화된 경우 요청과 응답이 완료(양 방향에서 HTTP/2 스트림에 END_STREAM이 관측)되면 스트림이 소멸되**며** 응답은 성공(2xx) 상태 코드를 갖는다. 그 외에는 요청이 완료되지 않은 경우라도 응답이 완료되면 스트림이 소멸한다. 요청 후 처리가 통계를 갱신하고 액세스 로그에 쓰고 트레이스 스팬을 마무리한다.

[arch-introduction-threading-model]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/intro/threading_model#arch-overview-threading
[arch-listeners-listeners]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listeners#arch-overview-listeners
[arch-listeners-listener-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listener_filters#arch-overview-listener-filters
[arch-security-tls]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/security/ssl#arch-overview-ssl
[arch-listeners-listener-filters-network-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listener_filters#arch-overview-network-filters
[arch-http-http-connection-management]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_connection_management#arch-overview-http-conn-man
[arch-http-http-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_filters#arch-overview-http-filters
[arch-http-http-routing]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_routing#arch-overview-http-routing
[arch-upstream-clusters-connection-pooling]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/connection_pooling#arch-overview-conn-pool
[arch-upstream-clusters-load-balancing]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overview#arch-overview-load-balancing
[arch-http-http-filters-filter-ordering]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_filters#arch-overview-http-filters-ordering
