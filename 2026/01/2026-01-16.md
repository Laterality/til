# 2026-01-16

## Envoy

### 요청의 생명주기

#### 요청 흐름

##### 3. TLS 전송 소켓 복호화

Envoy는 [TransportSocket][envoy-network-transport-socket-h] 확장 인터페이스를 통해 플러그 가능한 전송 소켓을 제공한다. 전송 소켓은 TCP 커넥션의 생명주기 이벤트를 따르며 네트워크 버퍼에 읽고 쓴다. 전송 소켓이 구현해야 하는 일부 핵심 메서드는 다음과 같다:

```c++
virtual void onConnected() PURE;
virtual IoResult doRead(Buffer::Instance& buffer) PURE;
virtual IoResult doWrite(Buffer::Instance& buffer, bool end_stream) PURE;
virtual void closeSocket(Network::ConnectionEvent event) PURE;
```

TCP 커넥션에 데이터가 사용 가능한 경우, `Network::ConnectionImpl::onReadReady()`는 `SslSocket::doRead()`를 통해 [TLS][arch-security-tls] 전송 소켓을 호출한다. 전송 소켓은 이후 TCP 커넥션에 TLS 핸드셰이크를 수행한다. 핸드셰이크가 완료되면 `SslSocket::doRead()`는 네트워크 필터 체인을 관리할 책임을 갖는 `Network::FilterManagerImpl` 인스턴스에 복호화된 바이트 스트림을 제공한다.

TLS 핸드셰이크든 필터 파이프라인의 일시 중단(pause)든 실제로 블로킹으로 처리되는 작업이 없다는 점이 중요하다. Envoy는 이벤트 기반이므로 처리가 추가적인 데이터를 요구하는 경우 이벤트는 조기에 완료되고 CPU를 다른 이벤트에 양보할 것이다. 네트워크가 데이터를 더 읽을 수 있게 되면, 읽기 이벤트가 TLS 핸드셰이크를 재개시킬 것이다.

[envoy-network-transport-socket-h]: https://github.com/envoyproxy/envoy/blob/cf7b51404dc599cd3183320b72e11038a72ff29a/envoy/network/transport_socket.h
[arch-security-tls]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/security/ssl#arch-overview-ssl
