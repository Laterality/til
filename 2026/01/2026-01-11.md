# 2026-01-11

## Envoy

### 요청의 생명주기

#### 구성

Envoy는 매우 광범위한 플랫폼이다. 이로 인해 요청 경로는 다음에 따라 매우 다양해진다:

- L3/4 프로토콜, e.g. TCP, UDP, Unix 도메인 소켓
- L7 프로토콜, e.g. HTTP/1, HTTP/3, HTTP/3, gRPC, Thrift, Dubbo, Kafka, Redis 및 다양한 데이터베이스.
- 전송 소켓, e.g. 평문, TLS, ALTS.
- 커넥션 라우팅, e.g. PROXY 프로토콜, 원본 목적지, 동적 포워딩.
- 인증 및 인가.
- 서킷 브레이커 및 이상 탐지 구성과 활성 상태.
- 네트워킹을 위한 다른 많은 구성, HTTP 리스너, 액세스 로깅, 헬스 체킹, 트레이싱 및 통계 확장.

한 번에 한가지에만 집중하는 것이 도움이 되므로 이 예시는 다음을 다룬다:

- 다운스트림과 업스트림 양 쪽 모두 TCP 커넥션을 통한 [TLS][arch-security-tls]로 HTTP/2 요청.
- [HTTP 커넥션 관리자][arch-http-http-connection-management]를 유일한 [네트워크 필터][arch-listeners-listener-filters]로.
- 가상의 CustomFilter와 [라우터][arch-http-http-routing]필터를 [HTTP 필터][arch-http-http-filters] 체인으로.
- [파일시스템 액세스 로깅][arch-observability-access-logging].
- [Statsd sink][api-bootstrap-stats-stats-sink].
- 정적 엔드포인트가 있는 단일 [클러스터][arch-upstream-clusters-cluster-manager].

단순함을 위해 정적 부트스트랩 구성 파일을 가정한다:

```yaml
static_resources:
  listeners:
  # There is a single listener bound to port 443.
  - name: listener_https
    address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: 443
    # A single listener filter exists for TLS inspector.
    listener_filters:
    - name: "envoy.filters.listener.tls_inspector"
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector
    # On the listener, there is a single filter chain that matches SNI for acme.com.
    filter_chains:
    - filter_chain_match:
        # This will match the SNI extracted by the TLS Inspector filter.
        server_names: ["acme.com"]
      # Downstream TLS configuration.
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
            - certificate_chain: {filename: "certs/servercert.pem"}
              private_key: {filename: "certs/serverkey.pem"}
      filters:
      # The HTTP connection manager is the only network filter.
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          use_remote_address: true
          http2_protocol_options:
            max_concurrent_streams: 100
          # File system based access logging.
          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: "/var/log/envoy/access.log"
          # The route table, mapping /foo to some_service.
          route_config:
            name: local_route
            virtual_hosts:
            - name: local_service
              domains: ["acme.com"]
              routes:
              - match:
                  path: "/foo"
                route:
                  cluster: some_service
          # CustomFilter and the HTTP router filter are the HTTP filter chain.
          http_filters:
          # - name: some.customer.filter
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  clusters:
  - name: some_service
    # Upstream TLS configuration.
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
    load_assignment:
      cluster_name: some_service
      # Static endpoint assignment.
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 10.1.2.10
                port_value: 10002
        - endpoint:
            address:
              socket_address:
                address: 10.1.2.11
                port_value: 10002
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options:
            max_concurrent_streams: 100
  - name: some_statsd_sink
  # The rest of the configuration for statsd sink cluster.
# statsd sink.
stats_sinks:
- name: envoy.stat_sinks.statsd
  typed_config:
    "@type": type.googleapis.com/envoy.config.metrics.v3.StatsdSink
    tcp_cluster_name: some_statsd_sink
```

[arch-security-tls]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/security/ssl#arch-overview-ssl
[arch-http-http-connection-management]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_connection_management#arch-overview-http-conn-man
[arch-listeners-listener-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listener_filters#arch-overview-network-filters
[arch-http-http-routing]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_routing#arch-overview-http-routing
[arch-http-http-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_filters#arch-overview-http-filters
[arch-observability-access-logging]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/access_logging#arch-overview-access-logs-sinks
[api-bootstrap-stats-stats-sink]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/metrics/v3/stats.proto#envoy-v3-api-msg-config-metrics-v3-statssink
[arch-upstream-clusters-cluster-manager]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/cluster_manager#arch-overview-cluster-manager
