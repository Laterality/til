# 2026-01-24

## Envoy

### 요청의 생명주기

#### 요청 흐름

##### 10. 응답 경로와 HTTP 수명주기

헤더와 선택적으로 본문과 트레일러로 구성된 요청은 업스트림으로 프록시되고 응답은 다운스트림으로 프록시된다. 응답은 요청과 [반대 순서][arch-http-http-filters-filter-ordering]로 HTTP와 네트워크 필터를 통과한다.

디코더/인코더 요청 수명주기 이벤트를 위한 다양한 콜백이 HTTP 필터에서 호출된다. 예를 들어 응답 트레일러가 포워드되고 있거나 요청 본문이 스트림될 때가 있다. 비슷하게, 읽기/쓰기 네트워크 필터 또한 요청 도중에 양방향으로 데이터가 계속 흐르기 때문에 각각 고유한 콜백을 갖는다.

엔드포인트에 대한 [이상 감지][arch-upstream-clusters-outlier-detection] 상태는 요청이 진행됨에 따라 바뀐다.

HTTP/2와 HTTP/3 프로토콜에서 프록시가 완료되고 스트림이 소멸하는지는 독립된 반닫힘 옵션에 의해 결정된다. 독립된 반닫힘이 활성화된 경우 스트림은 요청과 응답 모두 완료된 이후, 즉 end-stream이 양 방향 모두 설정된  트레일러나 헤더/본문을 수신하고 응답 상태 코드가 성공(2xx)이 됨으로써 각각이 end-of-stream에 도달하면 완료된다. 이는 `FilterManager::checkAndCloseStreamFullyClosed()`에서 담당한다.

HTTP/1 프로토콜이나 반닫힘이 비활성화된 경우 스트림은 응답이 완료되고 자신의 end-of-stream에 도달, 즉 트레일러나 응답 헤더/본문에 end-stream이 설정된 채로 수신하면 요청이 완료되지 않았더라도 스트림이 소멸한다. 이는 `Router::Filter::onUpstreamComplete()`에서 담당한다.

요청을 조기에 종료하는 것도 가능하다. 이는 다음과 같은 이유 때문일 것이(지만 이것으로 한정되지는 않는다)다:

- 요청 타임아웃.
- 업스트림 엔드포인트 스트림 초기화.
- HTTP 필터 스트림 초기화.
- 서킷 브레이킹.
- 업스트림 리소스의 사용 불가(unavailable), e.g. 라우트에 대한 클러스터 누락.
- 헬시 엔드포인트 없음.
- DoS 보호.
- HTTP 프로토콜 위반.
- HCM 또는 HTTP 필터 중 한 곳에서 로컬 응답. E.g. 요청량 제한 HTTP 필터가 429 응답 반환.

이들 중 하나라도 발생하면 Envoy는 내부적으로 생성된 응답을 보내고, 업스트림 응답 헤더가 아직 보내지지 않았거나 응답 헤더가 이미 다운스트림으로 포워드된 경우 스트림을 초기화할 것이다. Envoy [디버깅 FAQ][faq-debug]에 스트림 조기 종료를 해석하는 더 자세한 설명이 있다.

[arch-http-http-filters-filter-ordering]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_filters#arch-overview-http-filters-ordering
[arch-upstream-clusters-outlier-detection]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/outlier#arch-overview-outlier-detection
[faq-debug]: https://www.envoyproxy.io/docs/envoy/latest/faq/overview#faq-overview-debug
