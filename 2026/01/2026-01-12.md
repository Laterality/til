# 2026-01-11

## Envoy

### 요청의 생명주기

#### 고수준 아키텍처

Envoy의 요청 처리 경로는 크게 두 부분으로 나뉜다:

- [리스너 서브시스템][arch-listeners-listeners]은 **다운스트림** 요청 처리를 담당한다. 또한 다운스트림 요청 수명주기와 클라이언트에 대한 응답 경로를 책임진다. 다운스트림 HTTP/2 코덱이 여기 위치한다.
- [클러스터 서브시스템][arch-upstream-clusters-cluster-manager]은 엔드포인트로의 **업스트림** 커넥션을 선택하고 구성할 책임을 갖는다. 클러스터와 엔드포인트 헬스에 대한 지식과 로드 밸런싱과 커넥션 풀링이 있는 곳이다. 업스트림 HTTP/2 코덱이 여기 위치한다.

두 서브시스템은 HTTP 라우터 필터로 연결돼 다운스트림에서 업스트림으로 HTTP 요청을 포워드한다.

[리스너 서브시스템][arch-listeners-listeners]과 [클러스터 서브시스템][arch-upstream-clusters-cluster-manager]이라는 용어를 최상위 `ListenerManager`와 `ClusterManager` 클래스들에 의해 생성된 모듈 그룹과 인스턴스 클래스들을 의미로 사용한다. 아래에서 설명하는 많은 컴포넌트들은 이러한 요청 처리 과정 전이나 도중에 인스턴스화된다. 예를 들어 필터 체인, 커넥션 풀, 로드 밸런싱 자료 구조 등이 있다.

Envoy는 [이벤트 기반 스레드 모델][envoy-threading-model]을 갖는다. 메인 스레드는 서버 수명주기, 구성 처리 통계 등에 대한 책임을 갖고 일부 [워커 스레드][arch-intro-threading-model]는 요청을 처리한다. 모든 스레드는 이벤트 루프([libevent][libevent])로 동작하고 (멀티플렉스된 모든 스트림을 포함해)모든 주어진 다운스트림 TCP 커넥션은 수명주기동안 하나의 워커 스레드가 담당한다. 각 워커 스레드는 업스트림 엔드포인트로의 고유한 TCP 커넥션 풀을 유지한다. [UDP][arch-listeners-listeners-udp] 처리는 SO_REUSEPORT를 사용해 커널이 일관되게 소스/목적지 IP:포트 튜플을 같은 워커 스레드로 해시하게 만든다. UDP 필터 상태는 주어진 워커 스레드에 대해 공유되며 필터는 필요에 따라 세션 시맨틱을 제공한다. 이는 이후에 논의할 연결 지향 TCP 필터와는 대조적이다. 여기서 필터 상태는 커넥션 별로 존재하며 HTTP 필터의 경우 요청 단위로 존재한다.

워커 스레드는 상태를 공유하는 경우가 드물고 약간 병렬 형태로 동작한다. 이 스레딩 모델은 코어 수가 많은 CPU로 확장할 수 있게 한다.

[arch-listeners-listeners]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listeners#arch-overview-listeners
[arch-upstream-clusters-cluster-manager]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/cluster_manager#arch-overview-cluster-manager
[envoy-threading-model]: https://blog.envoyproxy.io/envoy-threading-model-a8d44b922310
[arch-intro-threading-model]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/intro/threading_model#arch-overview-threading
[libevent]: https://libevent.org/
[arch-listeners-listeners-udp]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listeners#arch-overview-listeners-udp
