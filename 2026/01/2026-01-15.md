# 2026-01-15

## Envoy

### 요청의 생명주기

#### 요청 흐름

##### 2. 리스너 필터 체인과 네트워크 필터 체인 일치

워커 스레드의 *Listener*는 [리스너 필터][arch-listeners-listener-filters] 체인을 생성하고 실행한다. 필터 체인은 각 필터의 *필터 팩토리*를 적용해 생성된다. 팩토리는 필터의 구성을 인지하고 각 커넥션이나 스트림마다 필터의 새 인스턴스를 생성한다.

우리의 TLS 구성의 경우, 리스너 필터 체인은 [TLS 조사자(inspector)][config-listeners-listener-filters-tls-inspector] 필터(`envoy.filters.listener.tls_inspector`)로 구성된다. 이 필터는 초기 TLS 핸드셰이크를 조사하고 서버 이름(SNI)을 추출한다. 이후 SNI는 필터 체인 일치에 사용할수 있게 된다. 리스너 필터 체인 구성에 TLS 조사자가 명시적으로 등장하기는 하지만 Envoy는 리스너의 필터 체인에 SNI(또는 ALPN)가 필요하면 이를 자동으로 삽입한다.

TLS 조사자 필터은 [ListenerFilter][envoy-network-filter-h] 인터페이스를 구현한다. 리스너든 네트워크/HTTP든 모든 필터 인터페이스는 필터에 특정 커넥션이나 스트림 이벤트에 대한 콜백을 구현할 것을 요구한다. `ListenerFilter`의 경우:

```c++
virtual FilterStatus onAccept(ListenerFilterCallbacks& cb) PURE;
```

`onAccept()`는 TCP 수락 처리 동안 필터가 실행될 수 있게 한다. 콜백이 반환하는 `FilterStatus`는 리스너 필터 체인이 어떻게 계속 실행될지를 제어한다. 리스너 필터는 필터 체인을 멈췄다가 나중에 재개할 수 있다 e.g. 다른 서비스로 보내지는 RPC에 대한 응답.

리스너 필터로부터 추출된 정보와 커넥션 속성은 이후 필터 체인 일치에 쓰이며 커넥션을 처리하는 데 사용될 네트워크 필터 체인과 전송 소켓을 제공한다.

[arch-listeners-listener-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listener_filters#arch-overview-listener-filters
[config-listeners-listener-filters-tls-inspector]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/tls_inspector#config-listener-filters-tls-inspector
[envoy-network-filter-h]: https://github.com/envoyproxy/envoy/blob/d11f45c3a0fb473a256bf6cd726aa17a19a4fa13/envoy/network/filter.h
