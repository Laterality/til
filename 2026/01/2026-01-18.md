# 2026-01-18

## Envoy

### 요청의 생명주기

#### 요청 흐름

##### 4. 네트워크 필터 체인 처리

리스너 필터 체인에서처럼, Envoy는 `Network::FilterManagerImpl`을 통해 필터 팩토리로부터 일련의 [네트워크 필터][arch-listeners-listener-filters-network-filters]들을 인스턴스화한다. 인스턴스는 새 커넥션마다 만들어진다. 네트워크 필터는 전송 소켓처럼 TCP 수명주기 이벤트를 따르고 전송 소켓에서 데이터을 사용할 수 있게 되면 호출된다.

커넥션 별로 하나인 전송 소켓과는 달리 네트워크 필터는 하나의 파이프라인으로 조합된다. 네트워크 필터는 세 종류가 있다:

- `onData()`를 구현하는 [ReadFilter][envoy-network-filter-h]는 커넥션에서 (요청으로 인해)데이터를 읽을 수 있게 된 경우 호출된다.
- `onWrite()`를 구현하는 [WriteFilter][envoy-network-filter-h]는 커넥션에 (응답으로 인해)데이터를 쓰려고 할 때 호출된다.
- *ReadFilter*와 *WriteFilter* 둘 다 구현하는 [Filter][envoy-network-filter-h]

핵심 필터 메서드의 메서드 시그니쳐는 다음과 같다:

```c++
virtual FilterStatus onNewConnection() PURE;
virtual FilterStatus onData(Buffer::Instance& data, bool end_stream) PURE;
virtual FilterStatus onWrite(Buffer::Instance& data, bool end_stream) PURE;
```

리스너 필터처럼 `FilterStatus`는 필터에 필터 체인의 실행을 일시 중지할 수 있게 한다. 예를 들어, 요청량 제한 서비스를 쿼리해야 하는 경우, 요청량 제한 네트워크 필터는 `onData()`에서 `Network::FilterStatus::StopIteration`를 반환하고 이후 쿼리가 완료되면 `continueReading()`을 호출한다.

리스너가 HTTP로 처리하는 마지막 네트워크 필터는 [HTTP 커넥션 관리자][arch-http-http-connection-management](HCM)이다. HTTP/2 코덱을 생성하고 HTTP 필터 체인을 관리할 책임을 갖는다. 우리 예시에서는 네트워크 필터 뿐이다.

[arch-listeners-listener-filters-network-filters]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listener_filters#arch-overview-network-filters
[envoy-network-filter-h]: https://github.com/envoyproxy/envoy/blob/90ab241898915e54926a787ee61d4c0c51547acf/envoy/network/filter.h
[arch-http-http-connection-management]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_connection_management#arch-overview-http-conn-man
