# 2025-07-27

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 헬스 체크

활성 헬스 체크는 업스트림 클러스터별로 [구성될][config-upstream-clusters-cluster-manager-health-checking] 수 있다. [서비스 디스커버리][arch-upstream-clusters-service-discovery] 섹션에 기술된 것처럼 활성 헬스 체크와 EDS 서비스 디스커버리 유형은 함께 움직인다. 하지만 다른 서비스 디스커버리 유형을 사용중인 경우에도 활성 헬스 체크가 필요한 다른 시나리오가 있다. Envoy는 세 가지 유형의 헬스 체크를 다양한 설정(확인 주기, 호스트를 언헬시(unhealthy)로 만드는 데 필요한 실패 횟수, 호스트를 헬시(healthy)로 만드는 데 필요한 성공 횟수 등)과 함께 지원한다.

* **HTTP**: HTTP 헬스 체크 과정에서 Envoy는 업스트림 호스트에 HTTP 요청을 보낸다. 기본적으로 호스트가 헬시(healthy) 상태이면 200 응답을 예상한다. 예상되고 재시도 가능한 응답 코드는 [구성 가능하다][api-clusters-health-check-http-health-check]. 업스트림 호스트는 다운스트림 호스트가 더이상 트래픽을 포워드하지 않기를 원하는 경우 예상하지 않았거나 재시도할 수 없는 상태 코드(기본값은 200이 아닌 코드)를 반환할 수 있다.
* **gPRC**: gRPC 헬스 체크 과정에서 Envoy는 업스트림 호스트에 gRPC 요청을 보낸다. 기본적으로 호스트가 헬시 상태이면 200 응답을 예상한다. gRPC 헬스 체크는 [여기][api-clusters-health-check-grpc-health-check]서 구성 가능하다.
* **L3/L4**: L3/L4 헬스 체크 과정에서 Envoy는 업스트림 호스트에 [구성 가능한][api-clusters-health-check-tcp-health-check] 바이트 버퍼를 보낸다. 호스트가 헬시 상태인 경우 바이트 버퍼를 그대로 응답할 것으로 예상한다. Envoy는 연결 전용 L3/L4 헬스 체크도 지원한다.
* **Redis**: Envoy는 Redis PING 명령을 보내고 PONG 응답을 예상한다. 업스트림 Redis 서버는 PONG외의 다른 것으로 응답해 활성 헬스 체크를 즉시 실패하게 만들 수 있다. 선택사항으로, Envoy는 사용자가 지정한 키에 EXISTS를 수행할 수 있다. 키가 존재하지 않으면 헬스 체크를 통과한 것으로 간주한다. 이는 사용자가 지정된 키에 임의의 값을 설정해 유지보수가 필요한 Redis 인스턴스를 표시하고 트래픽을 빼기를 기다릴 수 있게 한다. [redis_key][api-extensions-health-checkers-redis] 참고.
* **Thrift**: Envoy는 Thrift 요청을 보내고 성공 응답을 예상한다. 업스트림 호스트는 예외와 함께 응답해 헬스 체크를 실패하게 만들 수 있다. [Thrift][api-extensions-health-checkers-thrift] 참고.

헬스 체크는 클러스터에 지정된 전송 소켓을 통해 발생한다. 이는 클러스터가 TLS가 활성화된 전송 소켓을 사용중일 경우 헬스 체크 또한 TLS를 사용함을 의미한다. [TLS 옵션][api-clusters-health-check-tls-options]을 사용해 헬스 체크 커넥션을 지정할 수 있는데, 해당 업스트림이 헬스 체크과 데이터 커넥션에 서로 다른 프로토콜과 함께 ALPN 기반 [FilterChainMatch][api-listeners-listener-components-filter-chain-match]를 사용중일 때 유용하다.

[config-upstream-clusters-cluster-manager-health-checking]: https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_hc#config-cluster-manager-cluster-hc
[arch-upstream-clusters-service-discovery]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/service_discovery#arch-overview-service-discovery
[api-clusters-health-check-http-health-check]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-msg-config-core-v3-healthcheck-httphealthcheck
[api-clusters-health-check-grpc-health-check]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-msg-config-core-v3-healthcheck-grpchealthcheck
[api-clusters-health-check-tcp-health-check]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-msg-config-core-v3-healthcheck-tcphealthcheck
[api-extensions-health-checkers-redis]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/health_checkers/redis/v3/redis.proto#envoy-v3-api-msg-extensions-health-checkers-redis-v3-redis
[api-extensions-health-checkers-thrift]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/health_checkers/thrift/v3/thrift.proto#envoy-v3-api-msg-extensions-health-checkers-thrift-v3-thrift
[api-clusters-health-check-tls-options]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-msg-config-core-v3-healthcheck-tlsoptions
[api-listeners-listener-components-filter-chain-match]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener_components.proto#envoy-v3-api-msg-config-listener-v3-filterchainmatch