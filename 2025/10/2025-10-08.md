# 2025-10-08

## Envoy

### 아키텍처 개요

#### 보안

##### TLS

###### 인증서 선택

[DownstreamTlsContexts][api-extensions-transport-sockets-downstream-tls-contexts]는 여러 TLS 인증서를 지원한다. 이는 여러 서버 이름 패턴들에 대한 RSA와 ECDSA의 혼합이 될 수 있다.

인증서 구성/로딩 규칙:

* 핸드셰이크 도중에 DNS SAN 또는 Subject Common Name을 서버 이름 패턴으로 추출해 SNI와 일치하는지 확인한다. DNS SAN이 인증서에 존재하면 Subject Common Name은 쓰이지 않는다.
* "test.example.com"과 같은 FQDN과 "*.example.com"과 같은 와일드카드가 동시에 유효해 두 개의 서로 다른 서버 이름 패턴으로 로드된다.
* 특정 타입(RSA 또는 ECDSA)의 여러 인증서가 같은 이름이나 이름 패턴에 지정되면 첫 번째로 로드된 것이 해당 이름에 쓰인다.
* Non-P-256, P-384, P-521 서버 ECDSA 인증서는 거부된다.
* 정적 및 SDS 인증서가 주어진 [DownstreamTlsContext][api-extensions-transport-sockets-downstream-tls-contexts]에 혼합되지 않을 수 있다.

인증서 선택 규칙:

* 클라이언트가 SNI를 지원하는 경우, 예를 들어 SNI가 "test.example.com"이면 해당 SNI에 정확히 일치하는 인증서를 찾는다. 해당 인증서가 OCSP 정책에 붙어있고 키 유형과 일치하면 이 인증서가 핸드셰이크를 위해 선택된다. 인증서가 OCSP 정책에는 붙어있지만 키 유형이 RSA인데 클라이언트가 ECDSA를 지원하면 후보로 표시하고 정확히 일치하는 인증서를 발견하거나 인증서가 더이상 없을 때까지 계속 찾는다. 정확히 일치하는 인증서가 없으면 후보가 핸드셰이크에 선택된다.
* 클라이언트가 SNI를 지원하지만 SNI에 정확히 일치하는 인증서에서 인증서가 선택되지 않으면 와일드카드 서버 이름에 일치하는지 확인한다. 예를 들어 SNI가 "test.example.com"이면 "test.example.com"인 인증서가 "*.example.com"인 인증서보다 선호된다. 그리고 와일드카드 일치는 1단계 깊이에만 적용되므로, "*.com"은 "test.example.com"에 일치하지 않는다. 이후 각 인증서에 SNI가 정확히 일치할 때 발생하는 것과 동일한 OCSP와 키 유형 검사를 실행한다.
* 와일드카드 이름에 일치하는 인증서가 선택되지 않으면 후보 인증서가 존재하는 경우 이를 핸드셰이크에 사용한다. 후보가 없으면 [full_scan_certs_on_sni_mismatch][api-extensions-transport-sockets-downstream-tls-context-full-scan-certs-on-sni-mismatch]를 검사해 활성화된 경우 모든 인증서를 전체 스캔하고 그 외에는 첫 번째 인증서를 핸드셰이크에 사용한다.
* 클라이언트가 SNI를 전혀 제공하지 않으면 [full_scan_certs_on_sni_mismatch][api-extensions-transport-sockets-downstream-tls-context-full-scan-certs-on-sni-mismatch]가 false인지 true인지에 관계없이 풀 스캔을 수행한다.
* 풀 스캔은 위에서 설명한 SNI가 정확히 일치할 때와 동일하게 OCSP와 키 유형 검사를 수행한다. 선택된 인증서가 없으면 전체 목록의 첫 번째로 폴백한다.
* 현재 두 가지 유형의 키 RSA와 ECDSA만 지원된다. 클라이언트가 P-256, P-384, P-521 ECDSA를 지원하면 P-256, P-384, P-521 ECDSA 인증서가 RSA보다 선호된다. 폴백하는 인증서는 핸드셰이크가 실패할 수 있다. 예를 들어, 클라이언트가 RSA 인증서만 지원하고 인증서가 ECDSA뿐일 수 있다.
* 최종적으로 선택된 인증서는 OCSP 정책에 붙여야 한다. 이러한 인증서가 발견되지 않으면 커넥션을 거부한다.

> [!NOTE]
>
> SNI 기반 인증서 선택을 지원하면서 여러 호스트네임에 대량의 인증서를 구성하는 것을 허용한다. [full_scan_certs_on_sni_mismatch][api-extensions-transport-sockets-downstream-tls-context-full-scan-certs-on-sni-mismatch]는 클라이언트가 SNI를 제공하는 경우 SNI 불일치시 풀 스캔을 계속할지를 결정하기 위해 도입됐다. 이 상황에서 SNI 불일치에는 두 가지 경우가 포함되는데, 하나는 SNI에 일치하는 인증서가 없는 경우고 다른 하나는 SNI에 일치하는 인증서는 존재하지만 이 인증서들에 OCSP 정책이 실패하는 경우다. [full_scan_certs_on_sni_mismatch][api-extensions-transport-sockets-downstream-tls-context-full-scan-certs-on-sni-mismatch]는 기본값이 false이므로 풀 스캔은 기본적으로 비활성화돼 있다. 풀 스캔이 활성화되면 SNI 불일치에 대해 전체 인증서 목록을 조회하는데, 이는 O(n) 복잡도로 인해 잠재적으로 DoS 공격이 될 수 있다.

현재 [UpstreamTlsContexts][api-extensions-transport-sockets-upstream-tls-context]에는 하나의 TLS 인증서만 지원된다.

[api-extensions-transport-sockets-downstream-tls-contexts]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-downstreamtlscontext
[api-extensions-transport-sockets-downstream-tls-context-full-scan-certs-on-sni-mismatch]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-field-extensions-transport-sockets-tls-v3-downstreamtlscontext-full-scan-certs-on-sni-mismatch
[api-extensions-transport-sockets-upstream-tls-context]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-upstreamtlscontext
