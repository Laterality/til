# 2025-10-07

## Envoy

### 아키텍처 개요

#### 보안

##### TLS

###### 인증서 검증 활성화

업스트림과 다운스트림 양쪽 커넥션에 대한 인증서 검증은 유효성 검증 컨텍스트가 하나 이상의 신뢰하는 기관 인증서를 지정하지 않으면 활성화되지 않는다.

**예제 구성**

```yaml
static_resources:
  listeners:
    - name: listener_0
      address: { socket_address: { address: 127.0.0.1, port_value: 10000 } }
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                route_config:
                  virtual_hosts:
                    - name: default
                      domains: ["*"]
                      routes:
                        - match: { prefix: "/" }
                          route:
                            cluster: some_service
          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                tls_certificates:
                  - certificate_chain: { filename: "certs/servercert.pem" }
                    private_key: { filename: "certs/serverkey.pem" }
                validation_context:
                  trusted_ca:
                    filename: certs/cacert.pem
  clusters:
    - name: some_service
      type: STATIC
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: some_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 1234
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          common_tls_context:
            tls_certificates:
              - certificate_chain: { "filename": "certs/servercert.pem" }
                private_key: { "filename": "certs/serverkey.pem" }
                ocsp_staple: { "filename": "certs/server_ocsp_resp.der" }
            validation_context:
              match_typed_subject_alt_names:
                - san_type: DNS
                  matcher:
                    exact: "foo"
              trusted_ca:
                filename: /etc/ssl/certs/ca-certificates.crt
```

*/etc/ssl/cers/ca-certificates.crt*는 Debian 시스템에서 시스템 CA 번들의 기본 경로다. cURL 등이 표준 Debian 시스템 설치에서 하는 것과 같은 방법으로 [match_typed_subject_alt_names][api-extensions-transport-sockets-certificate-validation-context-match-typed-subject-alt-names]가 함께 있는 [trusted_ca][api-extensions-transport-sockets-san-type-trusted-ca]가 _127.0.0.1:1234_ 서버의 신원을 "foo"로 확인한다. Linux와 BSD에서 시스템 CA 번들에 대한 공통 경로는:

- /etc/ssl/certs/ca-certificates.crt (Debian/Ubuntu/Gentoo etc.)
- /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem (CentOS/RHEL 7)
- /etc/pki/tls/certs/ca-bundle.crt (Fedora/RHEL 6)
- /etc/ssl/ca-bundle.pem (OpenSUSE)
- /usr/local/etc/ssl/cert.pem (FreeBSD)
- /etc/ssl/cert.pem (OpenBSD)

다른 TLS 옵션에 대해서는 [UpstreamTlsContexts][api-extensions-transport-sockets-upstream-tls-context]와 [DownstreamTlsContexts][api-extensions-transport-sockets-downstream-tls-context]를 참고하라.

> [!WARN]
>
> [trusted_ca][api-extensions-transport-sockets-san-type-trusted-ca]만 지정되면 Envoy는 제시된 인증서의 인증서 체인을 확인하지만 대상 이름(subject name), 해시 등은 확인하지 않는다. 배포에 따라 대체로 다른 유효성 검증 컨텍스트 구성이 필요하다.

**커스텀 인증서 검증자**

위에서 설명한 구성은 "기본" 인증서 검증자에서 쓰인다. Envoy는 [CertificateValidationContext][api-extensions-transport-sockets-certificate-validation-context]에서 구성할 수 있는 `envoy.tls.cert_validator` 확장 카테고리에서 커스텀 검증자도 지원한다.

예를 들어, Envoy는 하나의 리스너나 클러스터에 여러 신뢰 번들을 갖는 [SPIFFE][spiffe] 명세를 따르는 피어 인증서를 검증하도록 구성할 수 있다. 더 자세한 내용은 [custom_validator_config 필드 문서][api-extensions-transport-sockets-certificate-validation-context-custom-validator-config]를 참고하라.

[api-extensions-transport-sockets-certificate-validation-context-match-typed-subject-alt-names]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#envoy-v3-api-field-extensions-transport-sockets-tls-v3-certificatevalidationcontext-match-typed-subject-alt-names
[api-extensions-transport-sockets-san-type-trusted-ca]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#envoy-v3-api-field-extensions-transport-sockets-tls-v3-certificatevalidationcontext-trusted-ca
[api-extensions-transport-sockets-upstream-tls-context]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-upstreamtlscontext
[api-extensions-transport-sockets-downstream-tls-context]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-downstreamtlscontext
[api-extensions-transport-sockets-certificate-validation-context]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-certificatevalidationcontext
[spiffe]: https://github.com/spiffe/spiffe
[api-extensions-transport-sockets-certificate-validation-context-custom-validator-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto#envoy-v3-api-field-extensions-transport-sockets-tls-v3-certificatevalidationcontext-custom-validator-config
