# 2025-10-13

## Envoy

### 아키텍처 개요

#### 보안

##### TLS

###### 트러블슈팅

업스트림 클러스터로의 커넥션을 시작할 때 Envoy가 TLS를 시작하면 모든 오류는 [UPSTREAM_TRANSPORT_FAILURE_REASON][config-observability-access-logs-access-logging-upstream-transport-failure-reason] 필드 또는 [AccessLogCommon.upstream_transport_failure_reason][api-envoy-data-access-logs-access-log-common-upstream-transport-failure-reason] 필드에 로깅된다.

Envoy 리스너가 커넥션을 얻어 다운스트림과의 TLS를 수행할 때 모든 오류는 [DOWNSTREAM_TRANSPORT_FAILURE_REASON][config-observability-access-logs-access-logging-downstream-transport-failure-reason] 필드 또는 [AccessLogCommon.downstream_transport_failure_reason][api-envoy-data-access-logs-access-log-common-downstream-transport-failure-reason] 필드에 로깅된다.

흔한 오류들은 다음과 같다:

* `Secret is not supplied by SDS`: Envoy가 아직 SDS가 키/인증서나 루트 CA를 전달하길 기다리고 있다.
* `SSLV3_ALERT_CERTIFICATE_EXPIRED`: 피어 인증서가 만료됐거나 구성에서 허용되지 않는다.
* `SSLV3_ALERT_CERTIFICATE_UNKNOWN`: 피어 인증서가 지정된 SPKI에 없다.
* `SSLV3_ALERT_HANDSHAKE_FAILURE`: 핸드셰이크 실패, 보통 업스트림에서 클라이언트 인증서를 요구했으나 제시하지 않은 경우이다.
* `TLSV1_ALERT_PROTOCOL_VERSION`: TLS 프로토콜 버전 불일치
* `TLSV1_ALERT_UNKNOWN_CA`: 피어 인증서 CA가 신뢰하는 CA에 없다.

[config-observability-access-logs-access-logging-upstream-transport-failure-reason]: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-upstream-transport-failure-reason
[api-envoy-data-access-logs-access-log-common-upstream-transport-failure-reason]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/data/accesslog/v3/accesslog.proto#envoy-v3-api-field-data-accesslog-v3-accesslogcommon-upstream-transport-failure-reason
[config-observability-access-logs-access-logging-downstream-transport-failure-reason]: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-downstream-transport-failure-reason
[api-envoy-data-access-logs-access-log-common-downstream-transport-failure-reason]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/data/accesslog/v3/accesslog.proto#envoy-v3-api-field-data-accesslog-v3-accesslogcommon-downstream-transport-failure-reason
