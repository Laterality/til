# 2025-10-10

## Envoy

### 아키텍처 개요

#### 보안

##### TLS

###### OCSP 스테이플

[DownstreamTlsContexts][api-extensions-transport-sockets-downstream-tls-context]는 핸드셰이크 도중 온라인 인증서 상태 프로토콜(Online Certificate Status Protocol, OCPSP) 응답을 TLS 인증서에 스테이플(stapling)하는 것을 지원한다. `ocsp_staple` 필드는 컨텍스트에 운영자가 사전 계산된 OCSP 응답을 인증서별로 제공할 수 있게 한다. 하나의 응답이 여러 인증서에 속하지 않을 수 있다. 제공된 경우 OCSP 응답은 유효하고 인증서가 회수되지 않았음을 확인해야 한다. 만료된 OCSP 응답은 받아들여지지만 OCSP 스테이플 정책에 따라 다운스트림 커넥션 오류를 발생시킬 수 있다.

[DownstreamTlsContexts][api-extensions-transport-sockets-downstream-tls-context]는 `ocsp_staple_policy` 필드를 지원해 연관된 OCSP 응답이 누락됐거나 만료됐을 때 Envoy가 인증서 사용을 중단하거나 스테이플하지 않고 계속 사용할지 제어한다. [must-staple][rfc-7633]을 표시된 인증서는 OCSP 스테이플 정책과 관계없이 유효한 OCSP 응답을 필요로 한다. 실질적으로 must-staple 인증서는 OCSP 스테이플 정책이 [MUST_STAPLE][api-extensions-transport-sockets-ocsp-staple-policy-must-staple]인 것처럼 동작하게 한다. Envoy는 OCSP 응답이 만료된 이후에는 새 커넥션에 must-staple 인증서를 사용하지 않는다.

`status_request` 확장을 통해 OCSP 스테이플을 지원한다고 표시하지 않은 TLS 요청에는 OCSP 응답을 스테이플하지 않는다.

OCSP 응답의 요구사항을 조정하고 OCSP 정책을 오버라이드할 수 있게 다음 런타임 플래그가 제공된다. 이 플래그는 기본값이 `true`다.

* `envoy.reloadable_features.require_ocsp_response_for_must_staple_certs`: 이걸 비활성화하면 운영자가 구성에 must-staple 인증서에 대한 OCSP 응답을 생략할 수 있게 한다.
* `envoy.reloadable_feature.check_ocsp_policy`: 이걸 비활성화하면 OCSP 정책 검사를 비활성화한다. OCSP 응답은 응답이 만료된 경우가도 클라이언트가 지원하는 경우 사용 가능하면 스테이플된다. 응답이 존재하지 않으면 스테이플링을 건너뛴다.

OCSP 응답은 [UpstreamTlsContexts][api-extensions-transport-sockets-upstream-tls-context]에는 무시된다.


[api-extensions-transport-sockets-downstream-tls-context]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-downstreamtlscontext
[rfc-7633]: https://datatracker.ietf.org/doc/html/rfc7633
[api-extensions-transport-sockets-ocsp-staple-policy-must-staple]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-enum-value-extensions-transport-sockets-tls-v3-downstreamtlscontext-ocspstaplepolicy-must-staple
[api-extensions-transport-sockets-upstream-tls-context]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto#envoy-v3-api-msg-extensions-transport-sockets-tls-v3-upstreamtlscontext
