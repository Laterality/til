# 2025-10-03

## Envoy

### 아키텍처 개요

#### 관측성

##### 트레이싱

###### 다른 모드의 Envoy

Envoy는 서비스 메시에서 사이드카로 널리 쓰이기 때문에 Envoy의 다른 트레이싱 모드를 이해하는 것이 중요하다.

첫 번째 모드에서 Envoy는 사이드카로 쓰인다. 사이드카는 애플리케이션과 연관돼 트레이스 체인에서 하나의 홉으로 취급된다. 스팬 타입이 있는 트레이싱 시스템을 사용중이라면 이상적인 트레이스 체인은 다음과 같은 모습일 것이다:

```
-> [[SERVER (inbound sidecar) -> App -> CLIENT (outbound sidecar)]] -> ...
                                 App
```

볼 수 있듯, 첫 번째 모드에서는 인바운드 사이드카가 항상 SERVER 스팬을 생성하고 아웃바운드 사이드카가 항상 CLIENT 스팬을 생성한다. 애플리케이션은 아무런 스팬도 생성하지 않고 트레이스 컨텍스트를 전파하기만 한다.

두 번째 모드에서는 Envoy가 게이트웨이로 쓰인다. 혹은 Envoy가 사이드카로 쓰이지만 이 경우에는 사이드카와 애플리케이션이 트레이스 체인에서 별도의 홉으로 취급된다. 스팬 타입이 있는 트레이싱 시스템을 사용중이라면 이상적인 트레이스 체인은 다음과 같은 모습일 것이다:

```
-> [SERVER -> CLIENT] -> [SERVER -> CLIENT] -> [SERVER -> CLIENT] -> [SERVER -> CLIENT] -> ...
        Gateway           Inbound Sidecar            App             Outbound Sidecar
```

볼 수 있듯, 두 번째 모드에서는 Envoy가 다운스트림 요청에는 SERVER 스팬을 생성하고 업스트림 요청에는 CLIENT 스팬을 생성한다. 애플리케이션도 자신의 작업에 대한 스팬을 생성할 수 있다.

이 모드를 활성화하려면 [spawn_upstream_span][api-extensions-filters-http-connection-manager-tracing-spawn-upstream-span]을 명시적으로 true로 설정한다. 이는 트레이싱 제공자에게 업스트림 요청에는 CLIENT 스팬을 생성하고 Envoy를 트레이스 체인에서 독립된 홉으로 취급하도록 알린다.

[api-extensions-filters-http-connection-manager-tracing-spawn-upstream-span]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-tracing-spawn-upstream-span
