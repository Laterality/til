# 2025-12-29

## Envoy

### 아키텍처 개요

#### 고급

##### Wasm

###### 컨텍스트, 플러그인, VM

Wasm 컨텍스트는 호스트(Envoy)와 게스트(Wasm 바이트코드) 사이의 인터페이스 구현을 의미한다. HTTP 필터의 경우 구성뿐인 컨텍스트를 나타내는 (ID 0인 컨텍스트)*루트 컨텍스트*와 각 요청마다 한 번씩 생성되는 *요청별(per-request)* 컨텍스트가 있다.

Wasm VM은 Wasm 바이트코드 모듈의 실행 인스턴스를 의미한다. `vm_id` 필드를 사용하는 경우 같은 바이트코드에 대해 여러 VM이 생성될 수 있으며 VM 별로 구분된 메모리를 갖는다. 그 반대도 참인데, 같은 VM은 서로 다른 컨텍스트에서 쓰이기 위한 서로 다른 확장(플러그인)에 대해 여러 구현을 가질 수 있다. VM 공유는 런타임 오버헤드를 최적화하고 확장들이 코드를 공유하기 때문에 바이트코드의 총 바이너리 크기를 줄인다.

Wasm 플러그인은 컨텍스트와 VM 사이의 링크이다. 컨텍스트에 사용할 Wasm VM과 ([root_id][api-extensions-wasm-plugin-config-root-id] 필드 값을 통해)Wasm VM 실행 인스턴스 내에서 호출할 확장과 xDS 갱신 도중 확장으로의 구성 호출을 라우트할 방법을 식별한다.

[api-extensions-wasm-plugin-config-root-id]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/wasm/v3/wasm.proto#envoy-v3-api-field-extensions-wasm-v3-pluginconfig-root-id
