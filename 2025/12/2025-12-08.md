# 2025-12-08

## Envoy

### 아키텍처 개요

#### 고급

##### 필터 간 데이터 공유

Envoy는 필터로(부터) 뿐만아니라 다른 핵심 서브시스템(e.g., 액세스 로깅)으로 구성, 메타데이터 요청/켜넥션 별 상태 전달을 위해 다음 메커니즘을 제공한다.

###### 정적 상태

정적 상태는 (e.g., xDS를 통한)구성 로드 시점에 지정된 불변 상태다. 정적 상태는 세 가지로 분류된다:

**메타데이터**

Envoy 구성의 몇몇 부분(e.g. 리스너, 라우트, 클러스터)은 임의의 키-값 쌍이 인코딩될 수 있는 [메타데이터][api-common-common-types-metadata]를 포함한다. 전형적인 패턴은 역 DNS 형식에서 필터 이름을 키로 사용하고 필터 특화 구성 메타데이터를 값에 인코딩하는 것이다. 이 메타데이터는 불변이며 모든 요청/커넥션에 공유된다. 이러한 구성 메타데이터는 주로 부트스트랩 과정이나 xDS의 일부로 제공된다. 예를 들어, HTTP 라우트에 가중치가 있는 클러스터는 클러스터에 해당하는 엔드포인트를 라벨링하는 데 메타데이터를 사용한다. 또다른 예시로, 서브셋 로드 밸런서는 가중치가 있는 클러스터에 해당하는 라우트 엔트리에서 메타데이터를 사용해 클러스터에서 적절한 엔드포인트를 선택한다.

**타입이 지정된(typed) 메타데이터**

[메타데이터][api-common-common-types-metadata] 자체에는 타입이 없다. 메타데이터에 작업하기 전에 호출자는 대체로 이를 타입을 가진 클래스 객체로 변환한다. (e.g., 매 요청 스트림이나 커넥션마다)반복적으로 수행될 때는 변환 비용을 무시하기 어렵다. 타입이 지정된 메타데이터는 필터가 특정 키에 대한 일회성 변환 로직을 등록할 수 있게 함으로써 이 문제를 해결한다. (xDS를 통한)인입 구성 메타데이터는 구성 로드 시점에 클래스 객체로 변환된다. 이후 필터는 타입이 지정된 메타데이터 변형을 (요청 또는 커넥션별로)런타임에 얻을 수 있다. 이를 통해 필터가 요청/커넥션 처리 과정에서 반복적으로 `Protobuf::Struct`에서 특정 내부 객체로 반복적으로 변환할 필요를 없앤다.

예를 들어, 핕터가 `ClusterInfo`에 키 `xxx.service.policy`를 가진 임의의 메타데이터에 편의성 래퍼(wrapper) 클래스를 갖고자 한다면 `ClusterTypedMetadataFactory`를 상속하는 `ServicePolicyFactory` 팩토리를 등록한다. 이 팩토리는 `Protobuf::Struct`를 (`FilterState::Object`를 상속하는)`ServicePolicy` 클래스의 객체 인스턴스로 변환한다. `Cluster`가 생성되면 연관된 `ServicePolicy` 인스턴스가 생성되고 캐시된다. 타입이 지정된 메타데이터는 메타데이터의 새로운 소스가 아니라는 점을 알아두라. 구성의 일부로 지정된 메타데이터로부터 얻어진 것이다. `serializaeAsProto` 메서드를 구현하는  `FilterState::Object`는 액세스 로거가 로그를 남기도록 구성할 수 있다.

**HTTP 라우트 별 필터 구성**

HTTP 라우트에서, [typed_per_filter_config][api-http-route-management-http-route-components-virtual-host-typed-per-filter-config]는 HTTP 필터가 모든 가상 호스트에 공통된 전역 필터 구성 외에 가상 호스트/라우트 특화 구성을 가질 수 있게 한다. 이 구성은 라우트 테이블로 변환되고 임베딩된다. 라우트 특화 필터 구성이 전역 구성을 대체할지 보충할지는 HTTP 필터 구현체에 따라 다르다. 예를 들어, HTTP 결함(fault) 필터는 이 기법을 사용해 라우트 별 결함 구성을 제공한다.

`typed_per_filter_config`는 `map<string, google.protobuf.Any>`다. 커넥션 관리자는 이 맵을 순회해 필터 팩토리 인터페이스 `createRouteSpecificFilterConfigTyped`를 호출해 구조체 값을 파싱하고 유효성을 검사하고 이를 라우트 자체와 함께 저장되는 타입이 지정된 클래스 객체로 변환한다. 이후 HTTP 필터는 요청 처리 과정에서 라우트 특화 필터 구성을 쿼리할 수 있다.

[api-common-common-types-metadata]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/base.proto#envoy-v3-api-msg-config-core-v3-metadata
[api-http-route-management-http-route-components-virtual-host-typed-per-filter-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-virtualhost-typed-per-filter-config
