# 2025-12-26

## Envoy

### 아키텍처 개요

#### 고급

##### 제네릭 일치

###### 리스너의 일치 필터 체인

**예시**

**TLS 트래픽 탐지**

다음 예시는 [tls_inspector][config-listeners-listener-filters-tls-inspector] 리스너 필터를 사용해 리스너의 일치자가 필터 체인 `tls`를 사용하는, 전송이 TLS를 사용하는지 탐지한다. 그 외에는 필터 체인 `plaintext`가 사용된다.

```yaml
    filter_chain_matcher:
      matcher_tree:
        input:
          name: transport
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.TransportProtocolInput
        exact_match_map:
          map:
            "tls":
              action:
                name: tls
                typed_config:
                  "@type": type.googleapis.com/google.protobuf.StringValue
                  value: tls
      on_no_match:
        action:
          name: plaintext
          typed_config:
            "@type": type.googleapis.com/google.protobuf.StringValue
            value: plaintext
```

**목적지 IP에 따른 일치**

다음 예시는 인입 트래픽에 [PROXY 프로토콜][config-listeners-listener-filters-proxy-protocol]이 쓰인다고 가정한다. 복원된 목적지 IP가 CIDR `10.0.0.0/24`에 속하면 필터 체인 `vip`가 사용된다. 그 외에는 필터 체인 `default`가 사용된다.

```yaml
    filter_chain_matcher:
      matcher_tree:
        input:
          name: port
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput
        exact_match_map:
          map:
            "80":
              action:
                name: http
                typed_config:
                  "@type": type.googleapis.com/google.protobuf.StringValue
                  value: http
            "443":
              matcher:
                matcher_tree:
                  input:
                    name: ip
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.SourceIPInput
                  custom_match:
                    name: ip-matcher
                    typed_config:
                      "@type": type.googleapis.com/xds.type.matcher.v3.IPMatcher
                      range_matchers:
                      - ranges:
                        - address_prefix: 192.0.0.0
                          prefix_len: 2
                        - address_prefix: 10.0.0.0
                          prefix_len: 24
                        on_match:
                          action:
                            name: internal
                            typed_config:
                              "@type": type.googleapis.com/google.protobuf.StringValue
                              value: internal
                      - ranges:
                        - address_prefix: 0.0.0.0
                        on_match:
                          action:
                            name: tls
                            typed_config:
                              "@type": type.googleapis.com/google.protobuf.StringValue
                              value: tls
```

**목적지 포트와 소스 IP에 따른 일치**

다음 예시는 [original_dst][config-listeners-listener-filters-original-destination] 리스너 필터를 사용해 원본 목적지 포트를 복원한다. 리스너의 일치자는 다음과 같이 세 필터 체인 `http`, `internal`, `tls` 중 하나를 선택한다:

- 목적지 포트가 `80`이면 필터 체인 `http`가 커넥션을 수락한다.
- 목적지 포트가 `443`이고 소스 IP가 `192.0.0.0/2` 또는 `10.0.0.0/24` 범위에 속하면 필터 체인 `internal`이 커넥션을 수락한다. 소스 IP가 이 범위에 있지 않으면 필터 체인 `tls`가 커넥션을 수락한다.
- 기본 필터 체인이 없으므로 그 외에는 커넥션이 거부된다.

```yaml
    filter_chain_matcher:
      matcher_tree:
        input:
          name: port
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.DestinationPortInput
        exact_match_map:
          map:
            "80":
              action:
                name: http
                typed_config:
                  "@type": type.googleapis.com/google.protobuf.StringValue
                  value: http
            "443":
              matcher:
                matcher_tree:
                  input:
                    name: ip
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.matching.common_inputs.network.v3.SourceIPInput
                  custom_match:
                    name: ip-matcher
                    typed_config:
                      "@type": type.googleapis.com/xds.type.matcher.v3.IPMatcher
                      range_matchers:
                      - ranges:
                        - address_prefix: 192.0.0.0
                          prefix_len: 2
                        - address_prefix: 10.0.0.0
                          prefix_len: 24
                        on_match:
                          action:
                            name: internal
                            typed_config:
                              "@type": type.googleapis.com/google.protobuf.StringValue
                              value: internal
                      - ranges:
                        - address_prefix: 0.0.0.0
                        on_match:
                          action:
                            name: tls
                            typed_config:
                              "@type": type.googleapis.com/google.protobuf.StringValue
                              value: tls
```

[config-listeners-listener-filters-tls-inspector]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/tls_inspector#config-listener-filters-tls-inspector
[config-listeners-listener-filters-proxy-protocol]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/proxy_protocol#config-listener-filters-proxy-protocol
[config-listeners-listener-filters-original-destination]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/original_dst_filter#config-listener-filters-original-dst