# 2025-12-08

## Envoy

### 아키텍처 개요

#### 고급

##### 필터 간 데이터 공유

Envoy는 필터로(부터) 뿐만아니라 다른 핵심 서브시스템(e.g., 액세스 로깅)으로 구성, 메타데이터 요청/켜넥션 별 상태 전달을 위해 다음 메커니즘을 제공한다.

###### 동적 상태

동적 상태는 네트워크 커넥션이나 HTTP 스트림별로 생성되는 상태다. 동적 상태는 상태를 생성하는 필터에 의해 필요에 따라 변형될 수 있다.

`Envoy::Network::Connection`과 `Envoy::Http::Filter`는 각각 현재 TCP 커넥션과 HTTP 스트림에 대한 정보를 갖는 `StreamInfo` 객체를 제공한다. `StreamInfo`는 클래스 정의의 일부로 고정된 속성 집합(e.g., HTTP 프로토콜, 요청된 서버 이름 등)을 갖는다. 추가로, 맵(`map<string, FilterState::Object>`)에 타입이 지정된 객체를 저장하는 방법을 제공한다. 필터별로 저장된 상태는 한 번만 쓰이거나(불변) 여러번 쓰일(가변) 수 있다.

동적 메타데이터와 필터 상태 객체에 대한 레퍼런스 목록은 [잘 알려진 동적 메타데이터][config-advanced-well-known-dynamic-metadata]와 [잘 알려진 필터 상태][config-advanced-well-known-filter-state-metadata]를 참고하라.

**필터 상태 공유**

필터 상태 객체는 연관된 부모 스트림의 수명에 묶여있다. 하지만 생성 도중에 다운스트림 객체를 생성 도중에 업스트림 커넥션과 공유될 수 있는 것으로 표시함으로써 객체가 업스트림 커넥션 필터 상태와 공유되며 수명은 원본 스트림 이상으로 확장된다. 모든 업스트림 TCP와 HTTP 필터는 공유 객체에 접근할 수 있다. 업스트림 전송 소켓도 공유 객체를 읽고 업스트림 전송 생성을 커스터마이즈할 수 있다. 예를 들어, [내부 업스트림 전송 소켓][api-extensions-transport-sockets-internal-upstream-transport]은 공유 객체에 대한 참조를 내부 커넥션 다운스트림 필터 상태로 복사한다.

업스트림과 공유될 수 있는 필터 상태 객체는 해싱 인터페이스를 구현한 경우 커넥션 풀링 결정에도 영향을 줄 수 있다. 공유되는 해시 가능한 객체가 추가되면 각각의 개별 해시 값에 대한 업스트림 커넥션이 생성돼 이 객체들이 같은 업스트림 커넥션에 대한 후속 다운스트림 요청들에 의해 덮어씌워지지 않도록 한다. 예를 들어, 커스텀 HTTP 필터는 특수 헤더로부터 해시 가능한 공유 객체를 생성할 수 있다. 이 경우 각 특수 헤더 값에 대해 각각 업스트림 커넥션이 생성돼 서로 다른 헤더 값에 대한 두 요청이 업스트림 커넥션을 공유하지 않도록 한다. 같은 절차가 공유되는 해시 가능한 객체에도 각각 적용돼 객체 값의 개별 조합 별 업스트리 커넥션의 조합 행렬을 만든다.

[config-advanced-well-known-dynamic-metadata]: https://www.envoyproxy.io/docs/envoy/latest/configuration/advanced/well_known_dynamic_metadata#well-known-dynamic-metadata
[config-advanced-well-known-filter-state-metadata]: https://www.envoyproxy.io/docs/envoy/latest/configuration/advanced/well_known_filter_state#well-known-filter-state
[api-extensions-transport-sockets-internal-upstream-transport]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/internal_upstream/v3/internal_upstream.proto#envoy-v3-api-msg-extensions-transport-sockets-internal-upstream-v3-internalupstreamtransport
