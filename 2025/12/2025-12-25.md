# 2025-12-25

## Envoy

### 아키텍처 개요

#### 고급

##### 제네릭 일치

###### 일치 트리 유효성 검증

일치 트리 구조는 매우 유연하므로 일부 필터는 사용할 수 있는 트리의 유형을 제한해야 할 수 있다. 이 시스템은 제입력 소스를 특정 집합으로 제한하는 것만 지원해 현재로서는 약간 덜 유연하다. 예를 들어, 필터는 자신이 요청 헤더로만 동작한다고 명시할 수 있다. 이 경우 요청 트레일러나 응답 헤더에 일치시키려고 시도하는 일치 트리는 구성 로드 과정에서 실패하고 어느 입력 데이터가 유효하지 않은지 보고한다.

이는 [앞선 섹션][arch-advanced-generic-matching-http-filter-iteration-impact]에서 이야기한 문제를 제한하거나 사용자가 특정 필터에 대해 일치 트리가 사용될 수 있는 컨텍스트를 이해하는 것을 돕기 위해 수행된다. 현재 유효성 검증 프레임워크의 한계로 인해 모든 필터에서 사용되지는 않는다.

HTTP 필터의 경우 제한 사항이 필터 구현에 의해 명시되므로 제한 사항이 있는지 이해하려면 개별 필터 문서를 참고하라.

예를 들어, 아래 예시에서 일치트리를 [HttpRequestHeaderMatchInput][api-types-common-http-inputs-http-request-header-match-input]만 사용하도록 제한하는 필터는 일치 트리와 함께 쓰일 수 없다.

```yaml
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    listener_filters:
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: with-matcher
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.common.matching.v3.ExtensionWithMatcher
              extension_config:
                name: envoy.filters.http.fault
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
                  abort:
                    http_status: 503
                    percentage:
                      numerator: 0
                      denominator: HUNDRED
                  delay:
                    fixed_delay: 3s
                    percentage:
                      numerator: 0
                      denominator: HUNDRED
              xds_matcher:
                matcher_list:
                  matchers:
                  - predicate:
                      or_matcher:
                        predicate:
                        - single_predicate:
                            input:
                              name: request-headers
                              typed_config:
                                "@type": type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput
                                header_name: request-header
                            value_match:
                              exact: foo
                        - single_predicate:
                            input:
                              name: request-headers
                              typed_config:
                                "@type": type.googleapis.com/envoy.type.matcher.v3.HttpResponseHeaderMatchInput
                                header_name: response-header
                            value_match:
                              exact: bar
                    on_match:
                      action:
                        name: skip
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.common.matcher.action.v3.SkipFilter
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          route_config:
            virtual_hosts:
            - name: default
              domains: ["*"]
              routes:
              - match: {prefix: "/"}
                route:
                  cluster: service_foo
  clusters:
  - name: service_foo
    load_assignment:
      cluster_name: some_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8080
```

[arch-advanced-generic-matching-http-filter-iteration-impact]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/advanced/matching/matching_api#arch-overview-matching-api-iteration-impact
[api-types-common-http-inputs-http-request-header-match-input]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/type/matcher/v3/http_inputs.proto#envoy-v3-api-msg-type-matcher-v3-httprequestheadermatchinput
