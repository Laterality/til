# 2025-12-05

## Envoy

### 아키텍처 개요

#### 기타 프로토콜

##### Redis

###### 실패 모드

만약 Redis가 오류를 던지면 이를 커맨드 응답으로 전달한다. Envoy는 오류 자료형인 Redis로부터의 응답을 일반적인 응답으로 취급하고 호출자에게 그대로 전달한다.

Envoy는 클라이언트에 고유한 오류를 만들 수도 있다.

| 오류                                         | 의미                                                                                                               |
| -------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| no upstream host                             | 링 해시 로드 밸런서가 키에 대해 선택된 링 위치에 사용 가능한 헬시 호스트를 를 찾지 못했다.                         |
| upstream failure                             | 백엔드가 타임아웃 기간 내에 응답하지 않았거나 커넥션이 닫혔다.                                                     |
| invalid request                              | 자료형이나 길이로 인해 커맨드 스플리터의 첫 번째 단계에서 커맨드가 거부됐다.                                       |
| ERR unknown command                          | Envoy가 커맨드를 인식할 수 없어 백엔드 서버로 해시할 수 없기 때문에 처리할 수 없다.                                |
| finished with n errors                       | 오류를 수신한 경우 응답을 종합하는 파편화된 커맨드(e.g. DEL)가 총 n개의 오류를 반환했다.                           |
| upstream protocol error                      | 파편화된 커맨드가 예기치 못한 자료형을 수신했거나 백엔드가 Redis 프로토콜로 만들 수 없는 응답을 반환했다.          |
| wrong number of arguments for command        | 특정 커맨드는 Envoy에서 인자 수가 올바른지 검사한다.                                                               |
| NOAUTH Authentication required.              | 다운스트림 인증 패스워드나 외부 인증이 설정돼 있고 클라이언트가 성공적으로 인증돼야 하기 때문에 커맨드가 거부됐다. |
| ERR invalid password                         | 유효하지 않은 패스워드로 인해 인증 커맨드가 실패했다.                                                              |
| ERR &lt;external-message&gt;                 | 외부 인증 제공자에서 인증 커맨드가 실패했다.                                                                       |
| ERR Client sent AUTH, but no password is set | 인증 커맨드를 수신했지만 다운스트림 인증이나 외부 인증 제공자가 구성돼 있지 않다.                                  |
| ERR invalid cursor                           | 순회 커맨드가 유효하지 않거나 인식할 수 없는 커서로 인해 실패했다.                                                 |

MGET의 경우, 인출할 수 없는 개별 키는 오류 응답을 만들어낸다. 예를 들어, 다섯 개의 키를 인출했는데 두 개가 백엔드 타임아웃이 발생했다면, 값의 위치에 각각 오류 응답을 얻는다.

```text
$ redis-cli MGET a b c d e
1) "alpha"
2) "bravo"
3) (error) upstream failure
4) (error) upstream failure
5) "echo"
```
