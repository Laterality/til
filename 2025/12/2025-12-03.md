# 2025-12-03

## Envoy

### 아키텍처 개요

#### 기타 프로토콜

##### Redis

###### Redis 클러스터 지원

Envoy는 [Redis 클러스터][redis-cluster-spec]를 지원한다.

Envoy를 Redis 클러스터에 대한 사이드카 프록시로 사용하면, 서비스는 언어와 상관없이 비 클러스터 Redis 클라이언트 구현을 사용해 단일 노드 Redis 인스턴스인 것처럼 프록시에 연결한다. Envoy 프록시는 클러스터 토폴로지를 추적하고 [명세][redis-cluster-spec]에 따라 커맨드를 클러스터의 올바른 Redis 노드로 보낸다. 레플리카로부터 읽기와 같은 고급 기능 또한 각 언어의 클라이언트를 업데이트하는 대신 Envoy 프록시에 추가할 수 있다.

Envoy 프록시는 주기적으로 [cluster slots][redis-commands-cluster-slots] 커맨드를 클러스터의 무작위 노드에 보내 클러스터 토폴로지를 추적하고 다음 정보를 유지한다:

- 알려진 노드 목록
- 각 샤드의 프라이머리
- 클러스터의 노드 유입/방출

Envoy 프록시는 `cluster slots` 커맨드 응답의 IP 주소와 호스트네임 둘 다를 사용한 노드 식별을 지원한다. 프라이머리 호스트네임 리졸브에 실패한 경우 Envoy는 성공할 때까지 주기적으로 모든 노드의 리졸브를 재시도한다. 레플리카에 대한 리졸브 실패는 건너뛴다. 반면, [enable_redirection][api-extensions-filters-conn-pool-settings-enable-redirection] 옵션이 설정돼 있고 호스트네임이 포함된 MOVED 또는 ASK 응답을 수신하면 Envoy는 DNS 조회를 자동으로 수행하지 않고 오류를 그대로 클라이언트로 전파한다. Envoy가 DNS를 조회해 리다이렉션을 따라가도록 하려면 커넥션 풀 설정의 DNS 캐시 옵션 [dns_cache_config][api-extensions-filters-conn-pool-settings-dns-cache-config]을 구성해야 한다. 리다이렉션에 대한 DNS 조회를 활성화하는 구성 예시는 필터 [구성 레퍼런스][config-listeners-network-filters-redis-proxy]를 참고하라.

토폴로지 구성 상세 내용은 Redis 클러스터 [v3 API 레퍼런스][api-extensions-cluster-redis-cluster-config]를 참고하라.

모든 Redis 클러스터는 *cluster.\<name>.redis_cluster.*로 시작하는 고유한 부가 통계를 갖는다:

| 이름                                     | 유형      | 설명                                                                                                                                         |
| ---------------------------------------- | --------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| max_upstream_unknown_connections_reached | Counter   | 리다이렉션이 커넥션 풀의 max_upstream_unkown_connections 제한에 도달한 뒤 알려지지 않은 호스트로의 업스트림 커넥션이 만들어지지 않은 총 횟수 |
| upstream_cx_drained                      | Counter   | 활성 요청의 업스트림 커넥션이 닫히기 전에 드레인된 총 횟수                                                                                   |
| upstream_commands.upstream_rq_time       | Histogram | 모든 유형의 요청에 대한 업스트림 요청 시간 히스토그램                                                                                        |

클러스터별 커맨드 통계는 [enable_command_stats][api-extensions-filters-conn-pool-settings-enable-command-stats]를 설정해 활성화할 수 있다:

| 이름                                | 유형      | 설명                                                |
| ----------------------------------- | --------- | --------------------------------------------------- |
| upstream_commands.[command].success | Counter   | 특정 Redis 커맨드에 대한 총 성공 요청 수            |
| upstream_commands.[command].failure | Counter   | 특정 Redis 커맨드에 대한 총 실패 또는 취소 요청 수  |
| upstream_commands.[command].total   | Counter   | 특정 Redis 커맨드에 대한 총 요청 수(성공과 실패 합) |
| upstream_commands.[command].latency | Histogram | 특정 Redis 커맨드에 대한 요청 지연                  |


[redis-cluster-spec]: https://redis.io/docs/latest/operate/oss_and_stack/reference/cluster-spec/
[redis-commands-cluster-slots]: https://redis.io/docs/latest/commands/cluster-slots/
[api-extensions-filters-conn-pool-settings-enable-redirection]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/redis_proxy/v3/redis_proxy.proto#envoy-v3-api-field-extensions-filters-network-redis-proxy-v3-redisproxy-connpoolsettings-enable-redirection
[api-extensions-filters-conn-pool-settings-dns-cache-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/redis_proxy/v3/redis_proxy.proto#envoy-v3-api-field-extensions-filters-network-redis-proxy-v3-redisproxy-connpoolsettings-dns-cache-config
[config-listeners-network-filters-redis-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/redis_proxy_filter#config-network-filters-redis-proxy
[api-extensions-cluster-redis-cluster-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/clusters/redis/v3/redis_cluster.proto#envoy-v3-api-msg-extensions-clusters-redis-v3-redisclusterconfig
[api-extensions-filters-conn-pool-settings-enable-command-stats]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/redis_proxy/v3/redis_proxy.proto#envoy-v3-api-field-extensions-filters-network-redis-proxy-v3-redisproxy-connpoolsettings-enable-command-stats
