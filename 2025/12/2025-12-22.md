# 2025-12-22

## Envoy

### 아키텍처 개요

#### 고급

##### 제네릭 일치

###### 일치 API

**필터 통합**

지원되는 환경(현재는 HTTP 필터뿐이다)에서는 래퍼 proto를 사용해 래핑되는 구조와 연관된 일치 필터를 인스턴스화할 수 있다:

```yaml
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    listener_filters:
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: with-matcher
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.common.matching.v3.ExtensionWithMatcher
              extension_config:
                name: envoy.filters.http.fault
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
                  abort:
                    http_status: 503
                    percentage:
                      numerator: 0
                      denominator: HUNDRED
                  delay:
                    fixed_delay: 3s
                    percentage:
                      numerator: 0
                      denominator: HUNDRED
              xds_matcher:
                matcher_tree:
                  input:
                    name: request-headers
                    typed_config:
                      "@type": type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput
                      header_name: some-header
                  exact_match_map:
                    # Note this additional indirection; this is a workaround for Protobuf oneof limitations.
                    map:
                      some_value_to_match_on:  # This is the header value we're trying to match against.
                        action:
                          name: skip
                          typed_config:
                            "@type": type.googleapis.com/envoy.extensions.filters.common.matcher.action.v3.SkipFilter
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          route_config:
            virtual_hosts:
            - name: default
              domains: ["*"]
              routes:
              - match: {prefix: "/"}
                route:
                  cluster: service_foo
  clusters:
  - name: service_foo
    load_assignment:
      cluster_name: some_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8080
```

위의 예시는 [ExtensioWithMatcher][api-common-extension-matcher-extension-with-matcher] 안에 HTTP 필터([HTTPFault][api-extensions-filters-http-fault] 필터)를 래핑해 래핑된 필터의 평가와 조합해 평가되는 일치 트리를 정의할 수 있게 한다. 데이터가 필터에서 사용 가능해지기 전에 일치 트리에 전달되고 일치 트리는 전달된 데이터로 일치 규칙을 평가하려고 시도하고 일치 펴가 결과가 동작으로 나타나면 동작을 트리거한다.

위 예시에서는 `input`을 [HttpRequestHeaderMatchInput][api-types-common-http-inputs-http-request-header-match-input]로 설정하고 사용할 헤더 키를 구성해 인입 요청 헤더 `some-heaer`를 일치시키고자 한다고 명시하고 있다. 이 헤더 포함된 값을 사용해 제공된 `exact_match_map`은 신경쓰는 값을 명시한다. 단일 값(`some_value_to_match_on`)을 일치시킬 기준으로 설정했다. 결과적으로 이 구성은 `some-header: some_value_to_match_on`이 헤더로 포함된 요청을 수신하면 [SkipFilter][api-common-common-match-actions-skip-filter] 동작이 리졸브됨(연관된 HTTP 필터을 건너뜀)을 의미한다. 이러한 헤더가 존재하지 않을 경우 아무런 동작도 리졸브되지 않고 필터는 평소처럼 적용된다.

```yaml
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    listener_filters:
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          http_filters:
          - name: with-matcher
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.common.matching.v3.ExtensionWithMatcher
              extension_config:
                name: envoy.filters.http.fault
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
                  abort:
                    http_status: 503
                    percentage:
                      numerator: 0
                      denominator: HUNDRED
                  delay:
                    fixed_delay: 3s
                    percentage:
                      numerator: 0
                      denominator: HUNDRED
              xds_matcher:
                # The top level matcher is a matcher tree which conceptually selects one of several subtrees.
                matcher_tree:
                  input:
                    name: request-headers
                    typed_config:
                      "@type": type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput
                      header_name: some-header
                  exact_match_map:
                    # Note this additional indirection; this is a workaround for Protobuf oneof limitations.
                    map:
                      some_value_to_match_on:  # This is the header value we're trying to match against.
                        # The OnMatch resulting on matching with this branch of the exact matcher is another matcher,
                        # allowing for recursive matching.
                        matcher:
                          # The inner matcher is a matcher list, which attempts to match a list of predicates.
                          matcher_list:
                            matchers:
                            - predicate:
                                or_matcher:
                                  predicate:
                                  - single_predicate:
                                      input:
                                        name: request-headers
                                        typed_config:
                                          "@type": type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput
                                          header_name: second-header
                                      value_match:
                                        exact: foo
                                  - single_predicate:
                                      input:
                                        name: request-headers
                                        typed_config:
                                          "@type": type.googleapis.com/envoy.type.matcher.v3.HttpRequestHeaderMatchInput
                                          header_name: second-header
                                      value_match:
                                        exact: bar
                              on_match:
                                action:
                                  name: skip
                                  typed_config:
                                    "@type": type.googleapis.com/envoy.extensions.filters.common.matcher.action.v3.SkipFilter
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          route_config:
            virtual_hosts:
            - name: default
              domains: ["*"]
              routes:
              - match: {prefix: "/"}
                route:
                  cluster: service_foo
  clusters:
  - name: service_foo
    load_assignment:
      cluster_name: some_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8080
```

위는 좀 더 복잡한 예시로, 최상위 수준 트리 일치자를 선형 일치자와 조합한다. 트리 일치자는 매우 효율적인 일치를 제공하지만 표현력이 풍부하진 않다. 리스트 일치자는 더 풍부한 일치 API를 제공하는 데 쓰일 수 있고 임의의 순서로 트리 일치자와 조합할 수 있다. 예시는 다음 일치 로직을 설명한다: `some-header: skip_filter`가 존재하고 `second-header`가 `foo`나 `bar` *중 하나로* 설정돼 있으면 건너뛴다.

**HTTP 필터 순회 영향**

위 예시는 요청 헤더에 대한 일치만 보여주는데, 연관된 필터가 어떤 데이터도 수신하기 전에 일어나는 일이기 때문에 매우 단순한다. 다른 HTTP 입력 소스에 대한 일치는 지원되지만 필터 수준에서 어떻게 동작하는지는 일부 논의가 필요하다.

현재 HTTP 필터에 대한 일치 평가는 제어 흐름에 전혀 영향을 끼치지 않는다. 사용 가능한 데이터가 일치를 수행하기에 충분하지 않다면 연관된 평소처럼 연관된 필터로 콜백이 보내진다. 동작 일치 여부를 확인하기에 충분한 데이터가 사용 가능하면 이것이 필터로 전달된다. 이로 인해 필터가 일치 결과에 따라 특정 동작을 제한하려는 경우 스스로 순회를 멈춰도록 관리해야 한다.

[SkipFilter][api-common-common-match-actions-skip-filter]와 같은 동작이 함께 있으면 이는 건너뜀 조건이 요청 헤더를 제외한 모든 것이라는 의미로 필터는 부분적으로 적용돼 예상치 못한 동작으로 이어질 수 있다. 한 가지 예시는 응답 헤더를 기반으로 하는 gRPC-Web 필터를 건너뛰려고 시도하는 일치 트리를 갖는 것이다. 클라이언트는 gRPC-Web 요청을 Envoy로 보내면 이를 업스트림으로 프록시하기 전에 필터가 이를 gRPC 요청으로 변환하고 인코딩 경로에서 gRPC-Web 응답을 반환할 것으로 가정한다. 응답 헤더에 따라 필터를 건너뛰면 포워드 변환은 발생(업스트림은 gRPC 요청을 수신)하지만 응답은 gRPC-Web으로 변환되지 않는다. 결과적으로 클라이언트는 유효하지 않은 응답을 Envoy로부터 받을 것이다. 건너뜀 동작이 트레일러에 대해 리졸브된 경우 동일한 gRPC-Web 필터가 모든 데이터를 소비하지만 이를 다시 쓰지(write)는 않으므로 gRPC-Web 응답의 본문이 비게 될 것이다.

[api-common-extension-matcher-extension-with-matcher]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/common/matching/v3/extension_matcher.proto#envoy-v3-api-msg-extensions-common-matching-v3-extensionwithmatcher
[api-extensions-filters-http-fault]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/fault/v3/fault.proto#envoy-v3-api-msg-extensions-filters-http-fault-v3-httpfault
[api-types-common-http-inputs-http-request-header-match-input]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/type/matcher/v3/http_inputs.proto#envoy-v3-api-msg-type-matcher-v3-httprequestheadermatchinput
[api-common-common-match-actions-skip-filter]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/common/matcher/action/v3/skip_action.proto#envoy-v3-api-msg-extensions-filters-common-matcher-action-v3-skipfilter