# 2025-12-30

## Envoy

### 아키텍처 개요

#### 고급

##### Wasm

###### 필터를 위한 실행 모델

Wasm 모듈은 런타임에 ABI에 의해 정의된 대로 여러 스트림 콜백을 통해 워커 스레드에서 인라인으로 실행된다. 워커 스레드는 독립적으로 동작하며 Wasm 실행 인스턴스와 자신의 런타임 메모리를 공유하지 않는다. 비동기 또는 블로킹 작업은 Envoy에 위임되며 완료되면 Envoy가 플러그인의 완료 콜백을 호출한다.

구성 시점에 Wasm 모듈은 메인 스레드의 Wasm 엔진으로 로드된다. 모듈 바이너리와 [vm_id][api-extensions-wasm-vm-config-vm-id] 필드 값의 조합별로 별도의 Wasm 실행 인스턴스가 생성된다. 인스턴스는 콜백을 통해 각 플러그인에 대한 Wasm 구성을 수신하는데, Wasm 필터를 캡슐화하는 xDS 리스너마다 반복적으로 수신할 수 있다. 콜백이 구성을 수락하면 메인 실행 인스턴스는 각 워커 스레드로 복제된다.

이 구성 모델은 Wasm 필터와는 구분된다는 점을 알아두라. 각 xDS 리스너마다 독립적으로 인스턴스가 생성되는 일반적인 HTTP 필터와 달리, xDS 리스터는 같은 메인 Wasm 실행 인스턴스를 xDS 갱신 사이에 공유한다.

[api-extensions-wasm-vm-config-vm-id]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/wasm/v3/wasm.proto#envoy-v3-api-field-extensions-wasm-v3-vmconfig-vm-id
