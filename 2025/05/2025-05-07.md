# 2025. 05. 07.

## Reactor 3 Reference Guide

### 고급 기능과 개념

#### 정리가 필요한 객체 처리

#### 1. `onDiscard` 연산자 또는 지역 훅

이 훅은 사용자 코드에 노출되지 않은 객체를 정리한다는 구체적인 목적을 가지고 있다. (너무 많은 항목을 푸시해 `onNextDropped`에서 처리되는 오동작 소스가 아닌)일반적인 상황에서 동작하는 흐름을 위한 정리 훅으로 만들어졌다.

연산자를 통해 활성화되고 주어진 `Flux`나 `Mono`에 대해서만 적용한다는 점에서 지역적이다.

분명한 사례 중 하나는 업스트림의 요소를 필터링하는 연산자들이다. 이 요소들은 다음 연산자(또는 최종 구독자)에 도달하지 않지만 이는 정상적인 실행 경로의 일부이다. 이러한 경우 `doOnDiscard` 훅으로 전달된다. `doOnDiscard` 훅을 사용해야 할 만한 상황의 예시는 다음과 같다:

* `filter`: 필터에 일치하지 않는 항목들은 "폐기된"(discarded) 것으로 간주된다.
* `skip`: 건너뛴 항목들은 폐기된다.
* `maxSize < skip`인 `buffer(maxSize, skip)`: "드로핑 버퍼"(dropping buffer), 버퍼 사이의 항목들은 폐기된다.

하지만 `doOnDiscard`는 필터링 연산자로만 제한되지 않으며 배압을 위해 데이터를 내부 큐에 넣는 연산자에서도 쓰인다. 더 구체적으로, 대부분의 경우 취소(cancellation)시에 중요하다. 소스에서 데이터를 사전 인출(prefetch)한 뒤 구독자의 요구에 따라 내보내는 연산자는 취소됐을 경우 방출되지 않은 데이터를 가질 수 있다. 이러한 연산자들은 취소시 `doOnDiscard` 훅을 사용해 내부 배압 `Queue`를 정리한다.

> [!WARNING]
>
> 각각의 `doOnDiscard(Class, Consumer)`는 다른 것들과 누적되며 자신의 업스트림 연산자에서만 보이고 쓰일 수 있다.

