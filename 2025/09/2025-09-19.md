# 2025-09-19

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드 밸런싱 정책

확장 가능한 로드 밸런싱 정책들은 각 클러스터별로 [구성][api-clusters-cluster-configuration-cluster-load-balancing-policy]할 수 있다. [API][api-extensions-load-balancing-policies]를 통해서도 가능하다.

개발자들은 C++로 구성 가능한 커스텀 정책을 구현할 수 있다.

비동기 로드 밸런싱은 이제 HTTP 요청에 대해 알파 단계이다. TCP 프록싱, Redis 등에는 아직 지원되지 않는다. 비동기 로드 밸런싱은 C++ API를 추가해 C++ chooseHost가 비동기가 될 수 있게 하고 호스트 선택을 위임해 사이드카와 협의하거나 DNS 리졸루션 등을 수행할 수 있게 한다.

HTTP에 대한 비동기 로드 밸런싱에 알려진 다른 제한사항은 비동기 클라이언트는 현재 본문 데이터를 처리하지 않는다는 것이다. 즉, xDS 요청에는 동작하지 않으며 본문이 있는 스트리밍 미러링된 요청에 반드시 동작하지 않는다. 만약 미러링된 요청에 대한 호스트가 선택되기 전에 최초 요청에 대한 호스트와 본문 모두 도착하면 본문은 버퍼링되지 않고 스트림을 리셋한다.

서브셋 로드 밸런서는 현재 비동기로 동작하는 내부 로드 밸런서을 지원하지 않는다.

> [!NOTE]
>
> 과거에는 Envoy가 [enum][api-clusters-cluster-configuration-cluster-lb-policy]을 사용해 로드 밸런싱 정책을 지정했다. 이 `enum`은 하위 호환을 위해 여전히 지원되지만 폐기(deprecated)됐다.
>
> [확장 가능한 로드 밸런싱 정책][api-extensions-load-balancing-policies]을 대신 사용해야 한다.

[무작위 로드 밸런싱 정책][api-extensions-load-balancing-policies-randomj-load-balancing-policy]을 예시로 보자:

```yaml
name: example_cluster
type: STRICT_DNS
connect_timeout: 0.25s
load_assignment:
  cluster_name: example_cluster
  endpoints:
  - lb_endpoints:
    - endpoint:
        address:
          socket_address:
            address: example.com
            port_value: 80
load_balancing_policy:
  policies:
  - typed_extension_config:
      name: envoy.load_balancing_policies.random
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.load_balancing_policies.random.v3.Random

```

[api-clusters-cluster-configuration-cluster-load-balancing-policy]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-load-balancing-policy
[api-extensions-load-balancing-policies]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/load_balancing_policies/load_balancing_policies#envoy-v3-api-config-load-balancer-policies
[api-clusters-cluster-configuration-cluster-lb-policy]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-lb-policy
[api-extensions-load-balancing-policies-randomj-load-balancing-policy]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/load_balancing_policies/random/v3/random.proto#envoy-v3-api-msg-extensions-load-balancing-policies-random-v3-random
