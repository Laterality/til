# 2025-09-20

## Envoy

### 아키텍처 개요

#### 관측성

##### 통계

Envoy의 주요 목표 중 하나는 네트워크를 이해할 수 있게 만드는 것이다. Envoy는 구성된 형태에 따라 다양한 통계를 만들어낸다. 일반적으로 이 통계들은 세 가지 유형에 속한다:

* **다운스트림**: 인입 커넥션/요청과 관련된 다운스트림 통계. 리스너, HTTP 커넥션 관리자, TCP 프록시 필터 등에 의해 만들어진다.
* **업스트림**: 유출 커넥션/요청과 관련된 업스트림 통계. 커넥션 풀, 라우터 필터, TCP 프로시 필터 등에 의해 만들어진다.
* **서버**: Envoy 서버 인스턴스가 어떻게 동작하고 있는지 설명하는 서버 통계. 서버 업타임이나 할당된 메모리 크기 등이 여기에 속한다.

단일 프록시 시나리오에는 주로 다운스트림과 업스트림 통계 모두 동반한다. 두 타입은 특정 네트워크 홉에 대한 상세한 그림을 얻는 데 쓰일 수 있다. 전체 메시로부터의 통계는 각 홉의 매우 자세한 그림과 전체 네트워크 헬스를 보여준다. 만들어지는 통계들은 운영 가이드에 자세히 문서화돼있다.

v2 API에서 Envoy는 커스텀, 플러그 가능한(pluggable) 싱크(sink)를 지원할 수 있는 능력을 갖추게 됐다. [소수의 표준 싱크 구현][api-bootstrap-stats-stats-sink]이 Envoy에 포함돼 있다. 일부 싱크는 태그/차원(dimensions)을 가진 통계를 만들어내는 것을 지원한다.

Envoy 내부와 문서 여러 곳에서 통계는 정식(canonical) 문자열 표현으로 식별된다. 이 문자열의 동적인 부분들은 태그로 스트립(strip)된다. 사용자는 [태그 명시자 구성][api-bootstrap-stats-tag-specifier]을 통해 이 동작을 구성할 수 있다.

Envoy는 세 가지 유형의 값을 통계로 만들어낸다:

* **카운터**: 부호 없는(unsigned) 정수, 증가만 하고 감소는 하지 않는다. E.g., 총 요청.
* **게이지**: 부호 없는 정수, 증가와 감소 둘다 한다. E.g., 현재 활성 요청.
* **히스토그램**: 부호 없는 정수, 값의 스트림의 일부로 이후 컬렉터에 의해 집계돼 궁극적으로는 요약된 백분위 값으로 만들어진다. E.g., 업스트림 요청 시간.

내부적으로 카운터와 게이지는 배치로 수행돼 주기적으로 플러시함으로써 성능을 향상시킨다. 히스토그램은 수신한 즉시 쓰인다(written). 참고: 이전에 타이머로 참조됐던 것들은 히스토그램이 됐다. 두 표현 사이의 유일한 차이점은 단위 유무다.

* [v3 API 레퍼런스][api-bootstrap-bootstrap-stats-sinks]

[api-bootstrap-stats-stats-sink]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/metrics/v3/stats.proto#envoy-v3-api-msg-config-metrics-v3-statssink
[api-bootstrap-stats-tag-specifier]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/metrics/v3/stats.proto#envoy-v3-api-msg-config-metrics-v3-tagspecifier
[api-bootstrap-bootstrap-stats-sinks]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/bootstrap/v3/bootstrap.proto#envoy-v3-api-field-config-bootstrap-v3-bootstrap-stats-sinks
