# 2025-09-04

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 집계 클러스터

###### 집계 클러스터에 대한 중요 고려사항

일부 기능은 집계 클러스터에서 예상대로 동작하지 않을 수 있다. 예를 들어:

**PriorityLoad 재시도 플러그인**

[PriorityLoad 재시도 플러그인][api-http-route-management-retry-policy-retry-priority]은 집계 클러스터에서 동작하지 않는다. 집계 클러스터의 로드 밸런서가 보다 상위 수준에서 트래픽을 제어하기 때문에, 실질적으로 로드 밸런싱 중 PriorityLoad의 동작을 오버라이드한다.

**스테이트풀 세션**

[스테이트풀 세션][api-extensions-filters-stateful-session]은 클러스터에 의존해 트래픽을 받고 있는 엔드포인트를 직접 알고 있다. 집계 클러스터에서는 최상위 수준 로드 밸런서가 먼저 클러스터를 선택하지만 클러스터 내의 특정 엔드포인트는 추적하지 않는다.

만약 스테이트풀 세션을 구성해 업스트림 클러스터를 오버라이드하면, 로드 밸런서는 자신의 알고리즘을 우회해 해당 호스트로 직접 트래픽을 보낸다. 이는 클러스터 자체가 정확한 엔드포인트를 알고 있을 때만 동작한다. 

집계 클러스터에서는 최종 라우팅 결정이 집계 클러스터 바로 아래의 한 계층에서 일어나므로 필터는 집계 수준에 특정 엔드포인트를 위치시킬 수 없다. 최종 클러스터 선택은 최상위 수준에는 존재하지 않는 특정 엔드포인트에 대한 지식 없이 이루어지므로 결국 스테이트풀 세션은 집계 클러스터와 호환되지 않는다.

**서킷 브레이커**

일반적으로 집계 클러스터는 집계 클러스터 자체의 수준이 아니라 하위 클러스터에서 처리되는 서킷 브레이킹이 아닌 로드 밸런싱만을 목적으로 하위 클러스터들의 엔드포인트들을 모은 그룹으로 볼 수 있다. 이는 집계 클러스터가 각 하위 클러스터의 서킷 브레이커 제한을 존중하면서 자신의 페일오버 능력을 유지할 수 있께 한다. 하위 클러스터들을 여러 경로로 접근 가능하고 집계 클러스터 서킷 브레이커를 구성하는 것은 결과적으로 쓸모없이 서킷 브레이커를 이중으로 만드는 것이 되기 때문에 이는 의도적이다.

구성된 제한이 하위 클러스터에 도달하면, 하위 클러스터의 서킷 브레이커만 열린다. 하위  클러스터의 서킷 브레이커가 열리면 집계 클러스터를 통해 해당 하위 클러스터로 라우팅되는 요청은 거부될 것이다. 하위 클러스터의 서킷 브레이커 제한에 도달했는지 여부와 관계없이 집계 클러스터의 서킷 브레이커는 계속 닫힌 상태다.

예외로, Envoy가 재시도 요청을 처리할 때는 집계 클러스터가 사용할 하위 클러스터 선택할 수 있게 되기 전에 재시도 제한이 초과됐는지를 결정해야 하므로 집계 클러스터 수준에 구성된 서킷 브레이커는 [max_retries][api-clusters-circuit-breakers-thresholds-max-retries] 뿐이다. 구성된 제한이 집계 클러스터의 서킷 브레이커 개방에 도달하면 하위 클러스터의 재시도 예산이 남아있더라도 해당 클러스터 경로로의 후속 요청은 재시도할 수 없다.

[api-http-route-management-retry-policy-retry-priority]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-field-config-route-v3-retrypolicy-retry-priority
[api-extensions-filters-stateful-session]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/stateful_session/v3/stateful_session.proto#envoy-v3-api-msg-extensions-filters-http-stateful-session-v3-statefulsession
[api-clusters-circuit-breakers-thresholds-max-retries]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/circuit_breaker.proto#envoy-v3-api-field-config-cluster-v3-circuitbreakers-thresholds-max-retries
