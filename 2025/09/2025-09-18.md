# 2025-09-18

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 부하 보고 서비스(Load Reporting Service, LRS)

부하 보고 서비스는 Envoy가 일정한 간격으로 관리 서버에 부하 보고를 보낼 수 있는 메커니즘을 제공한다.

이는 관리 서버와 양방향 스트림을 시작한다. 연결 도중 관리 서버는 부하 보고를 받고자 하는 노드에 [LoadStatsResponse][api-services-load-reporting-service-load-stats-response]를 보낼 수 있다. 이 노드에 속한 Envoy는 [LoadStatsRequest][api-services-load-reporting-service-load-stats-request]를 보내기 시작한다. 이 작업은 [부하 보고 간격][api-services-load-reporting-service-load-stats-response-load-reporting-interval]에 따라 주기적으로 이뤄진다.

LRS를 사용하는 Envoy 구성 예시:

```yaml
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 80
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          codec_type: AUTO
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: service
              domains:
              - "*"
              routes:
              - match:
                  prefix: "/service"
                route:
                  cluster: local_service
          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  clusters:
  - name: local_service
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: local_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: http_service
                port_value: 8080
  - name: load_reporting_cluster
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
    load_assignment:
      cluster_name: load_reporting_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: lrs_server
                port_value: 18000
cluster_manager:
  load_stats_config:
    api_type: GRPC
    grpc_services:
    - envoy_grpc:
        cluster_name: load_reporting_cluster
admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8081
```

[api-services-load-reporting-service-load-stats-response]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/load_stats/v3/lrs.proto#envoy-v3-api-msg-service-load-stats-v3-loadstatsresponse
[api-services-load-reporting-service-load-stats-request]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/load_stats/v3/lrs.proto#envoy-v3-api-msg-service-load-stats-v3-loadstatsrequest
[api-services-load-reporting-service-load-stats-response-load-reporting-interval]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/service/load_stats/v3/lrs.proto#envoy-v3-api-field-service-load-stats-v3-loadstatsresponse-load-reporting-interval
