# 2025-09-29

## Envoy

### 아키텍처 개요

#### 관측성

##### 트레이싱

###### 컨텍스트 전파

Envoy는 메시에서 서비스 간의 통신에 관한 트레이싱 정보를 보고하는 기능을 제공한다. 하지만 호출 흐름 내에의 다양한 프록시에서 생성된 트레이싱 정보 조각들을 서로 연관시키려면 서비스들이 인바운드와 아웃바운드 요청 사이의 특정한 트레이스 컨텍스트를 전파해야 한다.

어떤 트레이싱 제공자를 사용하든 서비스는 [x-request-id][config-http-http-connection-manager-http-header-manipulation-x-request-id]를 전파해 호출된 서비스들이 연관되도록 로깅할 수 있게 한다.

> [!WARN]
>
> Envoy의 요청 ID 구현체는 확장 가능하고 기본적으로 [UuidRequestIdConfig][api-extensions-request-id-uuid-uuid-request-id-config] 구현을 사용한다. 이 확장에 대한 구성은 [HTTP 커넥션 관리자][api-extensions-filters-http-connection-manager-request-id-extension] 필드 내에 전달할 수 있다(예시는 문서 참고). 기본 구현은 요청 ID UUID4를 변형해 최종 트레이스 사유를 UUID로 패킹한다. 이 기능은 [x-request-id][config-http-http-connection-manager-http-header-manipulation-x-request-id] 헤더 문서에 명시된대로 여러 Envoy 플릿(fleet) 사이에서 안정적인 샘플링을 가능케 한다. 하지만 트레이스 사유 패킹은 유지가 필요한 외부에서 생성된 요청 ID를 훼손시킬 수 있다. [pack_trace_reason][api-extensions-request-id-uuid-uuid-request-id-config-pack-trace-reason] 필드를 사용해 이 동작을 비활성화할 수 있지만 안정적인 트레이스 사유 전파와 배포 내의 연관된 기능들도 비활성화하게 된다.

> [!WARN]
>
> Envoy의 샘플링 정책은 기본적으로 [x-request-id][config-http-http-connection-manager-http-header-manipulation-x-request-id]의 값에 의해 결정된다. 하지만 이러한 샘플링 정책은 Envoy 플릿에서만 유효하다. 만약 서비스 프록시가 플릿에 존재하지 않으면 샘플링은 해당 프록시의 정책을 고려하지 않고 수행된다. 이와 같이 여러 서비스 프록시로 구성된 메시들에서는 Envoy의 샘플링 정책을 우회해 트레이스 제공자의 샘플링 정책을 따르는 것이 더 효과적이다. 이는 [use_request_id_for_trace_sampling][api-extensions-request-id-uuid-uuid-request-id-config-use-request-id-for-trace-sampling]을 false로 설정해 할 수 있다.

트레이싱 제공자는 스팬(작업의 논리적인 단위) 사이의 부모/자식 관계를 이해할 수 있게 하기 위해 추가적인 컨텍스트를 필요로 한다. 이는 (OpenTelemetry API를 통한) LightStep이나 Zipkin 트레이서를 서비스에서 직접 사용해 인바운드 요청에서 컨텍스트를 추출해 이를 후속 아웃바운드 요청에 주입할 수 있다. 이 접근 방식은 서비스가 내부적으로 엔드-투-엔드 트레이스를 확인하는 데 유용할 수 있는 완료된 작업을 설명하는 추가적인 스팬을 만들 수 있게 한다.

대안으로 서비스에서 수동으로 트레이스 컨텍스트를 전파할 수 있다:

* LightStep 트레이서를 사용중일 때는 Envoy가 서비스에 의존해 HTTP 요청을 다른 서비스로 보내는 동안 [x-ot-span-context][config-http-http-connection-manager-http-header-manipulation-x-ot-span-context] HTTP 헤더를 전파한다.
* Zipkin 트레이서를 사용중일 때는 Envoy가 서비스에 의존해 B3 HTTP 헤더([x-b3-traceid][config-http-http-connection-manager-http-header-manipulation-x-b3-traceid], [x-b3-spanid][config-http-http-connection-manager-http-header-manipulation-x-b3-spanid], [x-b3-parentspanid][config-http-http-connection-manager-http-header-manipulation-x-b3-parentspanid], [x-b3-sampled][config-http-http-connection-manager-http-header-manipulation-x-b3-sampled], [x-b3-flags][config-http-http-connection-manager-http-header-manipulation-x-b3-flags])를 전파한다. [x-b3-sampled][config-http-http-connection-manager-http-header-manipulation-x-b3-sampled] 헤더 또한 외부 클라이언트에서 제공해 특정 요청에 대한 트레이싱을 활성화/비활성화할 수 있다. 추가로, 더 압축된 형식인 단일 [b3][config-http-http-connection-manager-http-header-manipulation-b3] 헤더 전파 형식이 지원된다.

  Zipkin 트레이서는 상호운용성을 향상시키기 위해 선택사항으로 B3와 W3C 트레이스 컨텍스트 형식을 모두 지원하도록 구성할 수 있다. 이는 [trace_context_option][api-extensions-http-traceers-zipkin-tracer-zipkin-config-trace-context-option] 구성 옵션으로 제어한다. `USE_B3_WITH_W3C_PROPAGATION`을 설정하면 트레이서는:

  * 다운스트림 요청의 경우: 먼저 B3 헤더들로부터 트레이스 컨텍스트를 추출하고 B3 헤더가 존재하지 않으면 W3C 트레이스 헤더([traceparent][config-http-http-connection-manager-http-header-manipulation-traceparent], [tracestate][config-http-http-connection-manager-http-header-manipulation-tracestate])로 폴백한다.
  * 업스트림 요청의 경우: B3와 W3C 트레이스 헤더를 모두 주입해 호환성을 극대화한다.

  이 옵션(`USE_B3`)은 기본적으로 비활성화돼 추출과 주입에 B3 헤더만 사용해 하위 호환성을 유지한다.

* Datadog 트레이서를 사용중일 때는 Envoy가 서비스에 의존해 Datadog 특화 HTTP 헤더([x-datadog-trace-id][config-http-http-connection-manager-http-header-manipulation-x-datadog-trace-id], [x-datadog-parent-id][config-http-http-connection-manager-http-header-manipulation-x-datadog-parent-id], [x-datadog-sampling-priority][config-http-http-connection-manager-http-header-manipulation-x-datadog-sampling-priority])를 전파한다.
* SkyWalking 트레이서를 사용중일 때는 Envoy가 서비스에 의존해 SkyWalking 특화 HTTP 헤더([sw8][config-http-http-connection-manager-http-header-manipulation-sw8])을 전파한다.
* AWS X-Ray 트레이서를 사용중일 때는 Envoy가 서비스에 의존해 X-Ray 특화 헤더([x-amzn-trace-id][config-http-http-connection-manager-http-header-manipulation-x-amzn-trace-id])를 전파한다.

[config-http-http-connection-manager-http-header-manipulation-x-request-id]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-request-id
[api-extensions-request-id-uuid-uuid-request-id-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/request_id/uuid/v3/uuid.proto#envoy-v3-api-msg-extensions-request-id-uuid-v3-uuidrequestidconfig
[api-extensions-filters-http-connection-manager-request-id-extension]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-request-id-extension
[api-extensions-request-id-uuid-uuid-request-id-config-pack-trace-reason]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/request_id/uuid/v3/uuid.proto#envoy-v3-api-field-extensions-request-id-uuid-v3-uuidrequestidconfig-pack-trace-reason
[api-extensions-request-id-uuid-uuid-request-id-config-use-request-id-for-trace-sampling]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/request_id/uuid/v3/uuid.proto#envoy-v3-api-field-extensions-request-id-uuid-v3-uuidrequestidconfig-use-request-id-for-trace-sampling
[config-http-http-connection-manager-http-header-manipulation-x-ot-span-context]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-ot-span-context
[config-http-http-connection-manager-http-header-manipulation-x-b3-traceid]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-b3-traceid
[config-http-http-connection-manager-http-header-manipulation-x-b3-spanid]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-b3-spanid
[config-http-http-connection-manager-http-header-manipulation-x-b3-parentspanid]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-b3-parentspanid
[config-http-http-connection-manager-http-header-manipulation-x-b3-sampled]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-b3-sampled
[config-http-http-connection-manager-http-header-manipulation-x-b3-flags]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-b3-flags
[config-http-http-connection-manager-http-header-manipulation-b3]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-b3
[api-extensions-http-traceers-zipkin-tracer-zipkin-config-trace-context-option]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/trace/v3/zipkin.proto#envoy-v3-api-field-config-trace-v3-zipkinconfig-trace-context-option
[config-http-http-connection-manager-http-header-manipulation-traceparent]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-traceparent
[config-http-http-connection-manager-http-header-manipulation-tracestate]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-tracestate
[config-http-http-connection-manager-http-header-manipulation-x-datadog-trace-id]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-datadog-trace-id
[config-http-http-connection-manager-http-header-manipulation-x-datadog-parent-id]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-datadog-parent-id
[config-http-http-connection-manager-http-header-manipulation-x-datadog-sampling-priority]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-datadog-sampling-priority
[config-http-http-connection-manager-http-header-manipulation-sw8]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-sw8
[config-http-http-connection-manager-http-header-manipulation-x-amzn-trace-id]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-amzn-trace-id