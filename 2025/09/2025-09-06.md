# 2025-09-06

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 아웃라이어 감지

아웃라이어 감지와 방출(ejection)은 업스트림 클러스터의 일부 호스트가 다른 호스트와 다르게 동작하는지 동적으로 결정하고 이들을 헬시 [로드 밸런싱][arch-upstream-clusters-load-balancing-overview] 셋에서 제거하는 과정이다. 연속적인 실패, 일시적인 성공율, 일시적인 지연 등 성능에는 여러 축이 있다. 아웃라이어 감지는 *수동적* 헬스 체크의 한 형태다. Envoy는 [능동적 헬스 체크][arch-upstream-clusters-health-checking]도 지원한다. *수동적*과 *능동적* 헬스 체크는 함께 혹은 독립적으로 활성화할 수 있으며 업스트림 헬스 체크를 위한 토대를 형성한다. 아웃라이어 감지는 [클러스터 구성][api-clusters-outlier-detection]의 일부이며 오류, 타임아웃, 리셋을 보고하는 필터가 필요하다. 현재, 다음 필터가 아웃라이어 감지를 지원한다: [http 라우터][config-http-http-filters-router], [tcp 프록시][config-listeners-network-filters-tcp-proxy], [redis 프록시][config-listeners-network-filters-redis-proxy], [thrift 프록시][config-listeners-network-filters-thrift-proxy].

감지된 오류 실패는 외부와 내부에서 발생한 오류 두 유형으로 나뉜다. 외부에서 만들어진 오류는 트랜잭션에 특정돼 있으며 업스트림 서버에서 수신산 효청에 대한 응답으로 발생한다. 예를 들어, HTTP 서버가 오류 코드 500을 반환하거나 redis 서버가 디코드할 수 없는 페이로드를 반환하는 경우가 있다. 이러한 오류들은 Envoy가 성공적으로 연결한 이후 업스트림 호스트에서 만들어진 것이다. 지역적으로 유래한 오류는 업스트림 호스트와의 통신을 방해받거나 막힌 이벤트에 대한 응답으로 Envoy가 만들어낸다. 지역적으로 유래한 오류의 예시로는 타임아웃, TCP 리셋, 특정 포트로 연결 불가 등이 있다.

감지된 오류의 유형은 필터 유형에 따라 다르다. 예를 들어, [http 라우터][config-http-http-filters-router] 필터는 지역적으로 유래한 오류(타임아웃, 리셋 - 업스트림 호스트와의 연결과 관련된 오류들)을 탐지하고 HTTP 프로토콜을 이해할 수 있기 때문에 HTTP 서버가 반환한 오류(외부에서 만들어진 오류)도 보고한다. 이러한 시나리오에서 업스트림 HTTP 서버로의 연결이 성공하더라도, 서버와의 트랜잭션은 실패할 수 있다. 반면 [tcp 프록시][config-listeners-network-filters-tcp-proxy] 필터는 TCP 계층 상위의 프로토콜은 이해하지 못하므로 지역적으로 유래한 오류만 보고한다.

기본 구성([outlier_detection.split_external_local_origin_errors][api-clusters-outlier-detection-split-external-local-origin-errors]가 *false*) 지역적으로 유래한 오류는 외부에서 만들어진 (트랜잭션) 오류와 구분되지 않는다. 모드 같은 버킷에 들어가고 [outlier_detection.consecutive_5xx][api-clusters-outlier-detection-consecutive-5xx], [outlier_detection.consecutive_gateway_failure][api-clusters-outlier-detection-consecutive-gateway-failure], [outlier_detection.sucess_rate_stdev_factor][api-clusters-outlier-detection-success-rate-stdev-factor] 구성 항목과 비교된다. 예를 들어, 업스트림 HTTP 서버로의 연결이 성공한 뒤 타임아웃으로 두 번 실패하면 서버는 오류 코드 500을 반환하고 총 오류 수는 3이 된다.

> [!NOTE]
>
> TCP 트래픽의 경우 [outlier_detection.consecutive_5xx][api-clusters-outlier-detection-consecutive-5xx]가 설정하고 TCP 연결 실패에 투명하게 매핑하는 올바른 파라미터다.

아웃라이어 감지는 지역적으로 유래한 오류와 외부에서 유래한(트랜잭션)오류를 구분하도록 구성할 수 있다. [outlier_detection.split_external_local_origin_errors][api-clusters-outlier-detection-split-external-local-origin-errors] 구성 항목을 사용한다. 이 모드에서는 지역적으로 유래한 오류가 외부에서 유래한 (트랜잭션) 오류와 별개의 카운터로 추적되고 아웃라이어 감지기는 지역적으로 유래한 오류에 반응하고 외부에서 유래한 오류는 무시하거나 그 반대로도 구성할 수 있다.

클러스터는 몇몇 필터 체인 사이에서 공유될 수 있다는 점을 이해하는 것이 중요하다. 한 필터 체인이 자신의 아웃라이어 ㄱ마지 유형에 따라 호스트를 방출하면 다른 필터 체인의 아웃라이어 감지 유형은 호스트를 방출시키지 않았더라도 영향을 받는다.

[arch-upstream-clusters-load-balancing-overview]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overview#arch-overview-load-balancing
[arch-upstream-clusters-health-checking]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking#arch-overview-health-checking
[api-clusters-outlier-detection]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-msg-config-cluster-v3-outlierdetection
[config-http-http-filters-router]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#config-http-filters-router
[config-listeners-network-filters-tcp-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/tcp_proxy_filter#config-network-filters-tcp-proxy
[config-listeners-network-filters-redis-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/redis_proxy_filter#config-network-filters-redis-proxy
[config-listeners-network-filters-thrift-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/thrift_proxy_filter#config-network-filters-thrift-proxy
[api-clusters-outlier-detection-split-external-local-origin-errors]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-split-external-local-origin-errors
[api-clusters-outlier-detection-consecutive-5xx]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-consecutive-5xx
[api-clusters-outlier-detection-consecutive-gateway-failure]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-consecutive-gateway-failure
[api-clusters-outlier-detection-success-rate-stdev-factor]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-success-rate-stdev-factor
