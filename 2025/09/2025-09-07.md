# 2025-09-07

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 아웃라이어 감지

###### 방출 알고리즘

아웃라이어 감지 유형에 따라 방출은 인라인(예를 들어 5xx 응답이 연속으로 발생한 경우) 혹은 지정된 주기(예를 들어, 주기 성공률) 중 하나로 실행된다. 방출 알고리즘은 다음과 같이 동작한다:

1. 호스트가 아웃라이어로 결정된다.
2. 방출된 호스트가 ([outlier_detection.max)ejection_percent][api-clusters-outlier-detection-max-ejection-percent] 설정으로 지정된)허용된 임계치 미만인지 확인한다. 방출된 호스트가 임계치보다 크면 호스트는 방출되지 않는다.
3. 호스트는 몇 밀리초 동안 방출된다. 방출은 호스트가 언헬시로 표시되고 로드 밸런서가 [패닉][arch-upstream-clusters-load-balancing-panic-threshold] 시나리오에 있지 않은 이상 로드 밸런싱에 쓰이지 않음을 의미한다. 방출되는 시간은 [outlier_detection.base_ejection_time][api-clusters-outlier-detection-base-ejection-time] 값에 호스트가 방출된 횟수를 곱한 값이다. 이는 호스트가 계속 실패하면 더 오랜 시간동안 방출되도록 한다. 방출 시간이 [outlier_detection.max_ejection_time][api-clusters-outlier-detection-max-ejection-time]에 도달하면 더이상 증가하지 않는다. 호스트가 헬시 상태가 되면 방출 시간은 시간이 지날수록 감소한다. 호스트의 헬스는 [outlier_detection.interval][api-clusters-outlier-detection-interval]과 같은 주기로 검사된다. 호스트가 검사 시점에 헬시 상태이면 방출 시간이 줄어든다. 호스트가 계속 헬시 상태로 있으면 최솟값 [outlier_detection.base_ejection_time][api-clusters-outlier-detection-base-ejection-time]까지 약 [outlier_detection.max_ejection_time][api-clusters-outlier-detection-max-ejection-time] / [outlier_detection.base_ejection_time][api-clusters-outlier-detection-base-ejection-time] * [outlier_detection.interval][api-clusters-outlier-detection-interval] 초만큼 방출 시간을 낮춘다.
4. 방출된 호스트는 방출 시간이 경과하면 자동으로 서비스로 복귀한다. 일반적으로 아웃라이어 감지는 포괄적인 헬스 체크 솔루션을 위해 [능동적 헬스 체크][arch-upstream-clusters-health-checking]와 함께 쓰인다.

> [!NOTE]
>
> [능동적 헬스 체크][arch-upstream-clusters-health-checking]도 구성된 경우, 성공적인 능동적 헬스 체크는 호스트를 복귀시키고(uneject) 모든 아웃라이어 감지 카운터를 초기화한다. 호스트의 실패한 헬스 체크가 아직 [unhealthy_threshold][api-clusters-health-check-unhealthy-threshold]에 도달하지 않았다면 헬스 체크 요청이 하나 성공하면 호스트를 복귀시킨다. 호스트에 FAILED_ACTIVE_HC 헬스 플래그가 설정돼 있으면, [healthy_threshold][api-clusters-health-check-healthy-threshold]만큼 헬스 체크가 연속적으로 성공하면 호스트를 복귀시킨다(그리고 FAILED_ACTIVE_HC 플래그를 지운다). 능동적 헬스 체크가 데이터 플레인 트래픽의 유효성을 검증하지 않고 있으면 능동적 헬스 체크를 통과했으나 트래픽이 여전히 실패하는 경우 엔드포인트가 일찍 복귀할 것이다. 이 옵션을 비활성화하려면 [outlier_detection_successful_active_health_check_uneject_host][api-clusters-outlier-detection-successful-active-health-check-uneject-host] 구성 플래그를 `false`로 설정하라.

[api-clusters-outlier-detection-max-ejection-percent]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-max-ejection-percent
[arch-upstream-clusters-load-balancing-panic-threshold]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/panic_threshold#arch-overview-load-balancing-panic-threshold
[api-clusters-outlier-detection-base-ejection-time]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-base-ejection-time
[api-clusters-outlier-detection-max-ejection-time]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-max-ejection-time
[api-clusters-outlier-detection-interval]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-interval
[arch-upstream-clusters-health-checking]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking#arch-overview-health-checking
[api-clusters-health-check-unhealthy-threshold]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-field-config-core-v3-healthcheck-unhealthy-threshold
[api-clusters-health-check-healthy-threshold]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-field-config-core-v3-healthcheck-healthy-threshold
[api-clusters-outlier-detection-successful-active-health-check-uneject-host]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/outlier_detection.proto#envoy-v3-api-field-config-cluster-v3-outlierdetection-successful-active-health-check-uneject-host
