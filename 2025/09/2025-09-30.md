# 2025-09-30

## Envoy

### 아키텍처 개요

#### 관측성

##### 트레이싱

###### 각 트레이스가 갖는 데이터

종단 간(end-to-end) 트레이스는 하나 이상의 스팬으로 구성된다. 하나의 스팬은 시작 시간과 기간(duration)을 갖는 논리적인 작업 단위이며 이와 관련된 메타데이터를 가질 수 있다. Envoy에서 생성된 각 스팬은 다음 데이터를 갖는다:

* `--service-cluster`를 통해 설정된 원본 서비스 클러스터.
* 요청의 시작 시간과 기간
* `--service-node`를 통해 설정된 원본 호스트.
* [x-envoy-downstream-service-cluster][config-http-http-connection-manager-http-header-manipulation-x-envoy-downstream-service-cluster] 헤더를 통해 설정된 다운스트림 클러스터.
* HTTP 요청 URL, 메서드, 프로토콜, 사용자 에이전트.
* [커스텀 태그][api-extensions-filters-http-connection-manager-custom-tags]를 통해 설정된 추가적인 커스텀 태그.
* 업스트림 클러스터 이름, 관측성 이름, 주소.
* HTTP 응답 상태 코드.
* (사용 가능한 경우)gRPC 응답 상태 및 메시지
* HTTP 상태가 5xx이거나 gRPC 상태가 "OK"가 아니고 서비스 측 오류를 나타내는 경우 오류 태그. gRPC 상태 코드에 대한 자세한 정보는 [gRPC 문서][grpc-core-status]를 참고하라.
* 트레이싱 시스템 특화 메타데이터.

스팬은 이름(또는 연산(operation))을 가질 수 있고 기본값은 호출된 서비스의 호스트 이름으로 정의된다. 하지만 이는 라우트에서 [config.route.v3.Deecorator][api-http-route-management-http-route-components-decorator]를 사용해 커스터마이즈할 수 있다. 이름은 [x-envoy-decorator-operation][config-http-http-filters-router-x-envoy-decorator-operation] 헤더를 사용해 오버라이드할 수 있다.

Envoy는 자동으로 스팬을 트레이싱 수집기로 보낸다. 트레이싱 수집기에 따라 전역적으로 유니크한 요청 ID [x-request-id][config-http-http-connection-manager-http-header-manipulation-x-request-id](LightStep) 또는 트레이스 ID 구성(Zipkin과 Datadog)과 같은 공통 정보를 사용해 여러 스팬이 이어붙여질 수 있다. Envoy에서 트레이싱을 셋업하는 방법에 대해서는 [v3 API 레퍼런스][api-extensions-http-tracers-tracing]를 참고하라.

[config-http-http-connection-manager-http-header-manipulation-x-envoy-downstream-service-cluster]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-downstream-service-cluster
[api-extensions-filters-http-connection-manager-custom-tags]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-tracing-custom-tags
[grpc-core-status]: https://grpc.github.io/grpc/core/md_doc_statuscodes.html
[api-http-route-management-http-route-components-decorator]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-decorator
[config-http-http-filters-router-x-envoy-decorator-operation]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#config-http-filters-router-x-envoy-decorator-operation
[config-http-http-connection-manager-http-header-manipulation-x-request-id]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-request-id
[api-extensions-http-tracers-tracing]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/trace/v3/http_tracer.proto#envoy-v3-api-msg-config-trace-v3-tracing
