# 2025-08-22

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 지역성 가중치 로드 밸런싱

서로 다른 존과 지리적 위치에 따라 가중치를 부여하는 한 가지 접근방식은 [LocalityLbEndpoints][api-extensions-endpoint-locality-lb-endpoints] 메시지의 EDS를 통해 제공되는 명시적 가중치를 사용하는 것이다. 지역성 인식 LB에서는 존 인식 라우팅에서 쓰이는 Envoy 측 휴리스틱 대신 관리 서버에 의존해 지역성 가중치를 제공하기 때문에 접근방식은 [존 인식 라우팅][arch-upstream-clusters-load-balancing-zone-aware-routing]과 상호 배타적이다.

모든 엔드포인트가 가용하면 가중체 부여에 지역성 가중치가 쓰이고 지역성은 라운드 로빈 스케줄을 사용해 선택된다. 한 지역성의 일부 엔드포인트가 가용하지 않으면 지역성 가중치를 조정해 이를 반영한다. [우선순위 수준][arch-upstream-clusters-load-balancing-priority-levels]에서는 [오버프로비저닝 지수][arch-upstream-clusters-load-balancing-overprovisioning-factor](기본값 1.4)를 가정해 지역성에서 소수의 엔드포인트만 가용하지 않으면 가중치 조정을 수행하지 않는다.

2개의 지역성 X와 Y가 있고 X는 지역성 가중치 1을, Y는 지역성 가중치 2를 갖는다고 가정하자. L=Y는 모두 100% 가용하고 오버프로비저닝 지수는 1.4다.

| L=X 헬시 엔드포인트 | L=X로의 트래픽 비율 | L=Y로의 트래픽 비율 |
| ------------------- | ------------------- | ------------------- |
| 100%                | 33%                 | 67%                 |
| 70%                 | 33%                 | 67%                 |
| 69%                 | 32%                 | 68%                 |
| 50 %                | 26%                 | 74%                 |
| 25%                 | 15%                 | 85%                 |
| 0%                  | 0%                  | 100%                |

이를 의사 알고리즘으로 정리하면 다음과 같다:

```
availability(L_X) = 140 * available_X_upstreams / total_X_upstreams
effective_weight(L_X) = locality_weight_X * min(100, availability(L_X))
load to L_X = effective_weight(L_X) / Σ_c(effective_weight(L_c))
```

지역성 가중치 선택은 우선순위 수준 다음에 선택된다. 로드 밸런서는 다음과 같은 단계를 따른다:

1. [우선순위 수준][arch-upstream-clusters-load-balancing-priority-levels] 선택
2 (이 섹션에서 설명한대로)(1)의 우선순위 수준에서 지역성 선택
3. (2)의 지역성에서 클러스터가 지정된 로드 밸런서를 사용해 엔드포인트 선택

지역성 가중치 로드 밸런싱은 클러스터 구성의 [locality_weighted_lb_config][api-clusters-cluster-configuratrion-common-lb-config-locality-weighted-lb-config]를 설정하고 [load_balancing_weight][api-extensions-endpoint-locality-lb-endpoints-load-balancing-weight]를 제공하고 [LocalityLbEndpoints][api-extensions-endpoint-locality-lb-endpoints]의 [지역성][api-extensions-endpoint-locality-lb-endpoints-locality]을 통해 업스트림 호스트의 위치를 식별하는 것으로 구성된다.

분별 가능한 서브셋과 함께 지역성 수준 가중치를 조정하는 것이 직관적이지 않기 때문에 이 기능은 [로드 밸런서 서브세팅][arch-upstream-clusters-load-balancing-load-balancer-subsets]과는 호환되지 않는다.

[api-extensions-endpoint-locality-lb-endpoints]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-msg-config-endpoint-v3-localitylbendpoints
[arch-upstream-clusters-load-balancing-zone-aware-routing]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/zone_aware#arch-overview-load-balancing-zone-aware-routing
[arch-upstream-clusters-load-balancing-priority-levels]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/priority#arch-overview-load-balancing-priority-levels
[arch-upstream-clusters-load-balancing-overprovisioning-factor]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overprovisioning#arch-overview-load-balancing-overprovisioning-factor
[api-clusters-cluster-configuratrion-common-lb-config-locality-weighted-lb-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-locality-weighted-lb-config
[api-extensions-endpoint-locality-lb-endpoints-load-balancing-weight]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-field-config-endpoint-v3-localitylbendpoints-load-balancing-weight
[api-extensions-endpoint-locality-lb-endpoints-locality]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-field-config-endpoint-v3-localitylbendpoints-locality
[arch-upstream-clusters-load-balancing-load-balancer-subsets]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/subsets#arch-overview-load-balancer-subsets
