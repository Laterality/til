# 2025-08-21

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 퇴화한(degraded) 엔드포인트

Envoy는 특정 엔드포인트를 퇴화한, 즉 트래픽을 받을 수는 있지만 가용한 헬시 호스트가 충분하지 않은 것으로 표시하는 것을 지원한다.

넘치는 트래픽을 계산하기 위해 퇴화한 호스트는 원본 우선순위의 헬시 비율에 포함되지만 퇴화한 호스트로 라우팅하는 것은 더 낮은 [우선순위][arch-upstream-clusters-load-balancing-priority-levels]의 호스트로 라우팅하는 것과 비슷하게 생각할 수 있다. 가용한 헬시 호스트의 총량이 더이상 100%의 부하를 처리하기에 충분하지 않기에, 트래픽은 헬시 호스트에 대해 우선순위가 넘쳐흐르는 것과 같은 메커니즘을 사용해 퇴화된 호스트로 넘쳐 흐른다. 이는 필요에 따라 트래픽이 점진적으로 퇴화된 호스트로 이동하도록 한다.

| P=0인 헬시/퇴화한/언헬시 | P=0인 헬시 호스트로의 트래픽 | P=0인 퇴화한 호스트로의 트래픽 |
| ------------------------ | ---------------------------- | ------------------------------ |
| 100%/0%/0%               | 100%                         | 0%                             |
| 71%/0%/29%               | 100%                         | 0%                             |
| 71%/0%/29%               | 100%                         | 0%                             |
| 71%/29%/0%               | 99%                          | 1%                             |
| 25%/65%/10%              | 35%                          | 65%                            |
| 5%/0%/95%                | 100%                         | 0%                             |

능동적 헬스 체크와 업스트림 호스트가 [특수한 헤더][arch-upstream-clusters-health-checking-degraded]를 반환하는 것으로 엔드포인트를 퇴화한 것으로 표시할 수 있다.

[arch-upstream-clusters-load-balancing-priority-levels]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/priority#arch-overview-load-balancing-priority-levels
[arch-upstream-clusters-health-checking-degraded]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking#arch-overview-health-checking-degraded