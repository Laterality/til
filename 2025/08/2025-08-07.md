# 2025-08-07

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 커넥션 풀링

###### 해피 아이볼(Happy Eyeballs) 지원

Envoy는 업스트림 TCP 커넥션에 대해 [RFC8305][rfc-8305] 해피 아이볼을 지원한다. [LOGICAL_DNS][api-clusters-cluster-configuration-discovery-type-logical-dns]를 사용하는 클러스터에 대해 이 동작은 [config.cluster.v3.Cluster.DnsLookupFamily][api-clusters-cluster-configuration-dns-lookup-family]의 DNS IP 주소 리졸루션 정책 설정을 [ALL][api-clusters-cluster-configuration-dns-lookup-family-all] 옵션으로 설정해 IPv4와 IPv6 주소 둘 다 반환하게 함으로써 구성된다. [EDS][api-clusters-cluster-configuration-discovery-type-eds]를 사용하는 클러스터에 대해 이 동작은 [additional_addresses][api-extensions-endpoint-additional-addresses] 필드를 사용해 호스트에 대한 추가적인 IP 주소를 지정함으로써 구성된다. 이 필드에 지정된 주소들은 [addresses][api-extensions-endpoint-addresses]에 지정된 것에 리스트로 더해진다.

모든 주소 리스트는 해피 아이볼 명세에 따라 정렬되고 리스트의 첫 번째에 커넥션을 시도한다. 이 커넥션이 성공하면 이를 사용한다. 실패하면 리스트의 다음 항목에 시도한다. 300ms 후에도 커넥션이 연결중이면 리스트의 다음 주소에 백업 커넥션을 시도한다.

결과적으로 주소 중 하나에 성공하면 그 커넥션을 사용하고 모든 시도가 실패하면 커넥션 오류를 보고할 것이다.

HTTP/3는 제한된 해피 아이볼과 유사한 지원을 가지고 있다. TCP-페일오버와 함께 HTTP/3에 [auto_config][api-extensions-upstream-configuration-http-protocol-options-auto-config]를 사용중이면 Envoy는 best-effort 시도로 두 주소 패밀리에 시도한다. TCP 해피 아이볼로 인해 Envoy는 첫  HTTP/3 연결 시도를 300ms까지 허용한다. 커넥션이 명시적으로 실패하거나 300ms 타임아웃이 만료되면 DNS 리졸루션에 첫 두 개 주소가 서로 다른 주소 패밀리인 경우 두 번째 주소를 사용해 두 번째 HTTP/3 커넥션 풀이 만들어지고 Envoy는 대체 주소 패밀리를 사용해 HTTP/3 커넥션 수립을 시도한다. 이 경우 HTTP/3는 TCP 연결이 수립되고 두 HTTP/3 커넥션 모두 실패한 경우에만 끊어진 것으로 표시된다. 

[rfc-8305]: https://datatracker.ietf.org/doc/html/rfc8305
[api-clusters-cluster-configuration-discovery-type-logical-dns]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-value-config-cluster-v3-cluster-discoverytype-logical-dns
[api-clusters-cluster-configuration-dns-lookup-family]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-config-cluster-v3-cluster-dnslookupfamily
[api-clusters-cluster-configuration-dns-lookup-family-all]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-value-config-cluster-v3-cluster-dnslookupfamily-all
[api-clusters-cluster-configuration-discovery-type-eds]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-value-config-cluster-v3-cluster-discoverytype-eds
[api-extensions-endpoint-additional-addresses]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-field-config-endpoint-v3-endpoint-additional-addresses
[api-extensions-endpoint-addresses]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-field-config-endpoint-v3-endpoint-address
[api-extensions-upstream-configuration-http-protocol-options-auto-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/upstreams/http/v3/http_protocol_options.proto#envoy-v3-api-field-extensions-upstreams-http-v3-httpprotocoloptions-auto-config
