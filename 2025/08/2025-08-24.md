# 2025-08-24

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 패닉 임계치

로드 밸런싱 중에 Envoy는 일반적으로 업스트림 클러스터에서 가용한(헬시 또는 퇴화된 상태)의 호스트를 고려한다. 하지만 클러스터에서 가용 호스트의 퍼센티지가 너무 낮아지면 Envoy는 헬스 상태와 호스트 균형을 무시한다. 이는 *패닉 임계치*로 알려져 있다. 이 기본 패닉 임계치는 50%다. 이는 [런타임][config-upstream-clusters-cluster-manager-runtime]뿐만 아니라 [클러스터 구성][api-clusters-cluster-configuration-common-lb-config-healthy-panic-threshold]에도 구성 가능하다. 패닉 임계치는 부하가 증가함에 따라 호스트의 실패가 클러스터 전체로 퍼지는 상황을 막는 데 쓰인다.

패닉 상태에서 Envoy는 두 가지 모드를 선택할 수 있다. 트래픽을 모든 호스트에게 보내거나 아무 호스트에게도 보내지 않는다(이 경우 항상 실패할 것이다). 이는 [클러스터 구성][api-clusters-cluster-configuration-zone-aware-lb-config-fail-traffic-on-panic]에 구성된다. 패닉 시나리오에서 트래픽을 실패시키는 것은 모든 호스트가 언헬시로 결정되기 전에 업스트림 서비스로의 부하를 줄이기 때문에 업스트림 서비스가 잠재적으로 대량 실패하는 것을 막는 데 도움이 될 수 있다. 하지만 클러스터에서 많은 혹은 모든 호스트가 언헬시인 상황에서도 *일부* 요청이 성공할 가능성을 제거한다. 이는 주어진 서비스가 all-or-nothing 패턴에서 실패하는 것으로 관측된 경우 클러스터로의 요청을 더 빠르게 차단할 것이므로 좋은 트레이드오프일 수 있다. 반면에, 클러스터가 퇴화된 상태에서도 *일부* 요청을 성공적으로 제공할 수 있다면 이 옵션을 활성화하는 것은 도움이 되지 않을 수 있다.

패닉 임계치는 우선순위와 함께 동작한다. 주어진 우선순위에서 가용 호스트의 수가 줄어들면, Envoy는 일부 트래픽을 더 낮은 우선순위로 이동시키려고 한다. 더 낮은 우선순위에서 충분히 가용한 호스트를 찾으면 Envoy는 패닉 임계치를 무시한다. 수학적인 용어로는 모든 우선순위 수준에서 정규화된 총 가용성이 100%이면, Envoy는 패닉 임계치를 무시하고 [여기][arch-upstream-clusters-load-balancing-prority-levels] 기술된 알고리즘에 따라 우선순위에 걸쳐 트래픽 부하를 계속 분산한다. 하지만 정규화된 총 가용성이 100% 아래로 떨어지면, Envoy는 모든 우선순위 수준에 걸쳐 가용 호스트가 충분하지 않다고 가정한다. 모든 우선순위에 걸쳐 부하를 계속 분산하지만 주어진 우선순위 수준의 가용성이 패닉 임계치보다 낮아지면, 트래픽은 가용성의 우선순위 수준과 관계 없이 모든 호스트에게 갈 것이다(또는 아무 호스트에게도 가지 않을 것이다).

다음 예시는 정규화된 총 가용성과 패닉 임계치 사이의 관계를 설명한다. 기본값 50%가 패닉 임계치로 사용된다고 가정한다.

2 개 우선순위 수준, P=1 100% 헬시라고 가정한다. 이 시나리오에서는 정규화된 총 헬스는 항상 100%이고 P=0은 패닉 모드로 진입하지 않으므로 Envoy는 필요한 만큼 트래픽을 P=1로 이동시킬 수 있다.

| P=0 헬시 엔드포인트 | P=0로의 트래픽 | P=0 패닉 | P=1로의 트래픽 | P=1 패닉 | 정규화된 총 헬스 |
| ------------------- | -------------- | -------- | -------------- | -------- | ---------------- |
| 72%                 | 100%           | NO       | 0%             | NO       | 100%             |
| 71%                 | 99%            | NO       | 1%             | NO       | 100%             |
| 50%                 | 70%            | NO       | 30%            | NO       | 100%             |
| 25%                 | 35%            | NO       | 65%            | NO       | 100%             |
| 0%                  | 0%             | NO       | 100%           | NO       | 100%             |

만약 P=1이 언헬시가 되면 패닉 임계치는 헬스 P=0 + P=1이 100% 미만이 될 때까지 계속 무시된다. 이 지점에서 Envoy는 각 우선순위의 패닉 임계치를 검사하기 시작한다.

| P=0 헬시 엔드포인트 | P=1 헬시 엔드포인트 | P=0로의 트래픽 | P=0 패닉 | P=1로의 트래픽 | P=1 패닉 | 정규화된 총 헬스 |
| ------------------- | ------------------- | -------------- | -------- | -------------- | -------- | ---------------- |
| 72%                 | 72%                 | 100%           | NO       | 0%             | NO       | 100%             |
| 71%                 | 71%                 | 99%            | NO       | 1%             | NO       | 100%             |
| 50%                 | 60%                 | 70%            | NO       | 30%            | NO       | 100%             |
| 25%                 | 100%                | 35%            | NO       | 65%            | NO       | 100%             |
| 25%                 | 25%                 | 50%            | YES      | 50%            | YES      | 70%              |
| 5%                  | 65%                 | 7%             | YES      | 93%            | NO       | 98%              |

패닉 모드는 패닉 임계치를 0%으로 설정해 비활성화할 수 있다.

부하 분산은 우선순위 수준이 패닉 모드에 들어가지 않는 한 위에 설명된 대로 계산된다. 모든 우선순위 수준이 패닉 모드로 진입하면 부하 계산 알고리즘이 바뀐다. 이 경우 각 우선순위 수준이 모든 우선순위 수준의 호스트의 수왑 비교해 해당 우선순위 수준의 상대적인 호스트 수에 따라 트래픽을 받게 된다. 예를 들어, 두 우선순위 P=0과 P=1이 있고 각각이 5개 호스트로 구성되면, 각 수준은 50% 트래픽을 받을 것이다. P=0에 2개의 호스트가 있고 P=1에 8개의 호스트가 있다면 P=0은 20%의 트래픽을 받고 P=1은 80%의 트래픽을 받을 것이다.

하지만 어떤 우선순위에서도 패닉 임계치가 0%이면 우선순위는 패닉 모드로 진입하지 않는다. 이 경우 모든 호스트가 언헬시면 Envoy는 호스트 선택에 실패하고 즉시 오류 응답 "503 - no healthy upstream"을 반환할 것이다.

패닉 임계치는 *우선순위별로* 구성할 수 있다.

[config-upstream-clusters-cluster-manager-runtime]: https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_runtime#config-cluster-manager-cluster-runtime
[api-clusters-cluster-configuration-common-lb-config-healthy-panic-threshold]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-healthy-panic-threshold
[api-clusters-cluster-configuration-zone-aware-lb-config-fail-traffic-on-panic]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-zoneawarelbconfig-fail-traffic-on-panic
[arch-upstream-clusters-load-balancing-prority-levels]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/priority#arch-overview-load-balancing-priority-levels
