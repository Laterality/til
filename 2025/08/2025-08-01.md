# 2025-08-01

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 헬스 체크

###### HTTP 헬스 체크 필터

Envoy 메시가 능동적 헬스 체크와 함께 클러스터에 배포되면 대량의 헬스 체크 트래픽이 만들어질 수 있다. Envoy는 구성된 HTTP 리스너에 설치할 수 있는 헬스 체크 필터를 포함하고 있다. 이 필터는 몇 가지 모드로 동작할 수 있다.

* **패스 스루 하지 않음**: 이 모드에서는 헬스 체크 요청이 로컬 서비스로 전달되지 않는다. Envoy는 서버의 현재 드레인(drain) 상태에 따라 200 또는 503으로 응답한다.
* **패스 스루 하지 않음, 업스트림 클러스터 헬스로부터 계산**: 이 모드에서는 헬스 체크 필터가 하나 이상의 업스트림 클러스터에서 [지정된 비율][api-extensions-filters-health-check-cluster-min-healthy-percentages]만큼 서버가 가용(available)한지 여부에 따라 200 또는 503을 반환한다. (Envoy 서버가 드레인 상태인 경우에는 업스트림 클러스터 헬스와 관계없이 503으로 응답한다).
* **패스 스루**: 이 모드에서는 Envoy가 모든 헬스 체크 요청을 로컬 서비스로 전달한다. 서비스는 자신의 헬스 상태에 따라 200 또는 503을 응답할 것으로 예상한다.
* **캐싱과 함께 패스 스루**: 이 모드에서는 Envoy가 헬스 체크 요청을 로컬 서비스로 전달하지만 일정 기간동안 결과를 캐싱한다. 캐시 시간에 따라 후속 헬스 체크 요청들은 캐싱된 값이 반환될 것이다. 캐시 시간에 도달하면 다음 헬스 체크 요청이 로컬 서비스로 전달된다. 이는 대규모 메시를 운영할 때 권장되는 모드다. 따라서 이 운영 모드는 대량의 헬스 체크 요청으로 로컬 서비스를 압도하지 않고 각 업스트림 호스트의 헬스 상태를 최종적으로 일관된 관점으로 제공한다.

추가 자료:

* 헬스 체크 필터 [구성][config-http-http-filters-health-check]
* [/healthcheck/fail][ops-and-admin-admin-interface-healthcheck-fail] 어드민 엔드포인트
* [/healthcheck/ok][ops-and-admin-admin-interface-healthcheck-ok] 어드민 엔드포인트

[api-extensions-filters-health-check-cluster-min-healthy-percentages]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/health_check/v3/health_check.proto#envoy-v3-api-field-extensions-filters-http-health-check-v3-healthcheck-cluster-min-healthy-percentages
[config-http-http-filters-health-check]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/health_check_filter#config-http-filters-health-check
[ops-and-admin-admin-interface-healthcheck-fail]: https://www.envoyproxy.io/docs/envoy/latest/operations/admin#operations-admin-interface-healthcheck-fail
[ops-and-admin-admin-interface-healthcheck-ok]: https://www.envoyproxy.io/docs/envoy/latest/operations/admin#operations-admin-interface-healthcheck-ok