# 2025-08-06

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 커넥션 풀링

###### 자동 프로토콜 선택

Envoy가 포워드 프록시로 동작할 때 선호되는 구성은 [http_protocol_options][api-extensions-upstream-configuration-http-protocol-options]를 통해 구성되는 [AutoHttpConfig][api-extensions-upstream-configuration-auto-http-config]다. 기본적으로 TCP와 ALPN을 사용해 HTTP/2 및 HTTP/1.1에서 사용 가능한 최선의 프로토콜을 선택한다.

HTTP/3으로 자동 http를 구성하면 [alternate_protocols_cache_options][api-extensions-upstream-configuration-auto-http-config-alternate-protocols-cache-options]를 통해 대체 프로토콜 캐시가 구성돼야 한다. HTTP/3 커넥션은 [HTTP 대체 서비스][rfc-7838] 중 하나(결국 [HTTPS DNS 리소스 레코드][draft-ietf-dnsop-svcb-https-04]나 "QUIC 힌트"가 수동으로 구성된다)를 통해 HTTP/3 지원을 알린 서버로만 시도한다.

HTTP/3를 시도하면 Envoy는 QUIC 커넥션을 먼저 시도한 다음 300ms 이후에 QUIC 커넥션이 수립되지 않으면 TCP 커넥션 수립을 시도한다. 어느것이든 핸드셰이크가 성공한 것이 초기 스트림에 쓰이지만 TCP와 QUIC 커넥션 둘 다 수립되면 결국 QUIC을 선호한다.

게다가 HTTP/3는 TCP가 아닌 (UDP를 사용하는)QUIC을 통해 실행된다. 네트워크 디바이스가 UDP 트래픽을 차단하면서 HTTP/3도 차단하게 되는 것은 드문 일이 아니다. 즉, 이 업스트림 HTTP/3 커넥션 시도는 네트워크에서 차단돼 HTTP/2나 HTTP/1을 사용하도록 폴백(fallback)할 수 있다. 이 코드 경로는 프로덕션에서 충분히 쓰이기 전까지는 알파로 간주되지만 사용할 준비는 된 것으로 간주한다.

[api-extensions-upstream-configuration-http-protocol-options]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/upstreams/http/v3/http_protocol_options.proto#envoy-v3-api-msg-extensions-upstreams-http-v3-httpprotocoloptions
[api-extensions-upstream-configuration-auto-http-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/upstreams/http/v3/http_protocol_options.proto#envoy-v3-api-msg-extensions-upstreams-http-v3-httpprotocoloptions-autohttpconfig
[api-extensions-upstream-configuration-auto-http-config-alternate-protocols-cache-options]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/upstreams/http/v3/http_protocol_options.proto#envoy-v3-api-field-extensions-upstreams-http-v3-httpprotocoloptions-autohttpconfig-alternate-protocols-cache-options
[rfc-7838]: https://tools.ietf.org/html/rfc7838
[draft-ietf-dnsop-svcb-https-04]: https://datatracker.ietf.org/doc/html/draft-ietf-dnsop-svcb-https-04