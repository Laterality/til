# 2025-08-29

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드 밸런싱 - 로드 밸런서 서브셋

###### 예시

모든 값이 문자열인 간단한 메타데이터를 사용한다. 다음 호스트가 정의돼 클러스터와 연관돼 있다고 가정하자:

| 호스트 | 메타데이터             |
| ------ | ---------------------- |
| host1  | v: 1.0, stage: prod    |
| host2  | v: 1.0, stage: prod    |
| host3  | v: 1.1, stage: canary  |
| host4  | v: 1.2-pre, stage: dev |

클러스터는 다음과 같이 서브셋 로드 밸런싱을 활성화할 수 있다:

```yaml
---
name: cluster-name
type: EDS
eds_cluster_config:
  eds_config:
    path: ".../eds.conf"
connect_timeout:
  seconds: 10
lb_policy: LEAST_REQUEST
lb_subset_config:
  fallback_policy: DEFAULT_SUBSET
  default_subset:
    stage: prod
  subset_selectors:
    - keys:
        - v
        - stage
    - keys:
        - stage
      fallback_policy: NO_FALLBACK
```

다음 표는 일부 라우트와 클러스터에 대한 애플리케이션 결과를 나타낸다. 대체로 일치 조건은 경로나 헤더 정보와 같이 요청의 특정 측면과 일치하는 라우트가 쓰인다.

| 일치 조건              | 목적지       | 사유                                                     |
| ---------------------- | ------------ | -------------------------------------------------------- |
| stage: canary          | host3        | 호스트의 서브셋이 선택됨                                 |
| v: 1.2-pre, stage: dev | host4        | 호스트의 서브셋이 선택됨                                 |
| v: 1.0                 | host1, host2 | 폴백: "v"만 있는 서브셋 선택자가 없음                    |
| other: x               | host1, host2 | 폴백: "other"에 대한 서브셋 선택자가 없음                |
| (none)                 | host1, host2 | 폴백: 서브셋이 요청되지 않음                             |
| stage: test            | 빈 클러스터  | 폴백 정책이 선택자별로 "NO_FALLBACK" 값으로 오버라이드됨 |

메타데이터 일치 조건은 라우트의 가중치 클러스터에 지정될 수 있다. 선택된 가중치 클러스터의 메타데이터 일치 조건은 라우트의 조건을과 병합돼 오버라이드한다:

| 라우트 일치 조건    | 가중치 클러스터 일치 조건 | 최종 일치 조건        |
| ------------------- | ------------------------- | --------------------- |
| stage: canary       | stage: prod               | stage: prod           |
| v: 1.0              | stage: prod               | v: 1.0, stage: prod   |
| v: 1.0, stage: prod | stage: canary             | v: 1.0, stage: canary |
| v: 1.0, stage: prod | v: 1.1, stage: canary     | v: 1.1, stage: canary |
| (none)              | v: 1.0                    | v: 1.0                |
| v: 1.0              | (none)                    | v: 1.0                |

**메타데이터가 있는 호스트 예시**

호스트 메타데이터가 있는 EDS `LbEndpoint`:

```yaml
---
endpoint:
  address:
    socket_address:
      protocol: TCP
      address: 127.0.0.1
      port_value: 8888
metadata:
  filter_metadata:
    envoy.lb:
      version: "1.0"
      stage: "prod"
```

**메타데이터 조건이 있느 라우트 예시**

메타데이터 일치 조건이 있는 RDS `Route`:

```yaml
---
match:
  prefix: /
route:
  cluster: cluster-name
  metadata_match:
    filter_metadata:
      envoy.lb:
        version: "1.0"
        stage: "prod"
```
