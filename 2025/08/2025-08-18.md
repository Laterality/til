# 2025-08-18

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 지원되는 로드 밸런서

###### Maglev

Maglev 로드 밸런서는 업스트림 호스트에 대한 일관된 해싱을 구현한다. [이 논문][maglev] 섹션 3.4에 기술된 알고리즘을 65537(같은 논문의 섹션 5.3 참고) 크기의 고정된 테이블 크기로 사용한다. Maglev는 일관된 해싱이 필요한 곳에 [링 해시 로드 밸런서][arch-upstream-clusters-load-balancing-ring-hash]의 대체재로 쓰일 수 있다. 링 해시 로드 밸런서와 마찬가지로, 일관된 해싱 로드 밸런서는 해시할 값을 지정하는 프로토콜 라우팅이 쓰이는 경우에만 효과가 있다. 호스트의 주소 외에 다른 것을 해시 키로 사용하고자 하는 경우, `"envoy.lb"` [LbEndpoint.Metadata][api-extensions-endpoint-lb-endpoint-metadata]에 지정할 수 있다. e.g.:

```yaml
  filter_metadata:
    envoy.lb:
      hash_key: "YOUR HASH KEY"
```

이는 [use_hostname_for_hashing][api-clusters-cluster-configuration-common-lb-config-consistent-hashing-lb-config]을 오버라이드한다.

테이블 생성 알고리즘은 테이블이 꽉 찰 때까지 테이블의 호스트를 가중치에 비례한 횟수만큼 위치시킨다. 예를 들어 호스트 A가 가중치 1을 갖고 호스트 B가 가중치 2를 가지면, 호스트 A는 21,846 개의 엔트리를 갖고 호스트 B는 43,691 개의 엔트리(총 65,537개 엔트리)를 가질 것이다. 알고리즘은 호스트의 지역성 가중치와 무관하게 각 호스트를 테이블에 적어도 한 번 위치시키려고 하므로 일부 극단적인 사례에서는 실제 비율이 구성된 가중치와 다를 수 있다. 예를 들어, 호스트의 총 개수가 고정된 테이블 크기보다 큰 경우 가중치와 관계없이 일부 호스트는 1 개의 엔트리를 갖고 나머지는 0을 가질 것이다. 모범 사례는 [min_entries_per_host와 max_entries_per_host 게이지][config-upstream-clusters-statistics-maglev-lb]를 모니터링해 가중치가 다르거나 누락된 호스트가 없는지 확인하는 것이다.

일반적으로, 링 해시("ketama") 알고리즘과 비교해 Maglev는 테이블 구축 시간 뿐만아니라 호스트 선택 시간(256K개의 거대 링 크기를 사용하는 경우에서 각각 약 10x과 5x)도 대체로 더 빠르다. Maglev는 분열을 최소화하는 데 집중하지만 업스트림 호스트가 바뀔 때는 링 해시만큼 안정적이지 않다. 호스트가 제거될 때는 더 많은 키가 위치를 이동한다(시뮬레이션에서는 약 두 배의 키가 이동한다). 분열 시간은 [테이블 크기][api-clusters-cluster-configuration-maglev-lb-config-table-size]를 증가시켜 최소화할 수 있다. 그렇지만 Redis를 포함한 많은 애플리케이션에서 Maglev는 링 해시의 훌륭한 드랍 인 대체재일 가능성이 높다.

[maglev]: https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/44824.pdf
[arch-upstream-clusters-load-balancing-ring-hash]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#arch-overview-load-balancing-types-ring-hash
[api-extensions-endpoint-lb-endpoint-metadata]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-field-config-endpoint-v3-lbendpoint-metadata
[api-clusters-cluster-configuration-common-lb-config-consistent-hashing-lb-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-consistent-hashing-lb-config
[config-upstream-clusters-statistics-maglev-lb]: https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#config-cluster-manager-cluster-stats-maglev-lb
[api-clusters-cluster-configuration-maglev-lb-config-table-size]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-maglevlbconfig-table-size