# 2025-08-30

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드 밸런싱 - 슬로우 스타트 모드

슬로우 스타트 모드는 Envoy가 새로 추가된 업스트림 엔드포인트에 점진적으로 트래픽을 틀리는 구성 설정이다. 슬로우 스타트가 활성화되지 않은 상태에서는 Envoy가 트래픽 양에 비례해 새 업스트림 엔드포인트로 보낸다. 이는 완전한 프로덕션 부하를 견디기 위해 웜업 시간이 필요한 서비스에게는 적합하지 않을 수 있어 타임아웃이나 데이터 손실이 발생하고 사용자 경험을 악화시킬 수 있다.

슬로우 스타트 모드는 업스트림 엔드포인트의 로드 밸런싱 가중치에 영향을 주는 메커니즘이며 업스트림 클러스터별로 구성할 수 있다. 현재 슬로우 스타트는 [라운드 로빈][api-clusters-cluster-configuration-round-robin-lb-config-slow-start-config]과 [최소 요청][api-clusters-cluster-configuration-leat-request-lb-config-slow-start-config] 로드 밸런서 유형에 지원된다.

슬로우 스타트 모드는 Kubernetes의 스케일 이벤트처럼 적은 수의 새 엔드포인트가 생기는 경우에 가장 효율적이다. Kubernetes의 새 디플로이먼트처럼 모든 엔드포인트가 상대적으로 새것인 경우, 모든 엔드포인트가 같은 양의 요청을 받게 되므로 스로우 스타트가 그다지 효율적이지 않다.

사용자는 [슬로우 스타트 윈도우 파라미터][api-clusters-cluster-configuration-slow-start-config-slow-start-window](초 단위)를 지정해 엔드포인트 별로 슬로우 스타트 모드 기간을 지정할 수 있다. 슬로우 스타트 윈도우 기간에는 특정 엔드포인트의 로드 밸런싱 가중치가 시간에 따라 스케일된다. 예를 들어:

$$NewWeight = {Weight}*{max(MinWeightPercent,{TimeFactor}^\frac{1}{Aggression})}$$

여기서,

$$TimeFactor = \frac{max(TimeSinceStartInSeconds,1)}{SlowStartWindowInSeconds}$$

시간이 지날수록 슬로우 스타트 윈도우에 있는 엔드포인트에 더 많은 트래픽이 보내진다.

[MinWeightPercent 파라미터][api-clusters-cluster-configuration-slow-start-config-min-weight-percent]는 원래 가중치의 최소 비율을 지정해 EDF 스케줄러가 합리적인 데드라인을 갖도록 한다. 기본값은 10%다.

[Aggression 파라미터][api-clusters-cluster-configuration-slow-start-config-aggression]는 비선형적으로 엔드포인트 가중치에 영향을 주고 램프업(ramp-up) 속도를 나타낸다. 이 파라미터를 튜닝함으로써 트래픽 증가 속도를 다항적 혹은 지수적으로 조정할 수 있다.

슬로우 스타트 윈도우 기간이 경과하면 업스트림 엔드포인트는 슬로우 스타트 모드를 종료하고 로드 밸런싱 알고리즘에 따라 원래 받아야 할 만큼의 트래픽을 받는다. 로드 밸런싱 가중치는 더이상 런타임 편향과 aggression에 따라 스케일되지 않는다. 엔드포인트가 클러스터를 떠난 경우에도 슬로우 스타트 모드가 종료된다. 엔드포인트는 능동적 헬스 체크에 의해 언헬시 상태에서 헬시 상태로 천이한 경우 슬로우 스타트 모드에 재진입할 수 있다.

**엔드포인트가 슬로우 스타트 모드에 진입하는 경우**:

* 클러스터 별 능동적 헬스 체크가 구성돼 있지 않은 경우 즉시 클러스터에 조인한다.
* 클러스터 별 능동적 헬스 체크가 구성돼 있는 경우, 엔드포인트가 헬스체크에 의해 언헬시에서 헬시 상태로 천이했을 때.

**엔드포인트가 슬로우 스타트 모드를 종료하는 경우**:

* 클러스터를 떠났을 때.
* 클러스터 별로 구성된 능동적 헬스 체크를 통과하지 않은 경우. 능동적 헬스 체크를 통과하면 엔드포인트는 슬로우 스타트에 재진입할 수 있다.

**트래픽이 적거나 엔드포인트가 많은 시나리오에는 슬로우 스타트 모드를 활성화하는 것을 권장하지 않는다. 잠재적인 약점은**:

* 엔드포인트 고갈, 트래픽이 적거나 전체 엔드포인트 수가 많아 엔드포인트가 요청을 받을 확률이 낮은 경우.
* 엔드포인트 별 트래픽 증가가 비 점진적인 경우, 고갈중인 엔드포인트가 슬로우 스타트 윈도우 내에 요청을 받고 충분한 시간이 지나면 로드 밸런싱 가중치는 시간에 따라 비선형적으로 증가한다.

여러 우선순위가 슬로우 스타트와 함께 쓰이고 더 낮은 우선순위가 엔드포인트 A 하나만 가지고 있는 경우, 우선순위 간 트래픽 이동 중에는 엔드포인트 A로 트래픽이 점직적으로 증가하지 않고 한 번에 이동할 것이다. 지역성 가중치 로드 밸런싱도 동일하다. 업스트림 클러스터에 슬로우 스타트가 활성화돼 있고 트래픽이 하나의 엔드포인트 A로 존과 존 사이에 라우팅되면 엔드포인트 A로의 트래픽은 점진적으로 증가하지 않을 것이다.

[api-clusters-cluster-configuration-round-robin-lb-config-slow-start-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-roundrobinlbconfig-slow-start-config
[api-clusters-cluster-configuration-leat-request-lb-config-slow-start-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-leastrequestlbconfig-slow-start-config
[api-clusters-cluster-configuration-slow-start-config-slow-start-window]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-slowstartconfig-slow-start-window
[api-clusters-cluster-configuration-slow-start-config-min-weight-percent]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-slowstartconfig-min-weight-percent
[api-clusters-cluster-configuration-slow-start-config-aggression]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-slowstartconfig-aggression
