# 2025-08-25

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 제외된 엔드포인트

특정 조건은 Envoy가 로드 밸런싱에서 엔드포인트를 *제외*하게 만들 수 있다. 호스트를 제외한다는 것은 적정 호스트의 비율과 총 호스트 수를 기반으로 가중치를 조절하는 어떤 로드 밸런싱 계산(우선순위 내리기, 지역성 가중치, 패닉 모드)에서든 Envoy가 분모에서 이 호스트를 제외한다는 것을 의미한다.

예를 들어, 두 우선순위 P0과 P1의 호스트에 대해, p0가 {헬시, 언헬시(제외됨), 언헬시(제외됨)됨}이고 P1이 {헬시, 헬시}이면 1 / (3 - 2) / 1 이므로 모든 트래픽은 여전히 P0로 향한다.

제외된 호스트는 주어진 클러스터에 대해 패닉 모드 진입이나 우선순위 하향을 유발하지 않고도 스케일 업 또는 다운을 허용한다.

패닉 모드가 발동되면 제외된 호스트는 여전히 트래픽을 받을 수 있다. 이 호스트들은 패닉 모드 활성화 여부를 결정하는 계산에는 관여하지 않는다.

현재, 능동적 헬스 체크를 사용중일 때 다음 두 조건이 호스트를 제외시킬 수 있다:

* [ignore_new_hosts_until_first_hc][api-clusters-cluster-configuration-common-lb-config-ignore-new-hosts-until-first-hc] 클러스터 옵션.
* 일반적으로 라우팅된 응답이나 [HTTP 능동적 헬스 체크][arch-upstream-clusters-health-checking-active-health-check-fast-failure]에 대한 응답에 [x-envoy-immediate-health-check-fail][config-http-http-filters-router-x-envoy-health-check-fail] 헤더를 수신.

[api-clusters-cluster-configuration-common-lb-config-ignore-new-hosts-until-first-hc]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-ignore-new-hosts-until-first-hc
[arch-upstream-clusters-health-checking-active-health-check-fast-failure]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking#arch-overview-health-checking-fast-failure
[config-http-http-filters-router-x-envoy-health-check-fail]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#config-http-filters-router-x-envoy-immediate-health-check-fail
