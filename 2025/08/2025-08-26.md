# 2025-08-26

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 원본 목적지

[원본 목적지 클러스터][arch-upstream-clusters-service-discovery-original-destination]하고만 쓰일 수 있는 특수한 목적의 로드밸런서다. 업스트림 호스트는 다운스트림 커넥션 메타데이터에 따라 선택된다. 즉, 커넥션이 Envoy로 리다이렉트되기 전의 인입 커넥션의 목적지 주소와 같은 주소로 커넥션이 열린다. 새 목적지는 로드 밸런서의 필요에 따라 클러스터에 추가되며 클러스터는 [주기적으로][api-clusters-cluster-configuration-cluster-cleanup-interval] 클러스터에서 쓰이지 않는 호스트를 정리한다. 원본 목적지 클러스터에는 다른 [로드 밸런싱 정책][api-clusters-cluster-configuration-cluster-lb-policy]을 사용할 수 없다.

###### 원본 목적지 호스트 요청 헤더

Envoy는 [x-envoy-original-dst-host][config-http-http-connection-manager-http-header-manipulation-x-envoy-original-dst-host]라 불리는 HTTP 헤더로부터 원본 목적지를 선택할 수도 있다. 이 헤더에는 완전히 리졸브된 IP 주소가 전달돼야 한다. 예를 들어, 요청이 포트가 888이고 IP 주소 10.195.16.237인 호스트로 라우트돼야 한다면 요청 헤더 값은 `10.195.16.237:8888`이 돼야 한다.

###### 원본 목적지 필터 상태

커스텀 확장은 필터 상태 객체 `envoy.network.transport_socket.origina_dst_address`를 사용해 목적지 주소를 오버라이드할 수 있다. 이 동작은 원본 목적지로 직접 향하는 대신 중간 프록시로 터널링하는 데 쓰인다.

[arch-upstream-clusters-service-discovery-original-destination]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/service_discovery#arch-overview-service-discovery-types-original-destination
[api-clusters-cluster-configuration-cluster-cleanup-interval]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-cleanup-interval
[api-clusters-cluster-configuration-cluster-lb-policy]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-lb-policy
[config-http-http-connection-manager-http-header-manipulation-x-envoy-original-dst-host]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-envoy-original-dst-host
