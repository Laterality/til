# 2025-08-20

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 우선순위 수준

로드밸런싱 중에 Envoy는 일반적으로 가장 높은 우선순위 수준에 구성된 호스트만을 고려한다. 각 EDS [LocalityLbEndpoints][api-extensions-endpoint-locality-lb-endpoints]에 대해 선택사항으로 우선순위가 지정될 수 있다. 최상위 우선순위 수준(P=0)의 엔드포인트가 헬시(healthy)면 모든 트래픽은 이 우선순위 수준의 엔드포인트로 간다. 최상위 우선순위 수준의 엔드포인트가 언헬시(unhealthy)가 되면 트래픽은 더 낮은 우선순위 수준으로 점점 이동한다.

시스템은 기본값이 1.4(이 문서에서는 이 값으로 가정)인 구성 가능한 [오버프로비저닝 지수(overprovisioning factor)][arch-upstream-clusters-load-balancing-overprovisioning-factor]와 함께 오버프러비저닝될 수 있다. 우선순위 수준의 엔드포인트의 80%가 헬시이면 80 * 1.4 > 100이므로 이 수준은 여전히 완전히 헬시한 것으로 간주된다. 따라서 레벨 0 엔드포인트는 ~71.4%가 헬시인 한 계속 트래픽을 받는다.

우선순위 수준 로직은 정수 헬스 점수로 동작한다. 수준의 헬스 점수는 최댓값이 100%인 (레벨에서 헬시 호스트의 퍼센트) *  (오버프로비저닝 지수)이다. P=0인 엔드포인트는 (레벨 0의 헬스 점수) 퍼센트의 트래픽을 받고 (P=1은 100% 헬시라고 가정하면)나머지는 P=1이 받는다. 에를 들어, 50%의 P=0인 엔드포인트가 헬시이면 50 * 1.4 = 70%의 트래픽을 받는다. 각 우선순위 수준이 받는 트래픽의 정수 퍼센트는 종합적으로 시스템의 "우선순위 부하"로 불린다. 추가 예시(두 개의 우선순위 수준, P=1은 100% 헬시): 

| P=0인 헬시 엔드포인트 | P=0으로의 트래픽 | P=1으로의 트래픽 |
| --------------------- | ---------------- | ---------------- |
| 100%                  | 100%             | 0%               |
| 72%                   | 100%             | 0%               |
| 71%                   | 99%              | 1%               |
| 50%                   | 70%              | 30%              |
| 25%                   | 35%              | 65%              |
| 0%                    | 0%               | 100%             |

> [!WARNING]
>
> 부하 분산 알고리즘과 정규화된 총 헬스 계산이 잘 동작하려면 각 우선순위 수준이 (100% * 오버프로비저닝 지수)만큼의 트래픽을 처리할 수 있어야 한다. Envoy는 100% 헬시한 P=1이 언헬시한 P=0을 대체할 수 있다고 가정한다. 만약 P=0에 10개의 호스트가 있는데 P=1에 2개의 호스트만 있다면 이 가정은 맞지 않을 것이다.

헬스 점수는 한 수준이 얼마나 오버프로비저닝됐는지와 얼마나 많은 엔드포인트가 현재 언헬시한지를 고려한 뒤 그 수준의 현재 트래픽 처리 능력을 나타낸다. 따라서 모든 수준의 헬스 점수 합이 < 100이면 Envoy는 트래픽을 완전히 처리할 헬시한 엔드포인트가 충분하지 않다고 판단한다. 이 합은 "정규화된 총 헬스"(normalized total health)라고 불린다. 정규화된 총 헬스가 100 아래로 떨어지면 트래픽은 그 수준의 헬스 점수를 100 이하로 정규화한 뒤 트래픽을 분배한다. 예를 들어 헬스가 {20, 30} (정규화된 총 헬스가 50)이면 정규화되고 우선순위 부하를 트래픽의 {40%, 60%}로 분산할 것이다.

| P=0인 헬시 엔드포인트 | P=1인 헬시 엔드포인트 | P=0으로의 트래픽 | P=1로의 트래픽 |
| --------------------- | --------------------- | ---------------- | -------------- |
| 100%                  | 100%                  | 100%             | 0%             |
| 72%                   | 72%                   | 100%             | 0%             |
| 71%                   | 71%                   | 99%              | 1%             |
| 50%                   | 50%                   | 70%              | 30%            |
| 25%                   | 100%                  | 35%              | 65%            |
| 25%                   | 25%                   | 50%              | 50%            |

더 많은 우선순위가 추가되면 각 수준의 헬스가 부하를 받지 않는 합계 100% 아래로 떨어지지 않은 한 자신의 정규화된 균등한 부하를 받는다. 

| P=0인 헬시 엔드포인트 | P=1인 헬시 엔드포인트 | P=2인 헬시 엔드포인트 | P=0으로의 트래픽 | P=1로의 트래픽 | P=2로의 트래픽 |
| --------------------- | --------------------- | --------------------- | ---------------- | -------------- | -------------- |
| 100%                  | 100%                  | 100%                  | 100%             | 0%             | 0%             |
| 72%                   | 72%                   | 100%                  | 100%             | 0%             | 0%             |
| 71%                   | 71%                   | 100%                  | 99%              | 1%             | 0%             |
| 50%                   | 50%                   | 100%                  | 70%              | 30%            | 0%             |
| 25%                   | 100%                  | 100%                  | 35%              | 65%            | 0%             |
| 25%                   | 25%                   | 100%                  | 35%              | 35%            | 30%            |
| 25%                   | 25%                   | 20%                   | 36%              | 36%            | 28%            |

이를 의사 알고리즘으로 정리하면:

```
health(P_X) = min(100, 1.4 * 100 * healthy_P_X_backends / total_P_X_backends)
normalized_total_health = min(100, Σ(health(P_0)...health(P_X)))
priority_load(P_0) = health(P_0) * 100 / normalized_total_health
priority_load(P_X) = min(100 - Σ(priority_load(P_0)..priority_load(P_X-1)),
                         health(P_X) * 100 / normalized_total_health)
```

참고: 이 섹션은 헬시 우선순위에 대해 다뤘지만 [퇴화 우선순위][arch-upstream-clusters-load-balancing-degraded-endpoints]도 확장한다.

[api-extensions-endpoint-locality-lb-endpoints]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-msg-config-endpoint-v3-localitylbendpoints
[arch-upstream-clusters-load-balancing-overprovisioning-factor]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overprovisioning#arch-overview-load-balancing-overprovisioning-factor
[arch-upstream-clusters-load-balancing-degraded-endpoints]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/degraded#arch-overview-load-balancing-degraded