# 2025-08-28

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드 밸런싱 - 로드 밸런서 서브셋

Envoy는 업스트림 클러스터 내의 호스트를 호스트에 붙은 메타데이터에 따라 서브셋으로 나눌 수 있다. 그 후 라우트는 호스트에 일치시킬 메타데이터를 명시해 로드 밸런서가 선택하도록 할 수 있다. 모든 호스트를 포함해 사전 정의된 호스트 집합을 폴백 옵션으로 사용할 수 있다.

서브셋은 클러스터가 지정한 로드 밸런서 정책을 사용한다. 원본 목적지 정책은 호스트가 사전에 알려지지 않기 때문에 서브셋과 함께 쓰이지 않을 수 있다. 서브셋은 존 인식 라우팅과 호환되지만 서브셋 사용은 최소 호스트 조건을 쉽게 위반할 수 있다는 점에 유의하라.

서브셋이 [구성됐][api-clusters-cluster-configuration-cluster-lb-subset-config]고 라우트가 존재하는 메타데이터 일치하는 메타데이터나 서브셋을 지정하지 않으면 서브셋 로드 밸런서는 폴백 정책을 개시한다. 기본 정책은 `NO_FALLBACK`으로 클러스터에 호스트가 없는 것처럼 요청이 실패한다. 반대로, `ANY_ENDPOINT` 폴백 정책은 호스트의 메타데이터에 관계없이 클러스터의 모든 호스트에 걸쳐 로드 밸런싱한다. 마지막으로 `DEFAULT_SUBSET`은 특정 메타데이터 집합에 일치하는 호스트들로 로드 밸런싱을 수행한다. 특정 서브셋 선택자에 대해 폴백 정책을 오버라이드할 수 있다.

서브셋 로드 밸런서가 효율적으로 올바른 호스트 서브셋을 선택할 수 있도록 하기 위해 서브셋은 미리 정의돼야 한다. 각 정의는 키의 집합으로, 0개 이상의 서브셋으로 변환된다. 개념적으로, 정의에 있는 모든 키에 대한 메타데이터 값을 가진 각 호스트는 자신의 키-값 쌍에 해당하는 특정 서브셋에 추가된다. 모든 키를 가진 호스트가 없으면 정의로부터 서브셋이 만들어지지 않는다. 여러 정의를 제공할 수 있고 여러 정의에 일치하는 경우 하나의 호스트가 여러 서브셋에 나타날 수 있다.

라우팅 도중, 라우트의 메타데이터 일치 구성을 사용해 특정 서브셋을 찾는다. 라우트가 지정한 키와 값이 정확히 일치하는 서브셋이 있으면 그 서브셋이 로드 밸런싱에 쓰인다. 그 외에는 폴백 정책이 쓰인다. 따라서 서브셋 로드 밸런싱이 발생하려면 클러스터의 서브셋 구성은 주어진 라우트와 같은 키들을 가진 정의를 가져야 한다.

서브셋은 각 서브셋에 하나의 호스트만으로 구성될 수 있다. 이는 쿠키에 따라 로드 밸런싱하면서 새 호스트가 클러스터에 추가됐을 때에도 같은 호스트를 선택해야 하는 경우처럼 [Maglev][arch-upstream-clusters-load-balancing-supported-load-balancers-maglev] 또는 [링 해시][arch-upstream-clusters-load-balancing-supported-load-balancers-ring-hash]와 비슷한 유스 케이스에 쓰일 수 있다. [single_host_per_subset][api-clusters-cluster-configuration-lb-subset-selector-singl-host-per-subset]이 활성화된 경우 엔드포인트 구성 변경은 CPU를 덜 사용할 수 있다.

호스트 메타데이터는 호트스가 [ClusterLoadAssignments][api-extensions-endpoint-cluster-load-assignment]를 사용해 정되된  의경우에만 지원된다. ClusterLoadAssignments는 EDS나 클러스터 [load_assignment][api-clusters-cluster-configuration-load-assignment] 필드를 통해 사용할 수 있다. 서브셋 로드 밸런싱을 위한 호스트 메타데이터는 필터 이름 `"envoy.lb"` 하위에 위치해야 한다. 비슷하게, 라우트 메타데이터 일치 조건은 `"envoy.lb"` 필터 이름을 사용한다. 호스트 메타데이터는 계층 구조일 수 있지만 서브셋 로드 밸런서는 최상위수준  키와 값만 비교하므로 구조화된 값을 사용중일 때 라우트의 일치 조건은 호스트의 메타데이터에 나타난 구조화된 값과 동일한 경우에만 일치한다.

마지막으로, 서브셋 로드 밸런싱은 [CLUSTER_PROVIDED][api-clusters-cluster-configuration-lb-policy-cluster-provided] 로드 밸런서 정책에는 사용할 수 없다.

[api-clusters-cluster-configuration-cluster-lb-subset-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-lb-subset-config
[arch-upstream-clusters-load-balancing-supported-load-balancers-maglev]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#arch-overview-load-balancing-types-maglev
[arch-upstream-clusters-load-balancing-supported-load-balancers-ring-hash]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#arch-overview-load-balancing-types-ring-hash
[api-clusters-cluster-configuration-lb-subset-selector-singl-host-per-subset]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-lbsubsetconfig-lbsubsetselector-single-host-per-subset
[api-extensions-endpoint-cluster-load-assignment]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint.proto#envoy-v3-api-msg-config-endpoint-v3-clusterloadassignment
[api-clusters-cluster-configuration-load-assignment]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-load-assignment
[api-clusters-cluster-configuration-lb-policy-cluster-provided]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-value-config-cluster-v3-cluster-lbpolicy-cluster-provided
