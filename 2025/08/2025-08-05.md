# 2025-08-05

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 커넥션 풀링

HTTP 트래픽에 대해서는 Envoy가 기반 통신 프로토콜(HTTP/1.1, HTTP/2, HTTP/3) 위에 계층화된 추상 커넥션 풀을 지원한다. 활용하는 필터 코드는 기반 프로토콜이 실제 멀티플렉싱을 지원하는지 신경쓸 필요 없다. 실제로 기반 구현체는 다음과 같은 상위 수준 속성들을 갖는다:

###### HTTP/1.1

HTTP/1.1 커넥션 풀은 업스트림에 필요할 때 (최대 서킷 브레이킹 제한까지)커넥션을 획득한다. 커넥션이 이전 요청 처리를 끝내거나 새 커넥션이 첫 요청을 수신할 준비가 되면 가용하게 되며 요청이 바운드된다. HTTP/1.1 커넥션 풀은 파이프라이닝을 사용하지 않으므로 업스트림 커넥션이 끊어지면 하나의 다운스트림 요청만 초기화해야 한다.

###### HTTP/2

HTTP/2 커넥션 풀은 [최대 동시 스트림][api-common-protocol-options-http-2-protocol-options-max-concurrent-streams]과 [커넥션 별 최대 요청][api-clusters-cluster-configuration-cluster-max-requests-per-connection]에 따라 하나의 커넥션으로 여러 요청들을 멀티플렉스한다. HTTP/2 커넥션 풀은 요청을 제공하는 데 필요한 만큼의 커넥션을 수립한다. 제한은 없으며 이는 오직 하나의 커넥션이 될 것이다. 만약 GOAWAY 프레임을 수신하거나 커넥션이 [커넥션 별 최대 요청][api-clusters-cluster-configuration-cluster-max-requests-per-connection] 제한에 도달하면 커넥션 풀은 영향을 받는 커넥션을 드레인(drain)한다. 커넥션이 [최대 동시 스트림 제한][api-common-protocol-options-http-2-protocol-options-max-concurrent-streams]에 도달하면 스트림을 사용할 수 있게 될 때까지 바쁜(busy) 것으로 표시한다. 전송할 수 있는 커넥션 없이 대기중인 요청이 있으면 언제든 (커넥션에 대한 서킷 브레이커 제한까지)새 커넥션이 수립된다. HTTP/2는 커넥션이 매우 드물게 끊어지기 때문에 Envoy가 리버스 프록시로 동작할 때 선호되는 통신 프로토콜이다.

###### HTTP/3

HTTP/3 커넥션 풀은 [최대 동시 스트림][api-common-protocol-options-quic-protocol-options-max-concurrent-streams]과 [커넥션 별 최대 요청][api-clusters-cluster-configuration-cluster-max-requests-per-connection]에 따라 하나의 커넥션으로 여러 요청들을 멀티플렉스한다. HTTP/3 커넥션 풀은 요청을 제공하는 데 필요한 만큼의 커넥션을 수립한다. 제한은 없으며 이는 오직 하나의 커넥션이 될 것이다. 만약 GOAWAY 프레임을 수신하거나 커넥션이 [커넥션 별 최대 요청][api-clusters-cluster-configuration-cluster-max-requests-per-connection] 제한에 도달하면 커넥션 풀은 영향을 받는 커넥션을 드레인(drain)한다. 커넥션이 [최대 동시 스트림 제한][api-common-protocol-options-quic-protocol-options-max-concurrent-streams]에 도달하면 스트림을 사용할 수 있게 될 때까지 바쁜(busy) 것으로 표시한다. 전송할 수 있는 커넥션 없이 대기중인 요청이 있으면 언제든 (커넥션에 대한 서킷 브레이커 제한까지)새 커넥션이 수립된다.

[api-common-protocol-options-http-2-protocol-options-max-concurrent-streams]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/protocol.proto#envoy-v3-api-field-config-core-v3-http2protocoloptions-max-concurrent-streams
[api-clusters-cluster-configuration-cluster-max-requests-per-connection]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-max-requests-per-connection
[api-common-protocol-options-quic-protocol-options-max-concurrent-streams]: 