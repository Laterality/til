# 2025-08-17

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 지원되는 로드 밸런서

###### 링 해시

링/모듈로 해시 로드 밸런서는 업스트림 호스트에 대한 일관된 해싱을 구현한다. 각 호스트는 주소를 해싱해 서클("링")에 매핑된다. 그 후 각 요청은 요청의 일부 프로퍼티를 해싱한 뒤 링에서 시계 방향으로 가장 가까운 호스트를 찾아 라우팅한다. 이 기법은 "[Ketama][ketama]"로도 널리 알려져 있으며 모든 해시 기반 로드 밸런서와 마찬가지로 해시할 값을 지정하는 프로토콜 라우팅이 사용되는 경우에만 효과가 있다. 호스트의 주소 외에 다른 것(Kubernetes StatfulSet의 시맨틱 이름)을 해시 키로 사용하고자 한다면 `"envoy.lb"` [LbEndpoint.Metadata][api-extensions-endpoint-lbendpoint-metadata]에 지정할 수 있다 e.g.:

```yaml
  filter_metadata:
    envoy.lb:
      hash_key: "YOUR HASH KEY"
```

이는 [use_hostname_for_hashing][api-clusters-cluster-configuration-common-lb-config-consistent-hashing-lb-config]을 오버라이드할 것이다.

각 호스트는 해시돼 가중치에 비례한 횟수만큼 링에 위치하게 된다. 예를 들어, 호스트 A가 가중치 1이고 호스트 B가 가중치 2라면, 링에는 호스트 A에 하나, 호스트 B에 두 개, 총 세 개의 엔트리가 있을 수 있다. 이는 실제로 서클을 2:1로 나누지 않지만 계산된 해시는 우연히 다른 것과 매우 가깝에 위치할 수 있기 때문에 호스트 별 해시의 수를 곱해야 한다. 예를 들어, 호스트 A를 위해 100개의 엔트리를, 호스트 B를 위해 200개의 엔트리를 삽입하는 것이다. 모법 사례는 [minimum_ring_size][api-clusters-cluster-configuration-ring-hash-lb-config-minimum-ring-size]와 [maximum_ring_size][api-clusters-cluster-configuration-ring-hash-lb-config-maximum-ring-size]를 명시적으로 설정하고 [min_hashes_per_host와 max_hashes_per_host 게이지][config-upstream-clusters-cluster-manager-statistics-ring-hash-lb]를 모니터링해 잘 분포되는지 확인하는 것이다. 링이 적절히 나눠지면 N개 호스트의 집합에서 하나의 호스트가 추가 또는 제거되는 것은 1/N개의 요청에만 영향을 미칠 것이다.

[ketama]: https://github.com/RJ/ketama
[api-extensions-endpoint-lbendpoint-metadata]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/endpoint/v3/endpoint_components.proto#envoy-v3-api-field-config-endpoint-v3-lbendpoint-metadata
[api-clusters-cluster-configuration-common-lb-config-consistent-hashing-lb-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-commonlbconfig-consistent-hashing-lb-config
[api-clusters-cluster-configuration-ring-hash-lb-config-minimum-ring-size]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-ringhashlbconfig-minimum-ring-size
[api-clusters-cluster-configuration-ring-hash-lb-config-maximum-ring-size]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-ringhashlbconfig-maximum-ring-size
[config-upstream-clusters-cluster-manager-statistics-ring-hash-lb]: https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#config-cluster-manager-cluster-stats-ring-hash-lb