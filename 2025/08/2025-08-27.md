# 2025-08-27

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 존 인식 라우팅

다음 용어를 사용한다:

* **원본(originating)/업스트림 클러스터**: Envoy는 요청을 원본 클러스터에서 업스트림 클러스터로 라우트한다.
* **지역 존**: 원본 및 업스트림 클러스터 양쪽의 호스트 서브셋을 포함하는 동일한 존.
* **존 인식 라우팅**: 최선을 다해 요청을 지역 존의 업스트림 클러스터 호스트로 라우팅하는 것.

원본과 업스트림 클러스터가 서로 다른 존에 속한 채 호스트가 배포되면 Envoy는 존 인식 라우팅을 수행한다. 존 인식 라우팅이 수행되기 위해서는 몇 가지 선행 조건이 있다:

* 원본과 업스트림 클러스터 모두 [패닉 모드][arch-upstream-clusters-load-balancing-panic-threshold]에 있지 않다.
* 존 인식 [라우팅이 활성화][config-upstream-clusters-cluster-manager-runtime-zone-routing]돼있다.
* 업스트림 클러스터가 충분한 호스트를 가지고 있다. 자세한 내용은 [이곳][config-upstream-clusters-cluster-manager-runtime-zone-routing]을 참고하라.

존 인식 라우팅의 목적은 가능한 많은 트래픽을 업스트림 클러스터의 지역 존으로 보내면서 모든 업스트림 호스트가 (로드 밸런싱 정책에 따라)거의 같은 수의 초당 요청 수를 유지하는 것이다.

업스트림 클러스터의 호스트가 거의 같은 초당 요청 수를 유지하는 한 Envoy는 가능한 많은 트래픽을 지역 업스트림 존으로 밀어넣으려고 한다. Envoy가 지역 존으로 라우트할지 존 간 라우팅을 수행할지는 지역 존의 원본 클러스터와 업스트림 클러스터의 헬시 호스트 비율에 달려있다. 원본 클러스터와 업스트림 클러스터 사이의 지역 존의 비율 관계에는 두 가지 경우가 있다:

* 원본 클러스터 지역 존 비율이 업스트림 클러스터보다 큰 경우. 이 경우 모든 업스트림 호스트 사이의 요청 불균형을 유발하므로 원본 클러스터 지역 존의 모든 요청을 업스트림 클러스터 지역 존으로 라우트할 수 없다. 그 대신 Envoy는 업스트림 클러스터의 지역 존으로 직접 라우트할 수 있는 요청 비율을 계산한다. 나머지 요청는 존 간 라우팅된다. 존의 잔여 용량에 따라 특정 존이 선택된다(해당 존은 일부 지역 존 트래픽과 Envoy가 존 간 트래픽에 사용할 수 있는 추가 용량을 가질 것이다).
* 원본 클러스터 지역 존 비율이 업스트림 클러스터보다 작은 경우. 이 경우 업스트림 클러스터 지역 존은 원본 클러스터 지역 존의 모든 요청을 받고 (필요한 경우)원본 클러스터의 다른 존의 트래픽도 허용하는 공간을 갖는다.

여러 우선순위를 사용중일 경우, 존 인식 라우팅은 현재 P=0에만 지원된다.

[arch-upstream-clusters-load-balancing-panic-threshold]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/panic_threshold#arch-overview-load-balancing-panic-threshold
[config-upstream-clusters-cluster-manager-runtime-zone-routing]: https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_runtime#config-cluster-manager-cluster-runtime-zone-routing
