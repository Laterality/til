# 2025-08-03

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 헬스 체크

###### 헬스 체크 신원

업스트림 호스트가 그저 특정 헬스 체크 URL에 응답한다는 것이 업스트림 호스트가 유효한다는 것을 의미하진 않는다. 예를 들어, 클라우드 자동 스케일링이나 컨테이너 환경에서 최종적으로 일관된 서비스 디스커버리를 사용중일 때는 호스트가 떠났다가 다른 유형의 같은 IP 주소로 복귀할 수도 있다. 이 문제에 대한 한 가지 해결책은 모든 서비스 유형이 다른 헬스 체크 URL을 갖는 것이다. 이 접근법의 단점은 모든 헬스 체크 URL을 완전히 커스터마이즈해야 하므로 전체 구성이 더 복잡해진다는 것이다.

Envoy HTTP 헬스 체커는 [service_name_match][api-clusters-health-check-http-health-check-service-name-matcher] 옵션을 지원한다. 이 옵션이 설정된 경우 헬스 체커는 추가로 `x-envoy-upstream-healthchecked-cluster` 응답 헤더를 `service_name`과 비교한다. 값이 일치하지 않으면 헬스 체크는 통과하지 않는다. 업스트림 헬스 체크 필터는 `x-envoy-upstream-healthchecked-cluster`를 응답 헤더로 추가한다. 추가된 값은 `--service-cluster` 커맨드 라인 옵션으로 결정된다.

[api-clusters-health-check-http-health-check-service-name-matcher]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/health_check.proto#envoy-v3-api-field-config-core-v3-healthcheck-httphealthcheck-service-name-matcher