# 2025-08-16

## Envoy

### 아키텍처 개요

#### 업스트림 클러스터

##### 로드밸런싱 - 지원되는 로드 밸런서

###### 가중치 최소 요청

최소 요청 로드 밸런서는 호스트의 가중치가 같은지 서로 다른지에 따라 다른 알고리즘을 사용한다.

* *모든 가중치가 같은 경우*: [구성][api-clusters-cluster-configuration-least-request-lb-config]에 명시된 N 개(기본값은 2개)의 무작위 가용 호스트를 선택하고 활성 요청이 가장 적은 호스트를 택한다([Mitzenmacher et al.][mitzenmacher-p2c]에서 이 접근방식이 거의 O(N) 풀 스캔만큼 충분함을 보여준다). 이는 P2C(power of two choices)로도 알려져 있다. P2C 로드 밸런서는 호스트의 활성 요청이 증가하면 해당 호스트의 가중치는 감소하는 특성을 가지고 있다. P2C 선택은 [떼로 몰려오는 동작][wikipedia-thundering-herd-problem](herding behavior)에 대한 내성이 있어 특히 로드 밸런서 구현에 유용하다.
* *모든 가중치가 같지 않은 경우*: 클러스터에서 둘 이상의 호스트가 다른 로드 밸런싱 가중치를 갖는 경우 로드 밸런서는 선택 시점에 호스트의 요청 부하에 따라 동적으로 가중치를 조절하는 가중치 라운드 로빈 스케줄을 사용하는 모드로 전환한다.

  이 경우 호스트가 선택된 시점에 다음 공식을 사용해 가중치를 계산한다:

  `weight = load_balancing_weight / (active_requests + 1)^active_request_bias`

  [active_request_bias][api-clusters-cluster-configuration-least-request-lb-config-active-request-bias]는 런타임에 구성할 수 있고 기본값은 1.0이다. 이 값은 0.0 이상이어야 한다.

  활성 요청 편향이 클 수록 활성 요청이 가중치에 더 많은 영향을 준다.

  `active_request_bias`가 0.0이면 최소 요청 로드 밸런서는 라운드 로빈 로드 밸런서처럼 동작하고 선택 시점의 활성 요청 수는 무시한다.

  예를 들어, active_request_bias가 1.0이면 가중치가 2이고 활성 요청 수가 4인 호스트는 2 / (4 + 1)^1 = 0.4의 가중치를 갖는다. 이 알고리즘은 상태가 일정한 경우에 균형을 잘 유지하지만 부하 불균형에 빠르게 적응하지 못할 수 있다. 추가로, P2C와는 달리 호스트는 실제로 드레인하지 않지만, 시간이 갈 수록 더 적은 요청을 받을 것이다.

[api-clusters-cluster-configuration-least-request-lb-config]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-msg-config-cluster-v3-cluster-leastrequestlbconfig
[mitzenmacher-p2c]: https://www.eecs.harvard.edu/~michaelm/postscripts/handbook2001.pdf
[wikipedia-thundering-herd-problem]: https://en.wikipedia.org/wiki/Thundering_herd_problem
[api-clusters-cluster-configuration-least-request-lb-config-active-request-bias]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-leastrequestlbconfig-active-request-bias
