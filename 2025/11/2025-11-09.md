# 2025-11-09

## Envoy

### 아키텍처 개요

#### 운영 및 구성

##### 드레인

몇몇 시나리오에서 Envoy는 우아하게 없애려고 시도한다. 예를 들어, 서버 종료 도중에는 기존 요청을 막고 리스너가 더이상 수락하지 않도록 설정돼 서버를 종료할 때 열려있는 커넥션의 수를 줄일 수 있다. 드레인 동작은 서버 옵션 외에도 개별 리스너 구성에 의해 정의된다.

드레인은 다음 시점에 발생한다:

* 서버가 [핫 리스타트][arch-operations-and-configuration-hot-restart]중일 때.
* 서버가 [drain_listeners?grace][operations-and-adinistration-administration-interface-drain-listeners] 어드민 엔드포인트를 통해 우아한 드레인 시퀀스를 시작할 때.
* 서버가 [healthcheck/fail][operations-and-adinistration-administration-interface-healthcheck-fail] 어드민 엔드포인트를 통해 수동 헬스 체크에 실패했을 때. 더 자세한 내용은 [헬스 체크 필터][arch-upstream-clusters-health-checking-http-health-checking-filter] 아키텍처 개요를 참고하라.
* [LDS][arch-operations-and-configuration-xds-configuration-api-overview-lds]를 통해 개별 리스너가 변형되거나 제거됐을 때.

기본적으로 Envoy 서버는 서버를 종료할 때 리스너를 즉시 닫는다. 서버 종료에 앞서 일정 기간동안 리스너를 드레인하려면 서버 종료 전에 [drain_listeners][operations-and-adinistration-administration-interface-drain-listeners]를 사용한다. 리스너들은 우아한 드레인 동작 없이 곧장 종료되며 새 커넥션 수락을 즉시 중단한다.

리스너를 닫기 전에 우아한 드레인 기간을 추가하려면 [drain_listeners?graceful][operations-and-adinistration-administration-interface-drain-listeners] 쿼리 파라미터를 사용한다. 기본적으로 Envoy는 (`--drain-time-s`에 의해 결정된)일정 기간 동안 요청을 막지만 드레인 타임아웃까지 계속해서 새 커넥션을 수락한다. 이 요청 거부 동작은 드레인 관리자에 의해 결정된다.

드레인은 리스너 별 동작이지만 네트워크 필터 수준에서 지원돼야 한다. 현재 우아한 드레인이 지원되는 유일한 필터는 [Redis][config-listeners-network-filters-redis-proxy], [Mongo][config-listeners-network-filters-mongo-proxy], (`envoy.reloadable_features.thrift_connection_draining` 런타임 기능이 활성화된 경우)[Thrift][config-listeners-network-filters-thrift-proxy]와 [HTTP 커넥션 관리자][config-http-http-connection-manager]다.

기본적으로 [HTTP 커넥션 관리자][config-http-http-connection-manager] 필터는 HTTP 1 요청들에 "Connection: close"를 추가하고 HTTP2 GOAWAY를 보내며 (지연 종료 주기 이후) 요청 완료시 커넥션을 종료한다.

각 [구성된 리스너][arch-listeners-listeners]는 언제 드레인이 일어날지 제어하는 [drain_type][api-listeners-listener-configuration-drain-type] 설정을 가지고 있다. 현재 지원되는 값들은 다음과 같다:

* **default**
  * Envoy는 위의 세 가지 경우(어드민 헬스 실패, 핫 리스타틑, LDS 갱신/제거) 모두에 대한 응답으로 리스너를 드레인한다. 이는 기본 설정이다.
* **modify_only**
  * Envoy는 위의 두 번째와 세 번째 경우(핫 리스타트와 LDS 갱신/제거)에 대한 응답으로만 리스너를 드레인한다. 이 설정은 Envoy가 인그레스와 이그레스 리스너를 둘 다 호스팅하고 있을 때 유용하다. 이그레스 리스너에만 *modify_only*로 설정해 갱신 중에만 드레인하도록 하고 인그레스 리스너 드레인에 의존해 제어된 종료를 시도할 때 전체 서버 드레인을 수행하는 것이 바람직할 수 있다.

[arch-operations-and-configuration-hot-restart]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/hot_restart#arch-overview-hot-restart
[operations-and-adinistration-administration-interface-drain-listeners]: https://www.envoyproxy.io/docs/envoy/latest/operations/admin#operations-admin-interface-drain
[operations-and-adinistration-administration-interface-healthcheck-fail]: https://www.envoyproxy.io/docs/envoy/latest/operations/admin#operations-admin-interface-healthcheck-fail
[arch-upstream-clusters-health-checking-http-health-checking-filter]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking#arch-overview-health-checking-filter
[arch-operations-and-configuration-xds-configuration-api-overview-lds]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/dynamic_configuration#arch-overview-dynamic-config-lds
[config-listeners-network-filters-redis-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/redis_proxy_filter#config-network-filters-redis-proxy
[config-listeners-network-filters-mongo-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/mongo_proxy_filter#config-network-filters-mongo-proxy
[config-listeners-network-filters-thrift-proxy]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/thrift_proxy_filter#config-network-filters-thrift-proxy
[config-http-http-connection-manager]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#config-http-conn-man
[arch-listeners-listeners]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listeners#arch-overview-listeners
[api-listeners-listener-configuration-drain-type]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-enum-config-listener-v3-listener-draintype
