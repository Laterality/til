# 2025-11-22

## Envoy

### 아키텍처 개요

#### 기타 기능

##### IP 투명성

###### 프록시 프로토콜

[HAAProxy 프록시 프로토콜][haproxy-proxy-protocol]은 TCP 스트림에 앞서 TCP를 통해 커넥션에 대한 메타데이터를 통신하기 위한 프로토콜을 정의한다. 이 메타데이터에는 소스 IP가 포함돼 있다. Envoy는 [프록시 프로토콜 필터][config-listeners-listener-filters-proxy-protocol]를 사용해 이 정보를 처리하는 것을 지원해 다운스트림 원격 주소를 [x-forwarded-for][config-http-http-connection-manager-http-header-manipulation-x-forwarded-for] 헤더로 전파하는 데 사용할 수도 있다. 또한 [Original Src Listener Filter][arch-other-features-ip-transparency-original-source-listener-filter]와 결합해 사용할 수도 있다. 마지막으로 Envoy는 [프록시 프로토콜 전송 소켓][api-extensions-transport-sockets-proxy-protocol-upstream-transport]을 사용해 이 헤더를 생성하는 것을 지원한다.

아래는 소켓을 셋업하는 구성 예시다:

```yaml
clusters:
- name: service1
  connect_timeout: 0.25s
  type: strict_dns
  lb_policy: round_robin
  transport_socket:
    name: envoy.transport_sockets.upstream_proxy_protocol
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.transport_sockets.proxy_protocol.v3.ProxyProtocolUpstreamTransport
      config:
        version: V1
      transport_socket:
        name: envoy.transport_sockets.raw_buffer
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer
  ...
```

이 소켓을 [HTTP 커넥션 관리자][config-http-http-connection-manager]와 결합해 사용할 계획이라면 고려해야 할 것들이 몇 가지 있다. 다운스트림 클라이언트 사이에 재사용하는 업스트림 커넥션이 없으므로 성능 영향이 있다. Envoy에 연결하는 모든 클라이언트는 업스트림 서버에 대한 새 커넥션을 얻는다. 이는 프록시 프로토콜이 커넥션 기반 프로토콜이기 때문이다. 다운스트림 클라이언트 정보는 커넥션이 시작되고 (TLS 해드셰이크가 발생하기 전에)데이터가 보내지기 전에 업스트림으로 포워드되기만 한다. 가능한 경우, Envoy는 이 방법으로 업스트림 커넥션을 재사용할 수 있을 것이므로 [x-forwarded-for][config-http-http-connection-manager-http-header-manipulation-x-forwarded-for] 헤더를 선호하는 것이 좋다. Envoy의 다운스트림과 업스트림 커넥션 처리 사이의 연결을 끊기 때문에 Envoy는 다운스트림 커넥션이 닫혔을 때 해당하는 업스트림 커넥션을 닫지 않으므로 업스트림 커넥션에 짧은 [유휴 타임아웃][faq-config-timeout]을 지정하는 것이 좋다.

프록시 프로토콜의 단점:

* TCP 프로토콜만 지원한다.
* 업스트림 호스트 지원이 필요하다.

[haproxy-proxy-protocol]: https://www.haproxy.org/download/1.9/doc/proxy-protocol.txt
[config-listeners-listener-filters-proxy-protocol]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/proxy_protocol#config-listener-filters-proxy-protocol
[config-http-http-connection-manager-http-header-manipulation-x-forwarded-for]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers-x-forwarded-for
[arch-other-features-ip-transparency-original-source-listener-filter]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/ip_transparency#arch-overview-ip-transparency-original-src-listener
[api-extensions-transport-sockets-proxy-protocol-upstream-transport]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/proxy_protocol/v3/upstream_proxy_protocol.proto#extension-envoy-transport-sockets-upstream-proxy-protocol
[config-http-http-connection-manager]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#config-http-conn-man
[faq-config-timeout]: https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/timeouts#faq-configuration-timeouts
