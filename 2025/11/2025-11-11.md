# 2025-11-11

## Envoy

### 아키텍처 개요

#### 운영 및 구성

##### 핫 재시작

운영 용이성은 Envoy의 주요 목표 중 하나이다. 강건한 통계와 로컬 관리 인터페이스 외에도 Envoy는 자체 "핫" 또는 "라이브" 재시작 기능을 제공한다. 즉, Envoy는 [드레인 과정][arch-operations-and-configuration-draining]에서 기존 커넥션을 버리지 않고도 (코드와 구성 모두) 자체적으로 완전히 리로드할 수 있다. 하지만 기존 커넥션은 새 Envoy 프로세스에 전달되지 않으므로 드레인 중에 완료하지 않으면 종료된다. 핫 재시작 기능은 다음과 같은 일반적인 아키텍처를 가지고 있다:

* 두 활성 프로세스가 기본적인 RPC 프로토콜을 사용하는 유닉스 도메인 소켓을 통해 서로 통신한다. 모든 카운터는 유닉스 도메인을 통해 기존 프로세스에서 새 프로세스로 보내지며 `NeverImport`로 표시된 것들을 제외한 게이지도 보내진다. 핫 재시작이 끝난 뒤, 기존 프로세스에서 보내진 게이지는 정리되지만 [server.hot_restart_generation_statistics][config-observability-statistics]와 같은 특수한 게이지는 유지된다.
* 기존 프로세스에 리스닝 소켓의 사본을 요청하기 전에 새 프로세스는 자체적으로 완전히 초기화(구성 로드, 초기 서비스 디스커버리 및 헬스 체크 단계 등)된다. 새 프로세스가 리스닝을 시작하고 기존 프로세스에 드레인 시작을 요청한다.
* 드레인 단계 동안 기존 프로세스는 기존 커넥션을 우아하게 닫으려고 시도한다. 방법은 구성된 필터에 따라 다르다. 드레인 시간은 `--drain-time-s` 옵션을 통해 구성할 수 있으며 시간이 지날수록 드레인은 더 공격적으로 이루어진다.
* 이후, 대체로 드레인 시퀀스 이후, 새 Envoy 프로세스는 이전 Envoy 프로세스에 종료하도록 요청한다. 이 시간은 `--parent-shutdown-time-s` 옵션으로 구성할 수 있다. `--parent-shutdown-time-s` 옵션은 `--drain-time-s` 값과 독립적이므로 부모의 종료 시간은 더 큰 값으로 설정돼야 한다.
* 기존 Envoy 프로세스에 남아있는 커넥션들이 닫힌다. 핫 재시작 기능은 기존 커넥션을 새 프로세스로 보내지 않는다.
* Envoy의 핫 재시작 지원은 새 Envoy 프로세스와 기존 Envoy 프로세스가 서로 다른 컨테이너에서 실행중일 때도 올바르게 동작하도록 설계됐다. 프로세스간의 통신은 유닉스 도메인 소켓만을 사용한다.
* Python으로 작성된 예시 재시작기/부모 프로세스는 [restarter/hot-restart.py][envoy-hot-restarter-py]의 소스 배포에 포함돼 있다. 이 부모 프로세스는 monit/runit 등과 같은 표준 프로세스 제어 유틸리티와 함께 사용할 수 있다.

Envoy의 기본 커맨드 라인 옵션은 주어진 호스트에 활성 Envoy 서버 하나와 잠재적으로 드레인 중인 Envoy 서버 프로세스로 구성된 하나의 Envoy 프로세스 집합만 실행중일 거라고 가정한다. `--base-id` 또는 `--use-dynamic-base-id` 옵션을 사용해 개별적으로 구분된 여러 Envoy를 같은 호스트에서 실행하고 독립적으로 핫 재시작할 수 있다.

> [!NOTE]
>
> 현재 핫 재시작 도중 리스너의 [socket_options][api-listeners-listener-configuration-listener-socket-options] 갱신은 지원되지 않다다. 기존 프로세스 소켓 옵션이 사용된다. 소켓 옵션을 갱신해야 한다면 완전히 재시작하거나 LDS 기반 리스너 갱신을 수행해야 한다.

> [!NOTE]
>
> 현재 이 기능은 Windows에서 지원되지 않는다.

###### 소켓 처리

기본적으로 Envoy는 Linux에서 더 나은 성능을 위해 [reuse_port][api-listeners-listener-configuration-listener-enable-resuse-port] 소켓을 사용한다. Envoy는 각 소켓을 워커 인덱스에 따라 새 프로세스로 전달하므로 이 기능은 핫 재시작 도중에 정상적으로 동작한다. 따라서 드레인중인 프로세스의 수락 큐의 커넥션들은 드랍되지 않는다.

> [!WARN]
> 
> 핫 재시작 도중에 동시성이 바뀌는 드분 사례에서는 동시성이 증가하는 경우에는 커넥션이 드랍되지 않는다. 하지만 동시성이 감소할 경우 기존 프로세스 워커의 수락 큐에서 일부 커넥션이 드랍될 수 있다.


[arch-operations-and-configuration-draining]: https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/draining#arch-overview-draining
[config-observability-statistics]: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/statistics#server-statistics
[envoy-hot-restarter-py]: https://github.com/envoyproxy/envoy/blob/ac08f4e04702c8151b3d39daf269d92e3198bdc6/restarter/hot-restarter.py
[api-listeners-listener-configuration-listener-socket-options]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-field-config-listener-v3-listener-socket-options
[api-listeners-listener-configuration-listener-enable-resuse-port]: https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener.proto#envoy-v3-api-field-config-listener-v3-listener-enable-reuse-port
