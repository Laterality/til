## 2020. 10. 31.

### Spring Security for Servlet - 인증(14)

#### JDBC 인증

Spring Security의 `JdbcDaoImpl`은 JDBC를 사용해 조회된 유저네임/패스워드 기반 인증을 제공하기 위해 [UserDetailsService][user-details-service]를 구현한다. `JdbcuserDetailsManager`는 `UserDetailsManager` 인터페이스를 통해 `UserDetails`의 관리를 제공하기 위해 `JdbcDaoImpl`을 확장한다. `UserDetails` 기반 인증은 Spring Security가 [유저네임/패스워드를 받아][username-password-authentication] 인증하도록 구성된 경우 사용한다.

이후 섹션에서는 다음 내용을 논의한다:

* Spring Security JDBC 인증에서 사용하는 [기본 스키마][jdbc-authentication-default-schema]
* [DataSource 설정][spring-security-jdbc-storage]
* [JdbcUserDetailsManager 빈][jdbc-user-details-manager-bean]

##### 기본 스키마

Spring Security는 JDBC 기반 인증을 위한 기본 쿼리를 제공한다. 이 섹션은 해당하는 기본 스키마와 기본 쿼리를 제공한다. 스키마가 커스터마이즈한 쿼리에 맞도록 조정하고 사용하는 데이터베이스 방언(dialect)도 확인해야 할 것이다.

###### 사용자 스키마

`JdbcDaoImpl`은 사용자의 패스워드, 계정 상태 및 권한(roles) 목록을 불러오기 위한 테이블을 필요로 한다. 필요한 기본 스키마는 다음과 같다.

> 기본 스키마는 클래스패스 리소스 `org/springframework/security/core/userdetails/jdbc/users.ddl`로도 노출돼 있다.

**예제 65. 기본 사용자 스키마**

```sql
create table users(
    username varchar_ignorecase(50) not null primary key,
    password varchar_ignorecase(500) not null,
    enabled boolean not null
);

create table authorities (
    username varchar_ignorecase(50) not null,
    authority varchar_ignorecase(50) not null,
    constraint fk_authorities_users foreign key(username) references users(username)
);
create unique index ix_auth_username on authorities (username,authority);
```

오라클(Oracle)은 인기 있는 데이터베이스지만, 약간 다른 스키마가 필요하다. Oracle의 기본 사용자 스키마는 다음과 같다.

**예제 66. 오라클 데이터베이스의 기본 사용자 스키마**

```sql
CREATE TABLE USERS (
    USERNAME NVARCHAR2(128) PRIMARY KEY,
    PASSWORD NVARCHAR2(128) NOT NULL,
    ENABLED CHAR(1) CHECK (ENABLED IN ('Y','N') ) NOT NULL
);


CREATE TABLE AUTHORITIES (
    USERNAME NVARCHAR2(128) NOT NULL,
    AUTHORITY NVARCHAR2(128) NOT NULL
);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_UNIQUE UNIQUE (USERNAME, AUTHORITY);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_FK1 FOREIGN KEY (USERNAME) REFERENCES USERS (USERNAME) ENABLE;
```

###### 그룹 스키마

애플리케이션이 그룹(groups)을 활용한다면, 그룹 스키마도 제공해야 할 것이다. 기본 그룹 스키마는 다음과 같다.

**예제 67. 기본 그룹 스키마**

```sql
create table groups (
    id bigint generated by default as identity(start with 0) primary key,
    group_name varchar_ignorecase(50) not null
);

create table group_authorities (
    group_id bigint not null,
    authority varchar(50) not null,
    constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

create table group_members (
    id bigint generated by default as identity(start with 0) primary key,
    username varchar(50) not null,
    group_id bigint not null,
    constraint fk_group_members_group foreign key(group_id) references groups(id)
);
```

##### DataSource 설정

`JdbcUserDetailsManager`를 구성하기 전에 `DataSource`를 생성해야 한다. 이 예제에서는 [기본 사용자 스키마][default-user-schema]로 초기화된 [임베디드 DataSource][embedded-datasource]를 설정할 것이다.

```kotlin
@Bean
fun dataSource(): DataSource {
    return EmbeddedDatabaseBuilder()
        .setType(H2)
        .addScript("classpath:org/springframework/security/core/userdetails/jdbc/users.ddl")
        .build()
}
```

프로덕션 환경에서는 외부 데이터베이스와 연결하도록 설정할 것이다.

##### JdbcUserDetailsManager 빈

이 샘플에서는 [Spring Boot CLI][spring-boot-cli]를 이용해 `password`의 패스워드를 인코드하여 인코드된 패스워드 `{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW`를 얻는다. 패스워드 저장 방법에 대한 자세한 내용은 [PasswordEncoder][password-encoder] 섹션 참조.

**예제 69. JdbcUserDetailsManager**

```kotlin
@Bean
fun users(dataSource: DataSource): UserDetailsManager {
    val user = User.builder()
            .username("user")
            .password("{bcrypt}$2a$10\$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
            .roles("USER")
            .build();
    val admin = User.builder()
            .username("admin")
            .password("{bcrypt}$2a$10\$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
            .roles("USER", "ADMIN")
            .build();
    val users = JdbcUserDetailsManager(dataSource)
    users.createUser(user)
    users.createUser(admin)
    return users
}
```



[user-details-service]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#servlet-authentication-userdetailsservice
[username-password-authentication]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#servlet-authentication-unpwd-input
[jdbc-authentication-default-schema]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#servlet-authentication-jdbc-schema
[spring-security-jdbc-storage]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#servlet-authentication-jdbc-datasource
[jdbc-user-details-manager-bean]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#servlet-authentication-jdbc-bean
[default-user-schema]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#servlet-authentication-jdbc-schema
[embedded-datasource]: https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/data-access.html#jdbc-embedded-database-support
[spring-boot-cli]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#authentication-password-storage-boot-cli
[password-encoder]: https://docs.spring.io/spring-security/site/docs/5.4.1/reference/html5/#authentication-password-storage