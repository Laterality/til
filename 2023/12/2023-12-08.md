# 2023. 12. 08.

## Elasticsearch(7.10)

### 집계 - 버킷 집계

#### Global 집계

검색 실행 컨텍스트 내의 모든 도큐먼트를 하나의 버킷으로 정의한다. 이 컨텍스트는 검색하는 인덱스와 도큐멈ㄴ트 유형에 의해 정의되지만 검색 쿼리 자체로부터는 영향을 받지 **않**는다.

> Global 집계를 다른 버킷 집계자 내에 삽입하는 것은 말이 되지 않기 때문에 Global 집계는 최상위 집계자로만 위치할 수 있다.

예시:

```http
POST /sales/_search?size=0
{
  "query": {
    "match": { "type": "t-shirt" }
  },
  "aggs": {
    "all_products": {
      "global": {}, // 1. `global` 집계자는 빈 본문을 갖는다.
      "aggs": {     // 2. `global` 집계에 등록된 하위 집계.
      "avg_price": { "avg": { "field": "price" } }
      }
    },
    "t_shirts": { "avg": { "field": "price" } }
  }
}
```

위 집계는 쿼리(예제에서는 "shirts" 뿐만 아니라 카탈로그의 모든 제품들에 대한 평균 가격을 계산한다)와 관계 없이 검색 컨텍스트 내의 모든 도큐먼트에 대한 집계(예제의 `avg_price`)를 계산하는 것을 보여준다. 

위 집계에 대한 응답:

```json
{
  ...
  "aggregations": {
    "all_products": {
      "doc_count": 7, // 1. 집계된 도큐먼트의 수(이 경우에는 검색 컨텍스트의 모든 도큐먼트)
      "avg_price": {
        "value": 140.71428571428572 // 2. 인덱스의 모든 제품의 평균 가격
      }
    },
    "t_shirts": {
      "value": 128.33333333333334 // 3. 모든 티셔츠의 평균 가격
    }
  }
}
```

