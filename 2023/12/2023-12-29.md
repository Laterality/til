# 2023. 12. 29.

## Elasticsearch(7.10)

### 집계 - 버킷 집계

#### Rare terms 집계

##### 정밀도

내부 CuckooFilter는 본질적으로 근사(approximate)하지만 `precision` 파라미터를 사용해 거짓 음성 비율을 제어할 수 있다. 결과의 정확도가 높아지는 대신 런타임 메모리 사용량이 증가한다.

기본 정확도는 `0.001`이고 가장 작은(가장 정확하고 메모리 오버헤드가 큰) 값은 `0.00001`이다. [차트](https://www.elastic.co/guide/en/elasticsearch/reference/7.10/search-aggregations-bucket-rare-terms-aggregation.html#_precision)는 집계의 정확도가 정밀도와 개별 텀의 수에 얼마나 영향을 받는지를 보여준다.

X축은 집계가 확인한 개별 값의 수, Y축은 오류율이다. 각 선은  하나의 "희귀성"(rarity) 조건(희귀한 항목의 수, 1개에서 100,000개 사이)이다. 예를 들어, 주황색 "10" 선은 1-20백만 개의 개별 값 중 10개가 "희귀"(`doc_count == 1`)함을 의미한다(값의 나머지는 `doc_count > 1`).

기본 정밀도 `0.001`은 테스트 조건에서 < 2.5%의 정확도를 유지했고, 정확도는 개별 값의 수가 선형으로 증가함에 따라 서서히 떨어졌다.

기본 정확도 `0.001`은 `n`이 집계가 확인한 개별 값의 수라고 할 때 `1.748^-6 * n` 바이트의 메모리 프로파일을 갖는다(대강 계산해보면 20백만 개의 고유한 값은 30mb의 메모리). 메모리 사용량은 정밀도와 무관하게 개별 텀의 수에 따라 선형으로 증가한다. 정밀도는 메모리 프로파일의 기울기에만 영향을 미친다.

비교를 위해, 20백만 개 버킷에서 동등한 텀 집계는 대략 `20m * 69b == ~1.38gb`가 된다(69바이트는 매우 낙관적으로 예상해 빈 버킷으로 봤을 때이다, 서킷 브레이커가 고려하는 것보다 훨씬 낮다). 따라서 `rare_terms` 집계가 상대적으로 무겁긴 하지만 동등한 텀 집계보다는 훨씬 작다.