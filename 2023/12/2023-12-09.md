# 2023. 12. 09.

## Elasticsearch(7.10)

### 집계 - 버킷 집계

#### Histogram 집계

숫자 값이나 도큐먼트에서 추출된 숫자 범위에 대해 적용될 수 있는 다중버킷 값 소스 기반 집계. 값들에 대해 고정된 크기(주기)의 버킷들을 동적으로 구축한다. 예를 들어, 도큐먼트가 가격(숫자) 필드를 가지고 있다면 이 집계가 `5`(여기서는 $5를 나타낸다)를 주기로 버킷을 구축하도록 구성할 수 있다. 집계를 실행하면 매 도큐먼트마다 가격 필드를 평가해 가장 가까운 버킷으로 내림한다. 예를 들어, 가격이 `32`이고 버킷 크기가 `5`라면 `30`으로 내림한다. 다음 함수가 사용된다:

```
bucket_key = Math.floor((value - offset) / interval) * interval + offset
```

범위 값에 대해 도큐먼트는 여러 버킷에 들어갈 수 있다. 첫 번째 버킷은 단일 값을 계산하는 것처럼 범위의 하한값에서 계산된다. 최종 버킷은 범위의 상한에서 계산되고 이 둘 사이에 있는 모든 버킷이 카운트된다.

`offset`은 `[0, interval)`(`0`보다 크거나 같고 `interval`보다 작아야 한다) 내의 10진수여야 하는 반면 `interval`은 양의 10진수여야 한다.

다음 스니펫은 제품을 `50` 주기로 `price`에 따라 "버킷화"한다:

```http
POST /sales/_search?size=0
{
  "aggs": {
    "prices": {
      "histogram": {
        "field": "price",
        "interval": 50
      }
    }
  }
}
```

응답:

```json
{
  ...
  "aggregations": {
    "prices": {
      "buckets": [
        {
          "key": 0.0,
          "doc_count": 1
        },
        {
          "key": 50.0,
          "doc_count": 1
        },
        {
          "key": 100.0,
          "doc_count": 0
        },
        {
          "key": 150.0,
          "doc_count": 2
        },
        {
          "key": 200.0,
          "doc_count": 3
        }
      ]
    }
  }
}
```

