# 2023. 02. 19.

## Elasticsearch(7.10)

### 데이터 검색 - 검색 결과 페이징

#### 검색 결과 스크롤

##### 검색 컨텍스트 유지하기

스크롤은 초기 검색 요청 시점에 일치하는 도큐먼트를 모두 반환한다. 그 이후에 도큐먼트에 대한 변경은 무시된다. `scroll_id`는 Elasticsearch가 올바른 도큐먼트를 반환하는 필요한 모든 것을 추적하는 *검색 컨텍스트*를 식별한다. 이 검색 컨텍스트는 최초 요청 시에 생성되고 이유 요청에서 유지된다.

(`search` 요청과 매 `scroll` 요청에 전달되는)`scroll` 파라미터는 Elasticsearch에게 검색 컨텍스트가 얼마나 오래 유지돼야 하는지 알린다. 이 값(e.g. `1m`, [시간 단위][common-options] 참고)은 모든 데이터를 처리할 만큼 충분할 필요는 없다. 이전 결과의 배치를 처리할 정도의 시간이면 충분하다. (`scroll` 파라미터가 있는)각 `scroll` 요청은 새 만료 시간을 설정한다. 만일 `scroll` 요청이 `scroll` 파라미터를 전달하기 않으면 검색 컨텍스트는 *해당*`scroll` 요청의 일부로 해제될 것이다.

일반적으로, 백그라운드 병합 프로세스는 작은 세그먼트들을 더 큰 새 세그먼트로 병합해 인덱스를 최적화한다. 더 작은 세그먼트가 더이상 필요치 않으면 제거된다. 이 프로세스는 스크롤 중에도 계속되지만 열려있는 컨텍스트는 오래된 세그먼트를 사용중이기 때문에 이들이 제거되는 것을 막는다.

> 오래된 세그먼트를 유지한다는 것은 더 많은 디스크 공간과 파일 핸들이 필요하다는 의미이다. 노드에 충분히 사용 가능한 파일 핸들이 있는지 확인하라. [파일 디스크립터][file-descriptor] 참고.

추가로, 세그먼트가 삭제되거나 갱신된 도큐먼트를 포함하고 있는 경우 검색 컨텍스트는 세그먼트의 각 도큐먼트가 최초 검색 요청 시점에 살아있었는지를 추적해야 한다. 갱신과 삭제가 발생하는 인덱스에 다수의 스크롤을 열 때는 노드에 충분한 힙 공간이 있는지 확인하라.

> 과도하게 많은 스크롤이 열려 문제가 발생하는 것을 막기 위해, 사용자가 열 수 있는 스크롤이 제한된다. 기본적으로, 열려 있는 스크롤의 최대 수는 500이다. 이 제한은 클러스터 설정 `search.max_scroll_context`로 변경할 수 있다.

[노드 상태 API][node-stats-api]로 열려 있는 검색 컨텍스트를 확인할 수 있다:

```http
GET /_nodes/stats/indices/search
```



[common-options]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/common-options.html#time-units
[file-descriptor]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/file-descriptors.html