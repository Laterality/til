## 2022. 02. 13.

#### Elasticsearch(7.10)

#### 인덱스 모듈 - 히스토리 유지

Elasticsearch는 때로 샤드에 수행된 연산을 재실행(replay)해야 하는 경우가 있다. 예를 들면, 레플리카가 잠시 오프라인이었다면 그 사이에 놓친 몇 개의 연산을 재실행하는 것이 처음부터 다시 구축하는 것보다 훨씬 효율적이다. 비슷하게, 클러스터 간 레플리케이션은 리더 클러스터에서 연산을 수행하고 팔로워 클러스터가 이를 재실행하는 방식으로 동작한다.

Lucene 수준에서 Elasticsearch가 인덱스에 수행하는 연산은 두 가지 뿐이다. 새 도큐먼트가 인덱스되거나 기존 도큐먼트가 삭제되는 것이다. 갱신은 이전 도큐먼트를 삭제하고 새 도큐먼트를 인덱싱하는 작업을 원자적으로(atomically) 수행하여 구현된다. 이미 Lucene에 인덱스된 도큐먼트는 인덱싱 연산을 재실행하는 데 필요한 모든 정보를 갖고 있지만, 도큐먼트 삭제의 경우에는 그렇지 않다. 이를 해결하기 위해, Elasticsearch는 *소프트 삭제(soft deletes)*라 불리는 기능을 사용해 Lucene 인덱스에서 최근에 삭제된 도큐먼트를 보존하여 재실행될 수 있도록 한다.

소프트 삭제된 도큐먼트는 여전히 공간을 차지하기 때문에 Elasticsearch는 인덱스에서 최근에 삭제된 특정 인덱스만 보존한다. 결과적으로 Elasticsearch는 인덱스가 시간이 갈수록 더 커지지 않도록 소프트 삭제된 도큐먼트를 제거하여 공간을 확보한다. 다행히도, Elasticsearch는 샤드에서 수행됐던 모든 연산을 재실행할 필요가 없다. 항상 원격 노드에 샤드의 완전 복제본을 만들 수 있기 때문이다. 하지만 샤드를 통째로 복제하는 것은 몇 개의 놓친 연산을 재실행하는 것보다 더 오래 걸린다. 때문에 Elasticsearch는 미래에 재실행돼야 할 것으로 기대하는 모든 연산을 유지하려고 시도한다.

Elasticsearch는 *샤드 히스토리 유지 임대(shard history retention leases)*라 불리는 메커니즘을 사용해 미래에 재실행돼야 할 것으로 기대하는 연산들을 계속 추적한다. 연산들이 재실행돼야 할 수도 있는 각 샤드 복제본은 먼저 샤드 히스토리 유지 임대 자체를 생성해야 한다. 예를 들어, 이 샤드 복제본은 샤드의 레플리카나 클러스터 간 레플리케이션을 사용중인 경우 팔로워 인덱스의 샤드가 될 수 있다. 각 유지 임대는 해당 샤드 복제본이 수신하지 않은 첫 번째 연산의 시퀀스 넘버를 계속 추적한다. 샤드 복제본이 새 연산을 수신하면 유지 임대에 포함된 시퀀스 넘버를 증가시켜 미래에 이 연산들은 재실행될 필요가 없음을 나타낸다. Elasticsearch는 소프트 삭제된 연산이 어떤 유지 임대에도 잡혀 있지 않으면 이를 제거한다.

샤드 복제본이 다운되면 복제본의 샤드 히스토리 유지 임대를 갱신하는 일을 멈춘다. 즉, Elasticsearch가 다운된 샤드가 복제본이 복구될 때 재실행될 수 있도록 모든 새로운 연산들을 보존할 것이다. 하지만 유지 임대는 제한된 시간 동안만 남는다. 샤드 복제본이 충분히 빠르게 복구되지 않으면 유지 임대는 만료될 수 있다. 유지 임대가 만료되면 Elasticsearch는 다시 히스토리 제거를 시작할 수 있기 때문에, 이는 샤드 복제본이 영구적으로 다운된 경우 Elasticsearch가 히스토리를 영원히 유지하는 것을 보호한다. 만일 샤드 복제본이 유지 임대가 만료된 뒤 복구되면 더이상 놓친 히스토리를 재실행할 수 없기 때문에 Elasticsearch는 차선책으로 인덱스를 통째로 복제한다. 유지 임대의 만료 시간은 기본적으로 `12h`로, 대부분의 복구 시나리오에서는 충분하다.

소프트 삭제는 최근 버전에서 생성된 인덱스들에는 기본적으로 활성화돼 있지만 인덱스 생성 시점에 명시적으로 활성화하거나 비활성화할 수 있다. 만일 소프트 삭제가 비활성화되면 [연산들이 유지되고 있는 한][translog-retention] 피어 복구는 여전히 translog에서 놓친 연산을 복사하는 것으로 대신할 수 있다. 소프트 삭제가 비활성화되면 클러스터 간 레플리케이션은 동작하지 않을 것이다.