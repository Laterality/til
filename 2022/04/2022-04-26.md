# 2022. 04. 26.

## Elasticsearch(7.10)

### 매핑 - 필드 데이터 타입

#### Percolator 필드 타입

##### 한계점

###### 부모/자식

`percolate` 쿼리는 한번에 하나의 도큐먼트만 처리하기 때문에 `has_child`와 `has_parent` 같은 자식 도큐먼트에 대해 실행되는 필터링 쿼리를 지원하지 않는다.

###### 인출(fetch) 쿼리

쿼리 파싱을 호출중에 데이터를 가져오는 몇 가지 쿼리가 있다. 예를 들면 텀 조회를 사용할 때의 `terms` 쿼리, 인덱스된 스크립트를 사용할 때의 `template` 쿼리, 미리 인덱스된 기하형을 사용할 때의 `geo_shape`가 그렇다. 이러한 쿼리들을 `percolator` 필드 타입으로 인덱스하면 get 호출은 한번만 실행된다. 따라서 `percolator` 쿼리가 이 쿼리들을 평가할 때마다 인덱스 시점의 텀 인출, 도형 등이 사용될 것이다. 알아둬야 할 것은 이 쿼리가 하는 텀 인출은 percolator 쿼리가 프라이머리 샤드와 레플리카 샤드에 인덱스될 때마다 발생하기 때문에, 만일 소스 인덱스가 인덱싱 중에 변경되면 실제로 인덱스된 텀은 샤드 복제본 간에 서로 다를 수 있다.

###### 스크립트 쿼리

`script` 쿼리 내의 스크립트는 doc value 필드에만 접근할 수 있다. `percolate` 쿼리는 전달된 도큐먼트를 인메모리 인덱스에 인덱스한다. 이 인메모리 인덱스는 저장된 필드를 지원하지 않고 `_source` 필드와 다른 저장된 필드는 저장되지 않는다. `script` 쿼리에서 `_source`와 다른 저장된 필드를 사용할 수 없는 것은 이 때문이다.

###### 필드 별칭

[필드 별칭][field-aliases]을 갖는 Percolator 쿼리는 항상 기대한 대로 동작하지 않을 수 있다. 특히 percolator 쿼리가 해당 필드 별칭을 등록한 경우, 이 별칭은 매핑에서 다른 필드를 참조하도록 갱신되는데 저장된 쿼리는 여전히 원본 대상 필드를 참조한다. 필드 별칭에 대한 변경을 뽑으려면 percolator 쿼리가 명시적으로 재인덱스돼야 한다.



[field-aliases]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/alias.html