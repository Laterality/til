# 2022. 12. 12.

## Elasticsearch(7.10)

### 처리(ingest) 노드 - 파이프라인에서 데이터 접근

파이프라인의 프로세서는 파이프라인을 통과하는 도큐먼트에 대한 읽기와 쓰기 접근을 갖는다. 프로세서는 도큐먼트의 소스의 필드와 도큐먼트의 메타데이터 필드에 접근할 수 있다.

#### 소스의 필드에 접근

소스의 필드에 접근하는 것은 직관적이다. 간단히 이름으로 필드를 참조하면 된다. 예를 들어:

```json
{
  "set": {
    "field": "my_field",
    "value": 582.1
  }
}
```

이를 이용해 소스의 필드는 항상 `_source` 접두어로 접근할 수 있다:

```json
{
  "set": {
    "field": "_source.my_field",
    "value": 582.1
  }
}
```

#### 메타데이터 필드에 접근

소스의 필드에 접근한 것과 같은 방법으로 메타데이터 필드에 접근할 수 있다. 이는 Elasticsearch가 소스의 필드가 메타데이터 필드와 같은 이름을 갖는 것을 허용하지 않기 때문에 가능하다.

프로세서는 다음 메타데이터 필드에 접근할 수 있다:

- `_index`
- `_type`
- `_id`
- `_routing`

다음 예제는 도큐먼트의 메타데이터 필드 `_id`에 `1`을 설정한다:

```json
{
  "set": {
    "field": "_id",
    "value": "1"
  }
}
```

메타데이터 필드의 값을 두 개의 중괄호 `"{{ }}"`로 감싸 필드의 값을 참조할 수 있다. 예를 들어, `{{_index}}`는 도큐먼트의 인덱스 이름을 조회한다.

> 도큐먼트 ID를 [자동으로 생성][generate-doc-id-automatically]한다면 처리 프로세서에서 `{{_id}}` 값을 사용할 수 없다. Elasticsearch는 처리를 마친 뒤 자동 생성된 `_id` 값을 할당한다.

#### 처리 메타데이터 필드에 접근

메타데이터와 소스 필드 외에, 처리 과정에서도 처리 메타데이터를 도큐먼트에 추가한다. 이 메타데이터 속성들은 `_ingest` 키 하위로 접근할 수 있다. 현재 처리 과정에서는 `_ingest.timestamp` 키에 처리 타임스탬프를 추가한다. 처리 타임스탬프는 Elasticsearch가 전처리할 도큐먼트의 인덱스나 벌크 요청을 수신한 시간이다.

모든 프로세서가 도큐먼트 처리 과정에서 처리와 관련된 메타데이터를 추가할 수 있다. 처리 메타데이터는 임시(transient)로 유지되며 도큐먼트가 파이프라인에서 처리되고 난 뒤에는 사라진다. 따라서 처리 메타데이터는 인덱스되지 않는다.

다음 예제는 `received`라는 이름의 필드를 추가한다. 값은 처리 타임스탬프다:

```json
{
  "set": {
    "field": "received",
    "value": "{{_ingest.timestamp}}"
  }
}
```

Elasticsearch 메타데이터 필드와 달리, 처리 메타데이터 필드 이름 `_ingest`는 도큐먼트의 소스에서 유요한 필드명으로 사용될 수 있다. 소스 도큐먼트의 필드를 참조하려면 `_source._ingest`를 사용하고, `_ingest`를 사용하면 메타데이터 필드로 해석될 것이다.

#### 템플릿의 필드와 메타필드에 접근

몇 개의 프로세서 설정은 템플릿을 지원한다. 템플릿을 지원하는 설정은 0개 이상의 템플릿 스니펫을 가질 수 있다. 템플릿 스니펫은 `{{`로 시작하며 `}}`로 끝난다. 템플릿의 필드와 메타필드에 접근하는 것은 보통의 프로세서 필드 설정에 접근하는 것과 완전히 동일하다.

다음 예제는 `field_c`라는 이름의 필드를 추가한다. 값은 `field_a`와 `field_b`를 이어붙인 값이다.

```json
{
  "set": {
    "field": "field_c",
    "value": "{{field_a}} {{field_b}}"
  }
}
```

다음 예제는 소스의 `geoip.country_iso_code` 필드를 사용해 도큐먼트가 인덱스될 인덱스를 설정한다:

```json
{
  "set": {
    "field": "_index",
    "value": "{{geoip.country_iso_code}}"
  }
}
```

동적 필드 이름 또한 지원된다. 이 예제는 `service`의 값을 이름으로 하는 필드에 `code` 필드의 값을 설정한다:

```json
{
  "set": {
    "field": "{{service}}",
    "value": "{{code}}"
  }
}
```





[generate-doc-id-automatically]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/docs-index_.html#create-document-ids-automatically