## 2022. 01. 13.

#### Elasticsearch(7.10)

#### 인덱스 모듈 - 인덱스 샤드 할당

##### 노드가 떠날 때 할당 지연(1)

어떤 이유로든 노드가 클러스터를 떠나면, 마스터는 다음과 같이 반응한다:

* 해당 노드의 프라이머리 샤드를 대체하기 위해 레플리카 샤드를 프라이머리로 승격시킨다.
* (충분한 노드가 있다고 가정하면)사라진 레플리카를 대체하기 위해 레플리카 샤드를 할당한다.
* 남은 노드 사이에서 샤드를 리밸런싱한다.

이 동작은 모든 샤드가 가능한 완전하게 복제(replicated)되도록 함으로써 클러스터를 데이터 손실에서 보호하기 위함이다.

만일 사라진 노드가 곧 복귀할 가능성이 있는 경우에는 필요하지 않은 이 "샤드 셔플(shard-shuffle)"이 [노드 수준][recovery]과 [클러스터 수준][shard-alloc] 모두에서 동시 회복을 제한(throttle)하더라도 여전히 클러스터에 큰 부하를 줄 수 있다. 다음과 같은 시나리오를 상상해보자:

* 노드 5의 네트워크 연결이 끊어졌다.
* 마스터는 노드 5에 있던 각 프라이머리 샤드에 대한 레플리카 샤드를 프라이머리 샤드로 승격시킨다.
* 마스터는 클러스터의 다른 노드에 새 레플리카를 할당한다.
* 각각의 새 레플리카는 네트워크를 통해 프라이머리 샤드를 복제한다.
* 클러스터를 리밸런스하기 위해 더 많은 샤드를 다른 노드로 이동한다.
* 몇분 뒤 노드 5가 복귀한다.
* 마스터는 노드 5에 샤드를 할당해 클러스터를 리밸런스한다.

마스터가 몇 분만 더 기다렸다면 사라진 샤드는 최소한의 네트워크 트래픽으로 노드 5에 재할당될 수 있었다. 심지어 자동으로 [sync-flush][indices-sync-flushed-api]되는 유휴 샤드(인덱싱 요청을 받지 않는 샤드)에 대해서는 이 프로세스가 더 빠르다.

노드가 떠나면서 배정되지 않은(unassigned) 레플리카 샤드에 대한 할당은 다이내믹 설정 `index.unassinged.node_left.delayed.timeout` 만큼 지연될 수 있다. 기본값은 `1m`이다.

이 설정은 라이브 인덱스(혹은 모든 인덱스들)에 대해 업데이트할 수 있다:

```http
PUT _all/_settings
{
  "settings": {
    "index.unassigned.node_left.delayed_timeout": "5m"
  }
}
```

지연 할당이 활성화되면 위의 시나리오는 아래처럼 바뀔 것이다:

* 노드 5의 네트워크 연결이 끊어졌다.
* 마스터는 노드 5에 있던 각 프라이머리 샤드에 대한 레플리카 샤드를 프라이머리 샤드로 승격시킨다.
* 마스터는 배정되지 않은 샤드에 대한 할당이 지연되고, 얼마나 지연되는지 로그로 남긴다.
* 배정되지 않은 레플리카 샤드가 있으므로 클러스터는 옐로우 상태로 남아있는다.
* `timeout`이 만료되기 전에 노드 5가 복귀한다.
* 손실된 레플리카는 노드 5로 재할당된다(sync-flush된 샤드는 거의 즉시 회복한다).

> 이 설정은 레플리카를 프라머리로 승격시키는 일에는 영향을 주지 않으며, 이전에 배정된 적 없는 레플리카들에 대한 배정에도 영향을 미치지 않는다. 특히 지연된 할당은 전체 클러스터 재시작에는 효과가 없다. 또한 마스터 페일오버 상황에서는 경과된 지연 시간이 잊혀진다(i.e. 완전 초기 지연으로 리셋한다).



[recovery]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/recovery.html
[shard-alloc]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/shards-allocation.html
[indices-sync-flushed-api]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/indices-synced-flush-api.html