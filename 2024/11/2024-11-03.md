# 2024. 11. 03.

## OpenID Connect Core 1.0

### 5. 클레임

#### 5.6. 클레임 유형

##### 5.6.2. 집계된 클레임

집계된 클레임과 분산된 클레임은 클레임을 갖는 `JSON` 객체의 `_claim_names`와 `_claim_sources`를 사용해 표현된다.

* _claim_names

  멤버 이름이 집계된 클레임과 분산된 클레임의 이름인 JSON 객체. 멤버 값은 실제로 클레임 값을 조회할 수 있는 `_cliam_sources` 멤버의 멤버 이름을 참조한다.  OP는 참조된 클레임 제공자에게서 사용할 수 있는 클레임 일부를 클레임 이름 집합에서 **생략할 수 있다**.

* _claim_sources

  멤버가 `_claim_names` 멤버의 값에 의해 참조되는 JSON 객체. 멤버 값은 집계된 클레임 또는 분산된 클레임의 참조 위치의 집합을 갖는다. 멤버 값은 집계된 클레임이나 분산된 클레임을 제공하는지에 따라 다음 형식 중 하나를 가질 수 있다:

  * 클레임:

    * 집계된 클레임

      해당하는 `_claim_sources` 멤버를 참조하는 `_claim_names` 객체의 모든 클레임을 **가져야 하는** [JWT][rfc-7519]가 값이 되는 `JWT` 멤버를 **가져야 하는** JSON 객체. 사용된 멤버중 이해할 수 없는 것은 **무시해야 한다**.

      * JWT

        **필수**. 클레임 값들을 가진 JWT

      JWT는 자신의 값이 (OpenID 제공자의 또다른 당사자가 아닌)클레임 제공자에서 최종 사용자의 식별자가 아닌 한 `sub`(subject) 클레임을 **갖지 않는 것이 좋다**. 이는 대체로 `sub` 클레임이 **제공되지 않는 것이 좋음**을 의미한다.

    * 분산된 클레임

      다음 멤버와 값을 갖는 JSON 객체:

      * endpoint

        **필수**. 연관된 클레임을 조회할 수 있는 OAuth 2.0 리소스 엔드포인트. 엔드포인트는 JWT를 클레임으로 **반환해야 한다**.

      * access_token

        **선택사항**. [OAuth 2.0 Bearer Token Usage][rfc-6750] 프로토콜을 사용해 엔드포인트 URL에서 클레임을 조회할 수 있게 하는 액세스 토큰. 클레임은 인가 요청 헤더 필드를 사용해 **요청되는 것이 좋으**며 클레임 제공자는 이 방식을 **지원해야 한다**. 액세스 토큰을 사용할 수 없는 경우, RP는 다른 방식으로 액세스 토큰을 조회하거나 클레임 제공자와 RP 사이에 사전 협의된 액세스 토큰을 사용해야 할 **수도 있다**. 혹은 클레임 제공자가 최종 사용자를 재인증 및/또는 RP를 재인가를 **수행할 수 있다**.

      요청된 클레임을 반환하지 않는 것은 오류 조건이 아니므로, RP는 `_claim_sources`에 나열된 클레임 일부가 클레임 제공자로부터 반환되지 않는 상황을 처리할 준비를 해야 한다. 다른 요청된 클레임이 반환되지 않았을 때와 동일하게 **취급하는 것이 좋다**. `sub`(subject) 클레임은 그 값이 (OpenID 제공자 또는 다른 당사자에 대한)클레임 제공자에서의 최종 사용자에 대한 식별자가 아닌 한 클레임 제공자로부터 **반환되지 않는 것이 좋다**. 이는 대체로 `sub` 클레임이 **제공되지 않는 것이 좋음**을 의미한다.

 JWT의 유효성 검증을 위한 키를 조회할 수 있도록 `iss`(issuer) 클레임은 클레임 제공자가 발급한 모든 JWT에 **포함되는 것이 좋다**. 클레임의 값은 클레임 제공자의 발급자 식별자 URL이다.

일반적으로, 언제 집계된 클레임과 분산된 클레임을 사용하는 것이 적절한지는 OP에게 달려있다. 일부 사례에서 어떤 클레임 유형을 언제 사용할지가 별개의 방법(out of band)으로 RP와 OP 사이에서 협의되기도 한다.



[rfc-7519]: https://www.rfc-editor.org/rfc/rfc7519.html
[rfc-6750]: https://www.rfc-editor.org/rfc/rfc6750.html