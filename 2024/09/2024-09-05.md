# 2024. 09. 05.

## OpenID Connect Core 1.0

### 3. 인증

#### 3.1. 인가 코드 흐름을 사용한 인증

##### 3.1.3. 토큰 엔드포인트

###### 3.1.3.7. ID Token 유효성 검증

클라이언트는 다음과 같이 토큰 응답의 ID Token을 **검증해야 한다**:

1. ID Token이 암호화돼 있는 경우 클라이언트를 등록할 때 OP가 ID Token을 암호화하는 데 사용하도록 지정한 키와 알고리즘을 사용해 복호화한다. 암호화가 등록 시점에 OP와 협상됐고 ID Token이 암호화되지 않은 경우 RP는 이를 **거부하는 것이 좋다**.
2. (주로 디스커버리 중에 얻은)OpenID 제공자의 발급자 식별자가 `iss`(issuer) 클레임과 **정확히 일치한다**.
3. 클라이언트는 `aud`(audience) 클레임이 `iss`(issuer) 클레임이 수신자(audience)로 식별되는 발급자에 등록된 자신의 `client_id` 값을 갖고 있는지 **검증해야 한다**.
4. 구현체가 `azp`(authorized party) 클레임이 존재하는 (이 명세의 범위를 벗어난)확장을 사용중인 경우, `azp` 값이 확장에 의해 지정된 값인지 **검증하는 것이 좋다**.
5. 이 유효성 검증에 `azp`(authorized party) 클레임이 존재하는 경우가 **포함될 수 있는 경우**, 클라이언트는 자신의 `client_id`가 클레임 값인지 **검증하는 것이 좋다**.
6. ID Token이 (이 흐름에 없는)클라이언트와 토큰 엔드포인트 사이의 직접 통신으로 수신된 경우, 토큰 서명 검사 대신 TLS 서버 유효성 검증을 사용해 발급자 유효성을 **검증할 수 있다**. 클라이언트는 [JWS][rfc-7515]에 따라 JWT `alg` 헤더 파라미터에 명시된 알고리즘을 사용해 다른 모든 ID Token의 서명 유효성을 **검증해야 한다**.
7. `alg` 기본값은 `RS256`이나 클라이언트가 등록할 때 `id_token_signed_response_alg` 파라미터에 보낸 알고리즘을 **사용하는 것이 좋다**.
8. JWT `alg` 헤더 파라미터가 `HS256`, `HS384`, `HS512`와 같은 MAC 기반 알고리즘을 사용하는 경우 `aud`(audience)에 포함된 `client_id`에 대응하는 `client_secret`의 [UTF-8][rfc-3629] 표현의 옥텟을 서명 유효성 검증의 키로 사용한다.
9. 현재 시간은 `exp` 클레임이 나타내는 시간보다 **이전이어야 한다**.
10. 공격을 방어하기 위해 저장해야 하는 넌스(nonce)인 시간 양을 제한하면 `iat` 클레임을 사용해 현재 시간보다 과도하게 이전에 발급된 토큰을 거부할 수 있다. 수용 가능한 범위는 클라이언트가 정한다.
11. 인증 요청에 넌스 값이 보내진 경우, `nonce` 클레임이 **존재해야 하**며 값을 검사해 인증 요청에 보내진 것과 같은 값인지 **검증해야 한다**. 클라이언트는 재시도(replay) 공격을 위해 `nonce` 값을 **검사하는 것이 좋다**. 재시도 공격을 탐지하는 정확한 수단은 클라이언트가 정한다.
12. `acr` 클레임이 요청된 경우, 클라이언트는 결정(asserted)된 클레임 값이 적절한지 **검사하는 것이 좋다**. `acr` 클레임 값의 의미와 처리는 이 명세의 범위를 벗어난다.
13. 이 클레임에 대한 특정 요청이나 `max_age` 파라미터 중 하나를 통해 `auth_time` 클레임이 요청된 경우, 클라이언트는 `auth_time` 클레임 값을 검사해 마지막 최종 사용자 인증으로부터 너무 오랜 시간이 지난 경우 재인증을 **요청하는 것이 좋다**.



[rfc-7515]: https://www.rfc-editor.org/rfc/rfc7515.html
[rfc-3629]: https://www.rfc-editor.org/rfc/rfc3629.html