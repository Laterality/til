# 2024. 01. 23.

## Elasticsearch(7.10)

### 집계 - 버킷 집계

#### Terms 집계

##### 최소 도큐먼트 수

`min_doc_count` 옵션을 사용해 히트 수가 지정된 수보다 많은 일치 항목만 반환할 수도 있다:

```http
GET /_search
{
  "aggs": {
    "tags": {
      "terms": {
        "field": "tags",
        "min_doc_count": 10
      }
    }
  }
}
```

위 집계는 히트 수가 10 이상인 태그만 반환한다. 기본값은 `1`이다.

텀은 샤드 수준에서 수집되고 정렬되며 두 번째 단계에서 다른 샤드로부터 수집된 텀들과 병합된다. 하지만 샤드는 전역 도큐먼트 수에 대한 정보에 접근할 수 없다. 텀을 후보 목록에 추가할지를 결정하는 것은 로컬 샤드 빈도에서 계산된 순서 뿐이다. `min_doc_count` 조건은 모든 샤드의 로컬 텀 통계를 병합한 다음에만 적용된다. 텀을 후보로 추가할지 결정하는 일은 텀이 실제로 필요한 `min_doc_count`에 도달할지에 대한 확신 없이 이루어진다. 이는 저빈도 텀들이 후보 목록에 오르면 다수의 (전역) 고빈도 텀이 최종 결과에서 누락되게 할 수 있다. 이를 피하려면 `shard_size` 파라미터를 증가시켜 샤드에 더 많은 후보 을 허용할 수 있다. 하지만 이는 메모리 소비와 네트워크 트래픽을 증가시킨다.

###### `shard_min_doc_count`

`shard_min_doc_count` 파라미터는 `min_doc_count`를 존중해 텀이 실제로 후보 목록에 오를지 여부에 대해 샤드가 가진 확신(*certainty*)을 규정한다. 집합의 로컬 샤드 빈도가 `shard_min_doc_count`보다 높은 경우에만 텀을 고려한다. (예를 들면 오타처럼)사전이 많은 저빈도 텀을 가지고 있고 이들에 관심이 없다면 `shard_min_doc_count` 파라미터를 설정해 로컬 카운트를 병합한 뒤에도 필요한 `min_doc_count`에 도달하지 않을 거라는 합리적인 확신이 들도록 샤드 수준에서 후보 텀을 걸러내게 할 수 있다. `shard_min_doc_count`는 기본적으로 `0`으로 설정돼 있어 명시적으로 설정하지 않으면 효과가 없다.

> `min_doc_count`=`0`로 설정하는 것은 아무것도 히트하지 않은 버킷도 반환한다. 하지만 도큐먼트 수가 0인 반환된 텀 중 일부는 삭제된 도큐먼트나 다른 타입의 도큐먼트일 수도 있으므로 `match_all` 쿼리가 이러한 텀들에 긍정적인 도큐먼트를 찾는다는 보장은 없다.

> `doc_count`로 내림차순 정렬하지 않을 때는 샤드에서 충분한 데이터가 수집되지 않아 `min_doc_count`를 높은 값으로 설정하면 `size`보다 적은 수의 버킷을 반환할 수 있다. 누락된 버킷은 `shard_size` 설정을 증가시켜 되돌릴 수 있다. `shard_min_doc_count`를 너무 높게 설정하면 텀이 샤드 수준에서 걸러지게 만들 것이다. 이 값은 `min_doc_count/#shards`보다 훨씬 낮아야 한다.