# 2024. 01. 09.

## Elasticsearch(7.10)

### 집계 - 버킷 집계

#### Significant terms 집계

##### 제한 사항

###### 중요 텀은 인덱스된 값이어야 한다

terms 집계와 달리 스크립트로 생성된 텀은 카운팅 목적으로 사용할 수 없다. significant_terms 집계가 *전경*과 *배경* 빈도 둘 다를 고려해야 하는 방식으로 인해 비교를 위한 배경 빈도를 얻기 위해 전체 인덱스에 스크립트를 사용하는 것은 엄청나게 비싸기 때문이다. 또한 DocValues는 비슷한 이유로 텀 데이터의 소스로 지원되지 않는다.

###### 부동소수점 필드에 대한 분석 불가

부동소수점 필드는 현재 significant_terms의 대상으로 지원되지 않는다. 은행 계좌 번호나 카테고리 번호 등을 나타내는 데 쓰여 추적할 만한 가치가 있는  정수(integer, long) 필드와 달리 부동소수점 필드는 주로 무언가의 수량을 나타내는 데 쓰인다. 따라서 개별 부동소수점 텀은 이러한 빈도 분석 형식에 유용하지 않다.

###### 부모 집계로 사용

동등한 `match_all` 쿼리나 인덱스의 서브셋을 제공하는 쿼리 술어(criteria)가 없는 경우 significant_terms는 가장 최상위 집계로 사용될 수 없다. 이 시나리오에서는 *전경* 집합이 *배경* 집합과 정확히 같기 때문에 관측되는 도큐먼트 빈도에 차이가 없어 제대로 된 제안을 할 수 없다.

또다른 고려사항은 significant_terms 집계는 샤드 수준에서 모든 샤드의 모든 통계가 병합되면 노드 축소시 사라질(pruned) 많은 후보 결과를 만들어낸다는 점이다. 결과적으로 많은 후보 텀을 나중에 제거하는 거대한 자식 집계들을 significant_terms 하위에 두는 것은 비효율적이고 RAM 비용이 많이 든다. 이러한 경우 두 번의 검색으로 해결할 수 있다. 먼저 합리적인 significant_term 목록을 만든 다음 이를 두 번째 쿼리에 넣어 필요한 자식 집계를 수행하는 것이다.

###### 카운트 근사(approximate)

결과에 포함된 도큐먼트의 카운트는 각 샤드에서 반환된 샘플의 합이며 다음과 같다:

- 특정 샤드가 상위 샘플에서 주어진 텀에 대한 결과를 전달하지 않은 경우 낮다.
- 배경 빈도를 고려할 때 는 삭제된 도큐먼트를 카운트할 수도 있으므로 높다.

대부분의 설계 결정처럼 이는 빠른 성능 관점에서 (대체로 작은) 비용과 부정확성 사이에 트레이드오프로 선택된 것이다. 하지만 `size`와 `shard size` 설정이 정확도 수준을 제어하는 데 도움이 된다.