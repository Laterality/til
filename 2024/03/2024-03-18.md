# 2024. 03. 18.

## Elasticsearch(7.10)

### 집계 - 지표 집계

#### Percentiles 집계

집계되는 도큐먼트로부터 추출된 숫자 값들에 대한 하나 이상의 백분위를 계산하는 `multi-value` 지표 집계. 이 값들은 지정한 스크립트에서 생성하거나 도큐먼트의 특정 숫자 혹은 [히스토그램 필드][field-histogram]로부터 추출할 수 있다.

백분위는 관측된 값들이 나타나는 특정 퍼센티지 지점을 보여준다. 예를 들어, 95th 백분위는 관측된 값들의 95% 이상보다 큰 값이다.

백분위는 주로 아웃라이어를 찾는 데 쓰인다. 표준 분포에서는 0.13th과 99.83th 백분위가 평균으로부터 세 표준 편차를 나타낸다. 세 표준 편차 바깥의 데이터는 주로 이상(anomaly)으로 간주된다.

백분위 범위가 조회되면 데이터 분포를 평가하고 데이터가 왜곡되거나 바이모달(bimodal)인지 등을 결정하는 데 사용할 수 있다.

데이터가 웹사이트 로드 시간으로 구성돼 있다고 하자. 평균과 중간 로드 시간은 관리자에게 크게 유용하지 않다. 최대 시간은 흥미로울지도 모르지만 느린 요청 하나 때문에 왜곡되기 쉽다. 

로드 시간을 나타내는 백분위 범위를 보자:

```http
GET latency/_search
{
  "size": 0,
  "aggs": {
    "load_time_outlier": {
      "percentiles": {
        "field": "load_time" // 1. `load_time` 필드는 숫자 필드여야 한다
      }
    }
  }
}
```

기본적으로 `percentile` 지표는 백분위 범위(`[1, 5, 25, 50, 75, 95, 99]`)를 생성한다. 응답은 다음과 같은 형태다:

```json
{
  ...

 "aggregations": {
    "load_time_outlier": {
      "values": {
        "1.0": 5.0,
        "5.0": 25.0,
        "25.0": 165.0,
        "50.0": 445.0,
        "75.0": 725.0,
        "95.0": 945.0,
        "99.0": 985.0
      }
    }
  }
}
```

보이듯, 이 집계는 기본 범위에서 각 백분위에 대해 계산된 값을 반환한다. 응답 시간이 밀리초 단위라고 하면 이 웹페이지는 일반적으로 10~725ms 내에 로드되지만 가끔 945-985ms까지 튀어오르기도 한다.

보통, 관리자들은 아웃라이어, 즉 극단 백분위에 관심을 갖는다. 관심 있는 퍼센트만 지정할 수 있다(요청하는 백분위는 0 이상 100 이하의 값이어야 한다):

```http
GET latency/_search
{
  "size": 0,
  "aggs": {
    "load_time_outlier": {
      "percentiles": {
        "field": "load_time",
        "percents": [ 95, 99, 99.9 ] // 1. `percents` 파라미터를 사용해 계산할 특정 백분위를 지정한다
      }
    }
  }
}
```



[field-histogram]: https://www.elastic.co/guide/en/elasticsearch/reference/7.10/histogram.html