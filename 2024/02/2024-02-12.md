# 2024. 02. 12.

## Elasticsearch(7.10)

### 집계 - 지표 집계

#### Cardinality 집계

##### 카운트는 근사치다

정확한 개수를 세려면 값을 해시 집합에 로드한뒤 그 크기를 반환해야 한다. 이는 메모리 사용량과 노드 간 샤드별 집합의 통신에는 너무 많은 클러스터 리소스가 필요하기 때문에 카디널리티가 높은 집합이나 값으로 확장할 수 없다.

이 `cardinality` 집계는 [HyperLogLog++][hyperloglogpp]알고리즘을 기반으로 해 몇몇 흥미로은 속성을 가진 값의 해시들에 따라 개수를 센다:

* 구성 가능한 정밀도, 메모리를 정확도와 교환하는 정도를 결정한다.
* 카디널리티가 낮은 집합에는 정확도가 높다.
* 고정된 메모리 사용량: 유니크한 값이 수십개는 수십업 개든 메모리 사용량은 구성된 정밀도에만 영향을 받는다.

정밀도 임계치가 `c`면, 사용되는 구현은 약 `c * 8` 바이트를 필요로 한다.

실질적으로 정확도는 질의하는 데이터셋에 달려있다. 일반적으로 대부분의 데이터셋은 일관되게 좋은 정확도를 보인다. 참고로 임계치가 100정도로 낮고 수백만 개의 항목을 세더라도 오차는 메우 낮다(1~6%).

HyperLogLog++ 알고리즘은 해시된 값의 앞에 붙은 0에 의존해 데이터셋에서 해시의 정확한 분포는 카디널리티의  정확성에 영향을 줄 수 있다.



[hyperloglogpp]: https://static.googleusercontent.com/media/research.google.com/fr//pubs/archive/40671.pdf